<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ - Ø§Ù„Ø¹Ø´Ø±Ø© (151)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      direction: rtl;
    }

    th.sortable {
      cursor: pointer;
      white-space: nowrap;
    }

    .sort-arrow {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-right: 4px;
    }

    header {
      background: #222;
      color: #fff;
      padding: 16px 24px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      max-width: 980px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    .field {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button.primary {
      background: #2563eb;
      color: #fff;
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.danger {
      background: #b91c1c;
      color: #fff;
    }

    button.danger:hover {
      background: #991b1b;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:active:not(:disabled) {
      transform: scale(0.97);
    }

    .small-text {
      font-size: 0.8rem;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f1f5f9;
      font-weight: 700;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-box {
      border-radius: 8px;
      background: #f9fafb;
      padding: 8px;
      font-size: 0.8rem;
      text-align: center;
    }

    .stat-box strong {
      display: block;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
    }

    .admin-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .admin-bar-text {
      font-size: 0.8rem;
    }

    .player-cell {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .player-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    /* Bonus button highlight when available */
    #bonusBtn.bonus-ready{
      background: #f59e0b;
      color: #111;
    }
    #bonusBtn:disabled{
      opacity: 0.5;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 0.8rem;
        padding: 6px 4px;
      }
    }
  
    /* ===== UI Settings: Dark Mode ===== */
    body.dark {
      background: #0b1220;
      color: #e5e7eb;
    }
    body.dark header { background:#0f172a; }
    body.dark .card { background:#0b1a33; box-shadow:none; border:1px solid rgba(255,255,255,0.08); }
    body.dark .small-text { color:#cbd5e1; }
    body.dark input[type="text"],
    body.dark input[type="date"],
    body.dark select {
      background:#0f172a;
      color:#e5e7eb;
      border:1px solid rgba(255,255,255,0.15);
    }
    body.dark table { color:#e5e7eb; }
    body.dark th { background:#122042; border-bottom:1px solid rgba(255,255,255,0.08); }
    body.dark td { border-bottom:1px solid rgba(255,255,255,0.06); }
    body.dark tr:nth-child(even) td { background:#0e1b35; }
    body.dark .stat-box { background:#0f172a; }
    body.dark button.primary { background:#3b82f6; }
    body.dark button.primary:hover { background:#2563eb; }
    body.dark button.danger { background:#ef4444; }
    body.dark button.danger:hover { background:#dc2626; }

    .settings-bar{
      margin-top:10px;
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
      flex-wrap:wrap;
    }
    .settings-bar select, .settings-bar button{
      font-size:0.85rem;
      padding:6px 10px;
    }

  </style>

  <!-- Firebase (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø§Ù„Ø²ÙˆØ¬ÙŠ - Ø§Ù„Ø¹Ø´Ø±Ø© (151)</h1>
    <div class="small-text">
      ÙƒÙ„ Ù…Ø§ØªØ´ (Ø¹Ø´Ø±Ø©) = Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† +1 Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨ / Ø§Ù„Ø®Ø³Ø±Ø§Ù† -1 Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
    </div>
  
    <div class="settings-bar">
      <button class="primary" id="themeToggleBtn" type="button">ğŸŒ™ Dark Mode</button>

      <label class="small-text" for="langSelect" style="margin:0;">
        Language:
      </label>
      <select id="langSelect">
        <option value="ar">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</option>
        <option value="en">English</option>
      </select>
    </div>

  </header>

  <main>
    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <section class="card">
      <h2>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
      <div class="row">
        <div class="field">
          <label for="playerName">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
          <input type="text" id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ØŒ Ø¹Ù„ÙŠØŒ Ø­Ø³Ø§Ù…..." />
        </div>
        <div class="field">
          <label for="playerAvatarFile">ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="file" id="playerAvatarFile" accept="image/*" />
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addPlayerBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
        </div>
      </div>

      <!-- Ø²Ø± Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
      <div class="row" style="margin-bottom:4px;">
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="togglePlayersListBtn">ğŸ‘¥ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</button>
        </div>
      </div>

      <!-- ØºÙ„Ø§Ù Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§) -->
      <div id="playersListWrapper" style="display:none;">
        <div class="small-text" id="playersListInfo"></div>

        <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
              <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
            </tr>
          </thead>
          <tbody id="playersTableBody"></tbody>
        </table>
        <div class="small-text">
          ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ùˆ ØªØ¶ÙŠÙ/ØªØºÙŠÙ‘Ø± ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·).
        </div>
      </div>
    </section>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø§ØªØ´ -->
    <section class="card">
      <h2>ğŸ§® ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø§ØªØ´ (Ø¹Ø´Ø±Ø© ÙƒØ§Ù…Ù„Ø©)</h2>
      <div class="row">
        <div class="field">
          <label for="matchDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø§ØªØ´</label>
          <input type="date" id="matchDate" />
          <span class="small-text">Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø¶ÙŠØŒ Ù‡ÙŠØªØ³Ø¬Ù„ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</span>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="winnerP1"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="winnerP2"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù† - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="loserP1"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù† - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="loserP2"></select>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addMatchBtn">âœ… Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø§ØªØ´</button>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="bonusBtn" disabled>ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)</button>
        </div>
      </div>
      <div class="small-text">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø§ ÙŠÙ†ÙØ¹Ø´ ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø§ØªØ´.
      </div>
    </section>

    <!-- Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <section class="card">
      <h2>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <div class="row">
        <div class="field">
          <label for="filterYear">Ø§Ù„Ø³Ù†Ø©</label>
          <select id="filterYear">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
          </select>
        </div>
        <div class="field">
          <label for="filterMonth">Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="filterMonth">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
            <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
            <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
            <option value="3">Ù…Ø§Ø±Ø³</option>
            <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
            <option value="5">Ù…Ø§ÙŠÙˆ</option>
            <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
            <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
            <option value="8">Ø£ØºØ³Ø·Ø³</option>
            <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
            <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
            <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
            <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
          </select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button id="leaderboardToggleViewBtn">ğŸ“Š Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ</button>
        </div>
      </div>

      <div class="small-text" id="currentFilterLabel"></div>

      <table id="leaderboardTable">
        <thead id="leaderboardHead"></thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </section>


    <!-- Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ -->
    <section class="card" id="championsLogCard">
      <h2>ğŸ… Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ø´Ù‡Ø±ÙŠ)</h2>
      <div class="small-text" id="championsLogHint">
        Ø§Ø®ØªØ± Ø³Ù†Ø© Ù…Ø­Ø¯Ø¯Ø© Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø£Ø¨Ø·Ø§Ù„ Ø§Ù„Ø´Ù‡ÙˆØ± (Ù…Ø«Ù„ Ø³Ø¬Ù„ Ø§Ù„Ø¯ÙˆØ±ÙŠ Ø§Ù„Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠ).
      </div>

      <div id="championsLogWrapper" style="display:none;">
        <div class="small-text" id="championsLogTitle" style="margin-bottom:8px;"></div>
        <table id="championsLogTable">
          <thead id="championsLogHead"></thead>
          <tbody id="championsLogBody"></tbody>
        </table>

        <div id="championsLogExtra" class="small-text" style="margin-top:10px; line-height:1.9;"></div>
      </div>
    </section>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª -->
    <section class="card">
      <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª (ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª)</h2>

      <div class="row" style="margin-bottom:4px;">
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="toggleMatchesLogBtn">ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>

      <div id="matchesLogWrapper" style="display:none;">
        <div class="small-text">
          Ø£Ø­Ø¯Ø« Ù…Ø§ØªØ´ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ù…Ø§ØªØ´ ØºÙ„Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù†</th>
              <th>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù†</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="matchesLogBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ -->
    <section class="card">
      <h2>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ù†ÙØ±Ø¯</h2>
      <div class="row">
        <div class="field">
          <label for="playerDetailsSelect">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨</label>
          <select id="playerDetailsSelect"></select>
        </div>
      </div>
      <div id="playerDetailsSummary" class="small-text">
        Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„Ù‡.
      </div>

      <div id="playerDetailsStats" style="margin-top:10px; display:none;">
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pTotalWins">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pTotalLosses">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pTotalMatches">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pWinRate">0%</strong>
            Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pBonusPlus">0</strong>
            Ø¨ÙˆÙ†Øµ + (Ù…ÙƒØ³Ø¨)
          </div>
          <div class="stat-box">
            <strong id="pBonusMinus">0</strong>
            Ø¨ÙˆÙ†Øµ âˆ’ (Ø®Ø³Ø§Ø±Ø©)
          </div>
          <div class="stat-box">
            <strong id="pBonusNet">0</strong>
            ØµØ§ÙÙŠ Ø§Ù„Ø¨ÙˆÙ†Øµ
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">ğŸ“† ØªØ­Ù„ÙŠÙ„ Ø£ÙŠØ§Ù… Ø§Ù„ÙÙˆØ² ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pDaysWin2">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ Ù…Ø±ØªÙŠÙ†
          </div>
          <div class="stat-box">
            <strong id="pDaysWin3">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ 3 Ù…Ø±Ø§Øª
          </div>
          <div class="stat-box">
            <strong id="pDaysWin4plus">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ 4 Ù…Ø±Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±
          </div>
          <div class="stat-box">
            <strong id="pDaysLose2">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ Ù…Ø±ØªÙŠÙ†
          </div>
          <div class="stat-box">
            <strong id="pDaysLose3">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ 3 Ù…Ø±Ø§Øª
          </div>
          <div class="stat-box">
            <strong id="pDaysLose4plus">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ 4 Ù…Ø±Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">ğŸ¤ Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…ÙØ¶Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pBestMateWinName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ ÙƒØ³Ø¨Øª Ù…Ø¹Ø§Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestMateWinCount">0</span>
            </div>
          </div>
          <div class="stat-box">
            <strong id="pBestMateLoseName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ Ø®Ø³Ø±Ù‘Øª Ù…Ø¹Ø§Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestMateLoseCount">0</span>
            </div>
          </div>
        </div>
        <h3 style="font-size:0.95rem; margin-top:14px;">ğŸ‘Š Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…ÙØ¶Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pBestOppWinName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ ÙƒØ³Ø¨Øª Ø¶Ø¯Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestOppWinCount">0</span>
            </div>
          </div>
          <div class="stat-box">
            <strong id="pBestOppLoseName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ Ø®Ø³Ø±Øª Ø¶Ø¯Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestOppLoseCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© -->
    <section class="card">
      <h2>âš”ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
      <div class="row">
        <div class="field">
          <label for="h2hP1">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</label>
          <select id="h2hP1"></select>
        </div>
        <div class="field">
          <label for="h2hP2">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
          <select id="h2hP2"></select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="h2hAnalyzeBtn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©</button>
        </div>
      </div>
      <div id="h2hSummary" class="small-text">
        Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".
      </div>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† ÙØ±Ù‚ 2 Ø¶Ø¯ 2 -->
    <section class="card">
      <h2>ğŸ§© ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† ÙØ±Ù‚ (2 Ø¶Ø¯ 2)</h2>

      <div class="row">
        <div class="field">
          <label for="h2hT1P1">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="h2hT1P1"></select>
        </div>
        <div class="field">
          <label for="h2hT1P2">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø£ÙˆÙ„ - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="h2hT1P2"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="h2hT2P1">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="h2hT2P1"></select>
        </div>
        <div class="field">
          <label for="h2hT2P2">Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø«Ø§Ù†ÙŠ - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="h2hT2P2"></select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="h2hTeamsAnalyzeBtn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©</button>
        </div>
      </div>

      <div id="h2hTeamsSummary" class="small-text">
        Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".
      </div>
    </section>

    <!-- Ù‚Ø³Ù… Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø© -->
    <section class="card">
      <h2>ğŸ” ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± ÙˆØ§Ù„Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h2>

      <div class="admin-bar">
        <button class="primary" id="enableAdminBtn">ğŸ”‘ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="danger" id="disableAdminBtn" style="display:none;">ğŸšª Ù‚ÙÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <div id="adminStatusText" class="admin-bar-text">
          ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.
        </div>
      </div>

      <hr style="margin:12px 0; border:none; border-top:1px solid #eee;">

      <h3 class="small-text" style="margin-bottom:8px;">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·)</h3>
      <div class="row">
        <div class="field" style="flex:0 0 auto;">
          <button class="danger" id="resetAllBtn">ğŸ§¨ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="backupBtn" disabled>ğŸ’¾ Ù†Ø³Ø® Ø§Ø­ØªÙŠØ§Ø·ÙŠ (Ù‚Ø±ÙŠØ¨Ù‹Ø§)</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="importBtn" disabled>ğŸ“¥ Ø§Ø³ØªÙŠØ±Ø§Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø±ÙŠØ¨Ù‹Ø§)</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="exportBtn" disabled>ğŸ“¤ ØªØµØ¯ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù‚Ø±ÙŠØ¨Ù‹Ø§)</button>
        </div>
      </div>

      <div class="small-text">
        Ø²Ø± <strong>Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</strong> ÙŠÙ…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¨Ø­Ø°Ø± Ø´Ø¯ÙŠØ¯).<br>
        Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø§Ø­ØªÙŠØ§Ø·ÙŠ ÙˆØ§Ù„Ø§Ø³ØªÙŠØ±Ø§Ø¯ ÙˆØ§Ù„ØªØµØ¯ÙŠØ± <strong>ØºÙŠØ± Ù…ÙØ¹Ù‘Ù„Ø© Ø­Ø§Ù„ÙŠÙ‹Ø§</strong>ØŒ ÙˆÙ‡Ù†ÙØ¹Ù‘Ù„Ù‡Ø§ Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø¶Ø¨Ø· Ù…Ù†Ø·Ù‚ Ø­ÙØ¸/Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.
      </div>
    </section>

    <section class="card">
      <h2>â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h2>
      <ul class="small-text">
        <li>Ù…Ù† ØºÙŠØ± ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.</li>
        <li>ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙŠ Firebase FirestoreØŒ ØªÙ‚Ø¯Ø± ØªÙØªØ­ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².</li>
        <li>Ø§Ø³ØªØ®Ø¯Ù… ÙÙ„ØªØ± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙØªØ±Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„ØªÙ€Ø±ØªÙŠØ¨ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª.</li>
      </ul>
    </section>
  </main>

  <script>
    const ADMIN_PIN = "1510"; // ØºÙŠØ±Ù‡ Ù„Ùˆ Ø­Ø§Ø¨Ø¨

    let isAdmin = false;
    let matchesLogVisible = false;  // Ù‚Ù„Ù†Ø§ Ù†Ø®Ù„ÙŠÙ‡ Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    let playersListVisible = false; // Ø¬Ø¯ÙŠØ¯: Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù…Ø®ÙÙŠØ© Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§
    let db = null;

    let state = {
      players: [], // {id, name, avatar}
      matches: []  // {id, date, winners, losers, createdAt}
    };


// ===== UI Settings: Theme + Language =====
const I18N = {
  ar: {
    appTitle: "Domino League",
    darkMode: "ğŸŒ™ Dark Mode",
    lightMode: "â˜€ï¸ Light Mode",
    languageLabel: "Ø§Ù„Ù„ØºØ©:",
    championsLog: "Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„",
    noCompletedMonths: "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ± Ù…ÙƒØªÙ…Ù„Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©.",
    lastYearChampion: "ğŸ† Ø­Ø§Ù…Ù„ Ù„Ù‚Ø¨ Ø¢Ø®Ø± Ø³Ù†Ø©",
    lastMonthChampion: "ğŸ… Ø­Ø§Ù…Ù„ Ù„Ù‚Ø¨ Ø¢Ø®Ø± Ø´Ù‡Ø±"
  },
  en: {
    appTitle: "Domino League",
    darkMode: "ğŸŒ™ Dark Mode",
    lightMode: "â˜€ï¸ Light Mode",
    languageLabel: "Language:",
    championsLog: "Champions Log",
    noCompletedMonths: "No completed months in the selected period.",
    lastYearChampion: "ğŸ† Last Year Champion",
    lastMonthChampion: "ğŸ… Last Month Champion"
  }
};

function getLang() {
  return localStorage.getItem("dl_lang") || "ar";
}
function setLang(lang) {
  localStorage.setItem("dl_lang", lang);
  applyLang(lang);
  // Re-render dynamic sections that include text
  if (typeof reloadAllDataAndRender === "function") {
    // In your code this might be heavy; we just re-render visible sections
    try { renderAll(); } catch(e) {}
    try { updateChampionsLog(); } catch(e) {}
  } else {
    try { updateChampionsLog(); } catch(e) {}
  }
}

function tr(key) {
  const lang = getLang();
  return (I18N[lang] && I18N[lang][key]) || (I18N.ar[key] || key);
}

function applyLang(lang) {
  const html = document.documentElement;
  html.lang = lang;
  html.dir = (lang === "ar") ? "rtl" : "ltr";

  // Static UI
  const titleEl = document.querySelector("header h1");
  if (titleEl) titleEl.textContent = tr("appTitle");

  const langLabel = document.querySelector('label[for="langSelect"]');
  if (langLabel) langLabel.textContent = tr("languageLabel");

  // If your Champions section has headings by id, update them too (safe if absent)
  const championsTitle = document.getElementById("championsTitle");
  if (championsTitle) championsTitle.textContent = tr("championsLog");
}

function getTheme() {
  return localStorage.getItem("dl_theme") || "light";
}
function applyTheme(theme) {
  document.body.classList.toggle("dark", theme === "dark");
  const btn = document.getElementById("themeToggleBtn");
  if (btn) btn.textContent = (theme === "dark") ? tr("lightMode") : tr("darkMode");
}
function toggleTheme() {
  const next = (getTheme() === "dark") ? "light" : "dark";
  localStorage.setItem("dl_theme", next);
  applyTheme(next);
}


    // ===== BONUS (Streak Bonus) =====
    // ÙŠØ¸Ù‡Ø± Ø²Ø± Ø§Ù„Ø¨ÙˆÙ†Øµ ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ Ø§Ø­ØªÙ…Ø§Ù„ "Ø³ØªØ±ÙŠÙƒ":
    // Ø¢Ø®Ø± Ù…Ø§ØªØ´ Ù…Ø³Ø¬Ù„ ÙƒØ§Ù† Ø¨Ù†ÙØ³ Ø§Ù„Ø£Ø±Ø¨Ø¹ Ù„Ø§Ø¹Ø¨ÙŠÙ† + Ù†ÙØ³ ØªÙ‚Ø³ÙŠÙ…Ø© Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† + Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ ÙØ§Ø².
    let bonusEligible = false;
    let bonusApplied  = false;
    let bonusValue    = 0;
    let bonusSuggested = 0;

    function normTeam(arr){
      return (arr || []).slice().sort();
    }
    function teamsEqual(a,b){
      if(a.length !== b.length) return false;
      for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
      return true;
    }

    function getLatestMatch(){
      if(!state.matches || state.matches.length===0) return null;
      const sorted = [...state.matches].sort((a,b)=>{
        const ta = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
        const tb = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
        if(tb !== ta) return tb - ta;
        return (b.date || "").localeCompare(a.date || "");
      });
      return sorted[0] || null;
    }

    function updateBonusEligibility(){
      const btn = $("bonusBtn");
      if(!btn) return;

      // Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§: ØºÙŠØ± Ù…ØªØ§Ø­
      bonusEligible = false;
      bonusSuggested = 0;

      // Ù„Ùˆ Ù…Ø´ Ù…Ø¯ÙŠØ± -> Ù…Ø®ÙÙŠ/Ù…Ù‚ÙÙˆÙ„
      if(!isAdmin){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)";
        return;
      }

      const w1=$("winnerP1")?.value || "";
      const w2=$("winnerP2")?.value || "";
      const l1=$("loserP1")?.value || "";
      const l2=$("loserP2")?.value || "";

      if(!w1 || !w2 || !l1 || !l2){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)";
        return;
      }

      const chosen=[w1,w2,l1,l2];
      if(new Set(chosen).size < 4){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)";
        return;
      }

      const latest = getLatestMatch();
      if(!latest){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)";
        return;
      }

      const curW = normTeam([w1,w2]);
      const curL = normTeam([l1,l2]);

      const lastW = normTeam(latest.winners || []);
      const lastL = normTeam(latest.losers || []);

      // Ù†ÙØ³ Ø§Ù„ØªÙ‚Ø³ÙŠÙ…Ø© + Ù†ÙØ³ Ø§Ù„ÙØ§Ø¦Ø² = Ø§Ø­ØªÙ…Ø§Ù„ Ø³ØªØ±ÙŠÙƒ
      if(teamsEqual(curW, lastW) && teamsEqual(curL, lastL)){
        bonusEligible = true;
        const lastBonus = (latest.bonusApplied ? (Number(latest.bonusValue)||0) : 0);
        bonusSuggested = lastBonus + 1;
      }

      if(!bonusEligible){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "ğŸ Ø¨ÙˆÙ†Øµ (ØºÙŠØ± Ù…ØªØ§Ø­)";
        return;
      }

      // Ù…ØªØ§Ø­: Ù†ÙØ¹Ù‘Ù„ Ø§Ù„Ø²Ø± ÙˆÙ†Ø¸Ù„Ù„Ù‡
      btn.disabled = false;
      btn.classList.add("bonus-ready");

      // Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø´ Ù…ØªÙØ¹Ù„ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ù‚ØªØ±Ø­Ø©
      if(!bonusApplied){
        btn.textContent = `ğŸ Ø¥Ø¶Ø§ÙØ© Ø¨ÙˆÙ†Øµ (+${bonusSuggested})`;
      }else{
        btn.textContent = `ğŸ Ø¨ÙˆÙ†Øµ Ù…ÙÙØ¹Ù‘Ù„ (+${bonusValue})`;
      }
    }

    function toggleBonus(){
      if(!isAdmin) return;
      if(!bonusEligible) return;

      bonusApplied = !bonusApplied;
      if(bonusApplied){
        bonusValue = bonusSuggested || 1;
      }else{
        bonusValue = 0;
      }
      updateBonusEligibility();
    }


    // ÙˆØ¶Ø¹ Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ (Ù…Ø®ØªØµØ± / ØªÙØµÙŠÙ„ÙŠ) + Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ø²
    let leaderboardViewMode = "compact"; // "compact" Ø£Ùˆ "detailed"
    let leaderboardSort = {
      column: "points",   // Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù„Ù„ÙØ±Ø²
      direction: "desc"   // "asc" Ø£Ùˆ "desc"
    };

    function getLeaderboardColumns(){
      if(leaderboardViewMode === "compact"){
        return [
          {key:"rank",   label:"Ø§Ù„ØªØ±ØªÙŠØ¨"},
          {key:"name",   label:"Ø§Ù„Ù„Ø§Ø¹Ø¨"},
          {key:"points", label:"Ø§Ù„Ù†Ù‚Ø§Ø·"},
          {key:"bonusNet", label:"Ø¨ÙˆÙ†Øµ"},
          {key:"wins",   label:"ÙÙˆØ²"},
          {key:"losses", label:"Ø®Ø³Ø§Ø±Ø©"},
          {key:"matches",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª"},
          {key:"rate",   label:"% Ø§Ù„ÙÙˆØ²"}
        ];
      } else {
        return [
          {key:"rank",   label:"Ø§Ù„ØªØ±ØªÙŠØ¨"},
          {key:"name",   label:"Ø§Ù„Ù„Ø§Ø¹Ø¨"},
          {key:"points", label:"Ø§Ù„Ù†Ù‚Ø§Ø·"},
          {key:"bonusNet", label:"Ø¨ÙˆÙ†Øµ"},
          {key:"wins",   label:"ÙÙˆØ²"},
          {key:"losses", label:"Ø®Ø³Ø§Ø±Ø©"},
          {key:"matches",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª"},
          {key:"rate",   label:"% Ø§Ù„ÙÙˆØ²"},
          {key:"w2",     label:"Ø«Ù†Ø§Ø¦ÙŠØ© Ù"},
          {key:"w3",     label:"Ø«Ù„Ø§Ø«ÙŠØ© Ù"},
          {key:"w4",     label:"Ø±Ø¨Ø§Ø¹ÙŠØ© Ù"},
          {key:"l2",     label:"Ø«Ù†Ø§Ø¦ÙŠØ© Ø®"},
          {key:"l3",     label:"Ø«Ù„Ø§Ø«ÙŠØ© Ø®"},
          {key:"l4",     label:"Ø±Ø¨Ø§Ø¹ÙŠØ© Ø®"}
        ];
      }
    }

    
    function applyLeaderboardSort(rows){
      const col = leaderboardSort.column;
      const dir = leaderboardSort.direction === "asc" ? 1 : -1;

      // âœ… Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©:
      // 1) Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© (Points + Bonus)
      // 2) Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² (WinRate) ÙÙŠ Ø­Ø§Ù„ ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·
      // 3) Ø¹Ø¯Ø¯ Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ²
      // 4) Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      // 5) Ø§Ù„Ø§Ø³Ù…
      function sortByFinalPoints(a,b){
        const ap = (a.finalPoints ?? 0), bp = (b.finalPoints ?? 0);
        if(bp !== ap) return bp - ap;

        const ar = (a.rate ?? 0), br = (b.rate ?? 0);
        if(br !== ar) return br - ar;

        const aw = (a.wins ?? 0), bw = (b.wins ?? 0);
        if(bw !== aw) return bw - aw;

        const am = (a.matches ?? 0), bm = (b.matches ?? 0);
        if(bm !== am) return bm - am;

        return a.name.localeCompare(b.name,"ar");
      }

      // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨ÙŠØ¹Ù…Ù„ ÙØ±Ø² Ø¹Ù„Ù‰ Ø§Ù„Ù†Ù‚Ø§Ø·/Ø§Ù„ØªØ±ØªÙŠØ¨ -> Ù†Ø·Ø¨Ù‚ Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      if(col === "points" || col === "rank"){
        rows.sort(sortByFinalPoints);
        if(dir === -1){
          // desc (Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ): Ù„Ø§ Ø´ÙŠØ¡
        } else {
          // asc: Ù†Ø¹ÙƒØ³
          rows.reverse();
        }
        return;
      }

      // ÙØ±Ø² Ø­Ø³Ø¨ Ø§Ù„Ø§Ø³Ù…
      if(col === "name"){
        rows.sort((a,b)=> dir * a.name.localeCompare(b.name,"ar"));
        return;
      }

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø§Ù„Ø±Ù‚Ù…ÙŠØ©: ÙØ±Ø² Ø¨Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø«Ù… Ø§Ù„Ø§Ø³Ù…
      rows.sort((a,b)=>{
        const av = a[col] ?? 0;
        const bv = b[col] ?? 0;
        if(av < bv) return -1 * dir;
        if(av > bv) return  1 * dir;
        // ÙƒØ³Ø± Ø§Ù„ØªØ¹Ø§Ø¯Ù„ Ø¨Ø§Ù„Ø§Ø³Ù…
        return a.name.localeCompare(b.name,"ar");
      });
    }


    function $(id){return document.getElementById(id);}

    // ===== Firebase init =====
    function initFirebase(){
      const firebaseConfig = {
        apiKey: "AIzaSyDmNo5FIHlW6fcZmCh0TVYzjc9NIia_iM8",
        authDomain: "domino-league-c2d94.firebaseapp.com",
        projectId: "domino-league-c2d94",
        storageBucket: "domino-league-c2d94.firebasestorage.app",
        messagingSenderId: "928957805726",
        appId: "1:928957805726:web:d6f7bc867cbfb6c824f78f",
        measurementId: "G-J2TJQD7QQ"
      };

      // ØªØ´ØºÙŠÙ„ Firebase Ø¨Ù†Ø³Ø®Ø© compat Ø§Ù„Ù„ÙŠ Ø­Ø§Ø·ÙŠÙ†Ù‡Ø§ ÙÙŠ <script> ÙÙˆÙ‚
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();

      // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
      db.collection("players").onSnapshot(snapshot => {
        const players = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          players.push({
            id: doc.id,
            name: data.name,
            avatar: data.avatar || null,
            banPeriods: data.banPeriods || []
          });
        });
        state.players = players;
        updatePlayersUI();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateMatchesLog();
        updateBonusEligibility();
        updateChampionsLog();
      });

      // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      db.collection("matches").onSnapshot(snapshot => {
        const matches = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          matches.push({
            id: doc.id,
            date: data.date || null,
            winners: data.winners || [],
            losers: data.losers || [],
            players: data.players || [],
            createdAt: data.createdAt || null,
            bonusApplied: data.bonusApplied || false,
            bonusValue: Number(data.bonusValue || 0)
          });
        });
        state.matches = matches;
        updateFilterYearOptions();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateHeadToHeadUI(false);
        updateMatchesLog();
        updateChampionsLog();
      });
    }

    // ===== ADMIN =====
    function updateAdminUI(){
      const ids = ["addPlayerBtn","addMatchBtn","resetAllBtn","bonusBtn"];
      ids.forEach(id=>{
        const el=$(id);
        if(el) el.disabled = !isAdmin;
      });
      ["playerName","playerAvatarFile","matchDate","winnerP1","winnerP2","loserP1","loserP2"]
        .forEach(id=>{
          const el=$(id);
          if(el) el.disabled = !isAdmin;
        });

      $("enableAdminBtn").style.display = isAdmin ? "none" : "inline-block";
      $("disableAdminBtn").style.display = isAdmin ? "inline-block" : "none";
      $("adminStatusText").textContent = isAdmin
        ? "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…ÙÙØ¹Ù‘Ù„: Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØªØ³Ø¬ÙŠÙ„/Ø­Ø°Ù Ø§Ù„Ù…Ø§ØªØ´Ø§Øª ÙˆÙ…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."
        : "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.";

      // Ø¹Ù„Ø´Ø§Ù† Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ØªØ¸Ù‡Ø±/ØªØ®ØªÙÙŠ Ø­Ø³Ø¨ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±
      updateMatchesLog();
      updatePlayersUI();
      updateBonusEligibility();
    }

    function enableAdminMode(){
      const pin = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:");
      if(pin === null) return;
      if(pin === ADMIN_PIN){
        isAdmin = true;
        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.");
      } else {
        alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.");
      }
      updateAdminUI();
    }

    function disableAdminMode(){
      isAdmin = false;
      updateAdminUI();
    }

    // ===== TOGGLE MATCHES LOG =====
    function toggleMatchesLog(){
      const wrapper = $("matchesLogWrapper");
      const btn = $("toggleMatchesLogBtn");
      if(!wrapper || !btn) return;
      matchesLogVisible = !matchesLogVisible;
      wrapper.style.display = matchesLogVisible ? "" : "none";
      btn.textContent = matchesLogVisible ? "ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„" : "ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„";
    }

    function togglePlayersList(){
      const wrapper = $("playersListWrapper");
      const btn = $("togglePlayersListBtn");
      if(!wrapper || !btn) return;
      playersListVisible = !playersListVisible;
      wrapper.style.display = playersListVisible ? "" : "none";
      btn.textContent = playersListVisible
        ? "ğŸ‘¥ Ø¥Ø®ÙØ§Ø¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†"
        : "ğŸ‘¥ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†";
      }

    // ===== PLAYERS =====
    function getPlayerById(id){
      return state.players.find(p=>p.id===id) || null;
    }

    function getPlayerNameById(id){
      const p = getPlayerById(id);
      return p ? p.name : ("ID "+id);
    }


    // ===== BAN / UNBAN helpers =====
    function tsToDate(v){
      if(!v) return null;
      if(typeof v.toDate === "function") return v.toDate();
      if(typeof v.seconds === "number") return new Date(v.seconds * 1000);
      // fallback (string/date)
      return new Date(v);
    }

    function isDateInBanPeriods(dateObj, banPeriods){
      if(!dateObj) return false;
      const t = dateObj.getTime();
      const periods = banPeriods || [];
      return periods.some(p=>{
        const fromD = tsToDate(p.from);
        const toD   = p.to ? tsToDate(p.to) : null;
        if(!fromD) return false;
        const fromT = fromD.getTime();
        const toT   = toD ? toD.getTime() : null;
        return (toT === null) ? (t >= fromT) : (t >= fromT && t <= toT);
      });
    }

    function isPlayerCurrentlyBanned(player){
      const periods = (player && player.banPeriods) ? player.banPeriods : [];
      return periods.some(p => p && p.to == null);
    }

    // âœ… Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© = Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª Ø¨Ø¹Ø¯ ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„ÙÙ„ØªØ± (ÙˆÙ„Ùˆ Ù…ÙÙŠØ´ØŒ Ù†Ø³ØªØ®Ø¯Ù… ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…)
    function getSelectedRangeEndDate(){
      const yearVal = $("filterYear")?.value || "all";
      const monthVal = $("filterMonth")?.value || "all";
      const now = new Date();

      // âœ… Ù„Ùˆ Ø§Ù„ÙÙ„ØªØ± Ø¹Ù„Ù‰ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯: Ù†Ù‡Ø§ÙŠØ© Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± (Ø­ØªÙ‰ Ù„Ùˆ Ø¢Ø®Ø± Ù…Ø§ØªØ´ ÙÙŠ Ø§Ù„Ø´Ù‡Ø± ÙƒØ§Ù† Ø¨Ø¯Ø±ÙŠ)
      if(yearVal !== "all" && monthVal !== "all"){
        const y = Number(yearVal);
        const m = Number(monthVal); // 1-12
        return new Date(y, m, 0, 23, 59, 59, 999); // Ø¢Ø®Ø± ÙŠÙˆÙ… ÙÙŠ Ø§Ù„Ø´Ù‡Ø±
      }

      // âœ… Ù„Ùˆ Ø§Ù„ÙÙ„ØªØ± Ø¹Ù„Ù‰ Ø³Ù†Ø© Ù…Ø­Ø¯Ø¯Ø©: Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø³Ù†Ø©
      if(yearVal !== "all" && monthVal === "all"){
        const y = Number(yearVal);
        return new Date(y, 11, 31, 23, 59, 59, 999); // 31 Ø¯ÙŠØ³Ù…Ø¨Ø±
      }

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ø­Ø§Ù„Ø§Øª (ÙƒÙ„ Ø§Ù„Ø³Ù†ÙŠÙ†/ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª): Ù†Ø³ØªØ®Ø¯Ù… Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø£Ùˆ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…
      const matches = getFilteredMatches();
      let max = null;
      matches.forEach(m=>{
        if(!m.date) return;
        const d = new Date(m.date + "T23:59:59");
        if(!max || d > max) max = d;
      });
      return max || now;
    }

    // âœ… Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ "Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©"
    function shouldShowPlayerForSelectedRange(player, rangeEndDate){
      return !isDateInBanPeriods(rangeEndDate, player.banPeriods || []);
    }


    
    function updatePlayersUI(){
      // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£Ø¨Ø¬Ø¯ÙŠÙ‹Ø§ Ø¨Ø§Ù„Ø§Ø³Ù…
      const playersAll = [...state.players].sort((a,b)=> a.name.localeCompare(b.name,"ar"));

      // âœ… ØªØ³Ø¬ÙŠÙ„ Ù…Ø§ØªØ´Ø§Øª Ø¬Ø¯ÙŠØ¯Ø©: Ù…Ù…Ù†ÙˆØ¹ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§
      const playersForMatch = playersAll.filter(p => !isPlayerCurrentlyBanned(p));

      // âœ… Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª/Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª: ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©
      const rangeEnd = getSelectedRangeEndDate();
      const playersForAnalytics = playersAll.filter(p => shouldShowPlayerForSelectedRange(p, rangeEnd));

      const scoreSelectIds = ["winnerP1","winnerP2","loserP1","loserP2"];
      const analyticsSelectIds = [
        "playerDetailsSelect",
        "h2hP1",
        "h2hP2",
        "h2hT1P1",
        "h2hT1P2",
        "h2hT2P1",
        "h2hT2P2"
      ];

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ select Ø¨ØªØ§Ø¹Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      scoreSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        const current = sel.value;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨...";
        sel.appendChild(opt);

        playersForMatch.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });

        // Ø­Ø§ÙˆÙ„ ØªØ­Ø§ÙØ¸ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ù„Ùˆ Ù…Ø§Ø²Ø§Ù„ Ù…ØªØ§Ø­
        if(current && playersForMatch.some(p=>p.id===current)) sel.value=current;
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ select Ø¨ØªØ§Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª
      analyticsSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        const current = sel.value;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨...";
        sel.appendChild(opt);

        playersForAnalytics.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });

        if(current && playersForAnalytics.some(p=>p.id===current)) sel.value=current;
        else if(id === "playerDetailsSelect"){
          // Ù„Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ù…Ø®ØªØ§Ø± Ø§Ø®ØªÙÙ‰ Ø¨Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±/Ø§Ù„ÙØªØ±Ø©ØŒ Ù†Ø®ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„
          updatePlayerDetailsUI();
        }
      });

      // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù†ØµÙŠ ØªØ­Øª Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
      const info = $("playersListInfo");
      if(info){
        if(playersAll.length===0){
          info.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø£Ø¶ÙÙ Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.";
        } else {
          info.textContent="Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙˆÙ†: " + playersAll.map(p=>p.name).join("ØŒ ");
        }
      }

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¹Ø±Ø¶ + ØªØ¹Ø¯ÙŠÙ„ + Ø­Ø¸Ø±/Ø­Ø°Ù)
      const tbody = $("playersTableBody");
      if(!tbody) return;
      tbody.innerHTML = "";

      if(playersAll.length===0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      playersAll.forEach((p, idx)=>{
        const tr = document.createElement("tr");

        // Ø±Ù‚Ù…
        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        // Ø§Ù„Ù„Ø§Ø¹Ø¨ (ØµÙˆØ±Ø© + Ø§Ø³Ù… + Ø­Ø§Ù„Ø© Ø§Ù„Ø­Ø¸Ø±)
        const tdPlayer = document.createElement("td");
        const wrapper = document.createElement("div");
        wrapper.className = "player-cell";

        if(p.avatar){
          const img = document.createElement("img");
          img.src = p.avatar;
          img.className = "player-avatar";
          wrapper.appendChild(img);
        }

        const span = document.createElement("span");
        span.textContent = p.name;
        wrapper.appendChild(span);

        // Badge Ù„Ù„Ø­Ø§Ù„Ø©
        const bannedNow = isPlayerCurrentlyBanned(p);
        const badge = document.createElement("span");
        badge.style.fontSize = "0.75rem";
        badge.style.padding = "2px 6px";
        badge.style.borderRadius = "999px";
        badge.style.border = "1px solid #ddd";
        badge.style.marginRight = "6px";
        badge.textContent = bannedNow ? "Ù…Ø­Ø¸ÙˆØ±" : "Ù†Ø´Ø·";
        wrapper.appendChild(badge);

        tdPlayer.appendChild(wrapper);
        tr.appendChild(tdPlayer);

        // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        const tdActions = document.createElement("td");
        if(isAdmin){
          // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…
          const editBtn = document.createElement("button");
          editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", ()=>editPlayerName(p.id, p.name));
          tdActions.appendChild(editBtn);

          // ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„ØµÙˆØ±Ø©
          const imgBtn = document.createElement("button");
          imgBtn.textContent = "ğŸ–¼ ØµÙˆØ±Ø©";
          imgBtn.className = "btn-small";
          imgBtn.style.marginRight = "4px";

          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/*";
          fileInput.style.display = "none";
          fileInput.addEventListener("change", ()=>{
            const file = fileInput.files[0];
            if(file){
              changePlayerAvatar(p.id, file);
            }
            fileInput.value = "";
          });
          imgBtn.addEventListener("click", ()=>fileInput.click());

          tdActions.appendChild(imgBtn);
          tdActions.appendChild(fileInput);

          // Ø­Ø¸Ø± / ÙÙƒ Ø§Ù„Ø­Ø¸Ø±
          const banBtn = document.createElement("button");
          banBtn.className = "btn-small";
          banBtn.style.marginRight = "4px";
          banBtn.textContent = bannedNow ? "âœ… ÙÙƒ Ø§Ù„Ø­Ø¸Ø±" : "â›” Ø­Ø¸Ø±";
          banBtn.addEventListener("click", async ()=>{
            if(bannedNow){
              if(!confirm(`ÙÙƒ Ø­Ø¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ "${p.name}"ØŸ`)) return;
              await unbanPlayer(p.id);
            } else {
              if(!confirm(`Ø­Ø¸Ø± Ø§Ù„Ù„Ø§Ø¹Ø¨ "${p.name}"ØŸ\n\nÙ„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©ØŒ ÙˆÙ„Ù† ÙŠØ¸Ù‡Ø± ÙÙŠ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¹Ù†Ø¯Ù…Ø§ ØªÙ‚Ø¹ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ø¯Ø§Ø®Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ø¸Ø±.`)) return;
              await banPlayer(p.id);
            }
          });
          tdActions.appendChild(banBtn);

          // Ø­Ø°Ù Ù„Ø§Ø¹Ø¨ (Ù†Ù‡Ø§Ø¦ÙŠ)
          const delBtn = document.createElement("button");
          delBtn.textContent = "ğŸ—‘ Ø­Ø°Ù";
          delBtn.className = "danger btn-small";
          delBtn.addEventListener("click", ()=> deletePlayerAndMatches(p.id, p.name));
          tdActions.appendChild(delBtn);

        } else {
          tdActions.textContent = "-";
        }

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });

      // ØªØ­Ø¯ÙŠØ« Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ù„Ø¨ÙˆÙ†Øµ Ø¨Ø¹Ø¯ ØªØºÙŠÙŠØ± Ø§Ù„Ù‚ÙˆØ§Ø¦Ù…
      updateBonusEligibility();
    }


    function addPlayer(){
      if(!isAdmin || !db) return;
      const nameInput = $("playerName");
      const fileInput = $("playerAvatarFile");
      const name = nameInput.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹."); return; }

      const finishAdd = (avatarData)=>{
        db.collection("players").add({
          name,
          avatar: avatarData || null,
          banPeriods: []
        }).then(()=>{
          nameInput.value="";
          fileInput.value="";
        }).catch(err=>{
          console.error(err);
          alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        });
      };

      const file = fileInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e => finishAdd(e.target.result);
        reader.readAsDataURL(file);
      } else {
        finishAdd(null);
      }
    }

    function editPlayerName(playerId, currentName){
      if(!isAdmin || !db) return;
      const newName = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù„Ø§Ø¹Ø¨:", currentName || "");
      if(newName === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØºÙ‰
      const trimmed = newName.trim();
      if(!trimmed){
        alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±Øº.");
        return;
      }
      db.collection("players").doc(playerId).update({ name: trimmed })
        .catch(err=>{
          console.error(err);
          alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        });
    }

    function changePlayerAvatar(playerId, file){
      if(!isAdmin || !db || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const avatarData = e.target.result;
        db.collection("players").doc(playerId).update({ avatar: avatarData })
          .catch(err=>{
            console.error(err);
            alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨.");
          });
      };
      reader.readAsDataURL(file);
    }

    // ===== ADMIN: Delete Player (delete player + all matches retroactively) =====
    async function deletePlayerAndMatches(playerId, playerName){
      if(!isAdmin || !db) return;

      const typed = prompt(
        `âš ï¸ Ø­Ø°Ù Ù„Ø§Ø¹Ø¨ Ù†Ù‡Ø§Ø¦ÙŠ\n\nØ§Ù„Ù„Ø§Ø¹Ø¨: ${playerName}\nØ³ÙŠØªÙ… Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ + Ø­Ø°Ù ÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª Ø§Ù„ØªÙŠ Ø´Ø§Ø±Ùƒ ÙÙŠÙ‡Ø§ Ø¨Ø£Ø«Ø± Ø±Ø¬Ø¹ÙŠ.\n\nØ§ÙƒØªØ¨ DELETE Ù„Ù„ØªØ£ÙƒÙŠØ¯:`
      );
      if(typed !== "DELETE") return;

      const typedName = prompt(`Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø§Ù„Ø¶Ø¨Ø· Ù„Ù„ØªØ£ÙƒÙŠØ¯:\n${playerName}`);
      if(typedName !== playerName) return;

      // Ù†Ø¬Ù…Ø¹ ÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª Ø§Ù„ØªÙŠ Ø´Ø§Ø±Ùƒ ÙÙŠÙ‡Ø§ Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø­ØªÙ‰ Ù„Ùˆ Ø§Ù„Ø¯ÙˆÙƒÙŠÙˆÙ…Ù†ØªØ§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© Ù„Ø§ ØªØ­ØªÙˆÙŠ players[])
      const snap = await db.collection("matches").get();
      const toDelete = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        const w = d.winners || [];
        const l = d.losers  || [];
        const p = d.players || [];
        if(w.includes(playerId) || l.includes(playerId) || p.includes(playerId)){
          toDelete.push(doc.ref);
        }
      });

      // Ø­Ø°Ù Ø§Ù„Ù…Ø§ØªØ´Ø§Øª ÙÙŠ Ø¯ÙØ¹Ø§Øª
      let deletedCount = 0;
      for(let i=0;i<toDelete.length;i+=400){
        const batch = db.batch();
        toDelete.slice(i,i+400).forEach(ref=> batch.delete(ref));
        await batch.commit();
        deletedCount += Math.min(400, toDelete.length - i);
      }

      // Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨
      await db.collection("players").doc(playerId).delete();

      alert(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù„Ø§Ø¹Ø¨ "${playerName}" ÙˆØ­Ø°Ù ${deletedCount} Ù…Ø§ØªØ´(Ø§Øª) Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡.`);
      // Ø§Ù„Ù€ onSnapshot Ù‡ÙŠØªÙˆÙ„Ù‰ Ø§Ù„ØªØ­Ø¯ÙŠØ«
    }

    // ===== ADMIN: Ban / Unban =====
    async function banPlayer(playerId){
      if(!isAdmin || !db) return;
      const ref = db.collection("players").doc(playerId);
      const now = firebase.firestore.Timestamp.now();

      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(ref);
        if(!doc.exists) return;
        const data = doc.data() || {};
        const periods = (data.banPeriods || []).slice();

        // Ù„Ùˆ Ø¨Ø§Ù„ÙØ¹Ù„ Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§
        if(periods.some(p => p && p.to == null)) return;

        periods.push({ from: now, to: null });
        tx.update(ref, { banPeriods: periods });
      });
    }

    async function unbanPlayer(playerId){
      if(!isAdmin || !db) return;
      const ref = db.collection("players").doc(playerId);
      const now = firebase.firestore.Timestamp.now();

      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(ref);
        if(!doc.exists) return;
        const data = doc.data() || {};
        const periods = (data.banPeriods || []).slice();

        // Ø§Ù‚ÙÙ„ Ø£Ø­Ø¯Ø« ÙØªØ±Ø© Ø­Ø¸Ø± Ù…ÙØªÙˆØ­Ø©
        for(let i=periods.length-1;i>=0;i--){
          if(periods[i] && periods[i].to == null){
            periods[i] = { ...periods[i], to: now };
            break;
          }
        }
        tx.update(ref, { banPeriods: periods });
      });
    }


      // ===== MATCHES ===== }

    // ===== MATCHES =====
    function addMatch(){
      if(!isAdmin || !db) return;
      if(state.players.length<4){ alert("Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ†."); return; }
      const w1=$("winnerP1").value;
      const w2=$("winnerP2").value;
      const l1=$("loserP1").value;
      const l2=$("loserP2").value;
      if(!w1||!w2||!l1||!l2){ alert("Ø§Ø®ØªØ± ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†."); return; }
      const chosen=[w1,w2,l1,l2];
      if(new Set(chosen).size<4){ alert("Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙƒØ§Ù†."); return; }

      // âœ… Ù…Ù…Ù†ÙˆØ¹ ØªØ³Ø¬ÙŠÙ„ Ù…Ø§ØªØ´ Ø¬Ø¯ÙŠØ¯ Ù„Ùˆ Ø£ÙŠ Ù„Ø§Ø¹Ø¨ Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§
      const now = new Date();
      for(const pid of chosen){
        const pl = getPlayerById(pid);
        if(pl && isPlayerCurrentlyBanned(pl)){
          alert(`Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø§ØªØ´ Ù„Ø£Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ "${pl.name}" Ù…Ø­Ø¸ÙˆØ± Ø­Ø§Ù„ÙŠÙ‹Ø§.`);
          return;
        }
      }

      // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø¨ÙˆÙ†Øµ Ù‚Ø¨Ù„ Ø§Ù„Ø­ÙØ¸
      updateBonusEligibility();
      if(bonusApplied && !bonusEligible){
        bonusApplied = false; bonusValue = 0;
      }

      let dateStr=$("matchDate").value;
      if(!dateStr){
        const now=new Date();
        const y=now.getFullYear();
        const m=String(now.getMonth()+1).padStart(2,"0");
        const d=String(now.getDate()).padStart(2,"0");
        dateStr=`${y}-${m}-${d}`;
      }

      db.collection("matches").add({
        date: dateStr,
        winners:[w1,w2],
        losers:[l1,l2],
        players:[w1,w2,l1,l2],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        bonusApplied: bonusApplied || false,
        bonusValue: bonusApplied ? (Number(bonusValue)||0) : 0
      }).then(()=>{
        $("matchDate").value="";
        ["winnerP1","winnerP2","loserP1","loserP2"].forEach(id=>$(id).value="");
        bonusApplied = false;
        bonusValue = 0;
        updateBonusEligibility();
      }).catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø§ØªØ´.");
      });
    }

    function resetAll(){
      if(!isAdmin || !db) return;
      if(!confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù…ØªØ£ÙƒØ¯ØŸ")) return;

      // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      db.collection("matches").get().then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).then(()=>{
        return db.collection("players").get();
      }).then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
      });
    }
    // ===== MATCHES LOG (Ø¹Ø±Ø¶ + Ø­Ø°Ù) =====
    function deleteMatchById(id){
      if(!isAdmin || !db) return;
      if(!confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø¨Ø§Ù„ØªØ£ÙƒÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø§ØªØ´ØŸ")) return;
      db.collection("matches").doc(id).delete().catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…Ø§ØªØ´.");
      });
    }

    
    // ===== CHAMPIONS LOG (Monthly podiums per selected year) =====
    function updateChampionsLog(){
  const yearVal = $("filterYear")?.value || "all";
  const monthVal = $("filterMonth")?.value || "all";
  const wrapper = $("championsLogWrapper");
  const hint = $("championsLogHint");
  const title = $("championsLogTitle");
  const head = $("championsLogHead");
  const body = $("championsLogBody");
  const extra = $("championsLogExtra");

  if(!wrapper || !head || !body || !title || !hint) return;
  if(extra) extra.innerHTML = "";

  // Ù„Ø§ Ù†Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ø¹Ù„Ù‰ "ÙƒÙ„ Ø§Ù„Ø³Ù†ÙŠÙ†"
  if(yearVal === "all"){
    wrapper.style.display = "none";
    hint.style.display = "block";
    head.innerHTML = "";
    body.innerHTML = "";
    // Ù„ÙƒÙ† Ù†Ù‚Ø¯Ø± Ù†Ø¸Ù‡Ø± Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ Ù„Ùˆ Ø­Ø§Ø¨Ø¨ (Ø­Ø§Ù„ÙŠØ§Ù‹ Ø§Ù„Ø£Ù„Ù‚Ø§Ø¨ ØªØ¸Ù‡Ø± ÙÙ‚Ø· Ø¹Ù†Ø¯Ù…Ø§ ØªØ®ØªØ§Ø± Ø³Ù†Ø©)
    return;
  }

  const year = Number(yearVal);
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth() + 1; // 1-12

  const monthNames = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];

  // ===== Robust date helpers (string / Firestore Timestamp / Date) =====
  function matchToDate(mm){
    const d = mm?.date;
    if(!d) return null;
    if(d instanceof Date) return d;
    // Firestore Timestamp (compat)
    if(typeof d === "object" && typeof d.toDate === "function") return d.toDate();
    if(typeof d === "string"){
      // supports YYYY-MM-DD or ISO strings
      const parsed = new Date(d);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }
    // numeric millis
    if(typeof d === "number"){
      const parsed = new Date(d);
      return Number.isNaN(parsed.getTime()) ? null : parsed;
    }
    return null;
  }

  function matchYearMonth(mm){
    const dt = matchToDate(mm);
    if(!dt) return null;
    return { y: dt.getFullYear(), m: dt.getMonth() + 1 };
  }

  

  // Helper: end-of-month date (used for ban visibility rule)
  function endOfMonthDate(y, m){ // m:1-12
    const d = new Date(y, m, 0); // last day of month m
    d.setHours(23,59,59,999);
    return d;
  }


  // âœ… ØªØ±ØªÙŠØ¨ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø±Ø³Ù…ÙŠ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙÙŠ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ + ØªØ­Ø¯ÙŠØ¯ Ø¨Ø·Ù„ Ø§Ù„Ø´Ù‡Ø±/Ø§Ù„Ø³Ù†Ø©)
  // 1) Final Points = Points + Bonus
  // 2) Win Rate (wins / totalMatches) Ø¹Ù†Ø¯ ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù†Ù‚Ø§Ø·
  // 3) Wins Ø¹Ù†Ø¯ ØªØ³Ø§ÙˆÙŠ Ø§Ù„Ù†Ù‚Ø§Ø· ÙˆÙ†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ²
  // 4) Total Matches Ø¹Ù†Ø¯ ØªØ³Ø§ÙˆÙŠ Ù…Ø§ Ø³Ø¨Ù‚
  // 5) Name
  function compareMonthlyStanding(a,b){
    const ap = (a.finalPoints ?? 0), bp = (b.finalPoints ?? 0);
    if(bp !== ap) return bp - ap;

    const ar = (a.winRate ?? 0), br = (b.winRate ?? 0);
    if(br !== ar) return br - ar;

    const aw = (a.wins ?? 0), bw = (b.wins ?? 0);
    if(bw !== aw) return bw - aw;

    const am = (a.totalMatches ?? 0), bm = (b.totalMatches ?? 0);
    if(bm !== am) return bm - am;

    return (a.name||"").localeCompare(b.name||"", "ar");
  }

  // Ø§Ù„Ø´Ù‡Ø± "Ø§Ù„Ù…ÙƒØªÙ…Ù„" = Ø´Ù‡Ø± Ø§Ù†ØªÙ‡Ù‰ ÙÙŠ Ø§Ù„ØªÙ‚ÙˆÙŠÙ… (Ù…Ø´ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ)
  function isMonthCompleted(y, m){
    if(y < currentYear) return true;
    if(y > currentYear) return false;
    // Ù†ÙØ³ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    return m < currentMonth;
  }

  function hasMatchesInMonth(y, m){
    return state.matches.some(mm=>{
      const ym = matchYearMonth(mm);
      if(!ym) return false;
      return ym.y===y && ym.m===m;
    });
  }

  // ØªØ­Ø¯ÙŠØ¯ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© Ù„ØªØ­Ø¯ÙŠØ¯ "Ø¢Ø®Ø± Ø´Ù‡Ø±" Ùˆ "Ø¢Ø®Ø± Ø³Ù†Ø©"
  function getSelectedEndDate(){
    if(yearVal !== "all" && monthVal !== "all"){
      return endOfMonthDate(year, Number(monthVal));
    }
    // Ø³Ù†Ø© ÙÙ‚Ø·:
    if(year < currentYear) return endOfMonthDate(year, 12);
    // Ø³Ù†Ø© Ø­Ø§Ù„ÙŠØ©: Ù„Ø­Ø¯ Ø§Ù„Ø¢Ù† (Ø­ØªÙ‰ Ù„Ùˆ ÙŠÙ†Ø§ÙŠØ±)
    return now;
  }

  function prevMonthYearFromDate(d){
    const y = d.getFullYear();
    const m = d.getMonth() + 1;
    if(m === 1) return {y: y-1, m: 12};
    return {y: y, m: m-1};
  }

  // Ø¨Ø·Ù„ Ø´Ù‡Ø± Ù…Ø­Ø¯Ø¯
  function computeChampionNameForMonth(y, m){
    if(!y || !m) return null;
    const mMatches = state.matches.filter(mm=>{
      const ym = matchYearMonth(mm);
      if(!ym) return false;
      return ym.y===y && ym.m===m;
    });
    if(mMatches.length === 0) return null;

    const rangeEnd = endOfMonthDate(y, m);

    const rows = [];
    state.players.forEach(p=>{
      if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
      const s = computePlayerFullStats(p.id, mMatches);
      if((s.totalMatches || 0) === 0) return;
      rows.push({
        id: p.id,
        name: p.name,
        wins: s.wins || 0,
        winRate: (s.totalMatches ? ((s.wins||0) / (s.totalMatches||0)) : 0),
        totalMatches: s.totalMatches || 0,
        finalPoints: ((s.wins||0) - (s.losses||0)) + (s.bonusNet || 0)
      });
    });
    if(rows.length === 0) return null;

    rows.sort(compareMonthlyStanding);

    return rows[0]?.name || null;
  }

  // Ø¨Ø·Ù„ Ø³Ù†Ø© ÙƒØ§Ù…Ù„Ø©
  function computeChampionNameForYear(y){
    if(!y) return null;
    const yMatches = state.matches.filter(mm=>{
      const ym = matchYearMonth(mm);
      if(!ym) return false;
      return ym.y===y;
    });
    if(yMatches.length === 0) return null;

    const rangeEnd = endOfMonthDate(y, 12);

    const rows = [];
    state.players.forEach(p=>{
      if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
      const s = computePlayerFullStats(p.id, yMatches);
      if((s.totalMatches || 0) === 0) return;
      rows.push({
        id: p.id,
        name: p.name,
        wins: s.wins || 0,
        winRate: (s.totalMatches ? ((s.wins||0) / (s.totalMatches||0)) : 0),
        totalMatches: s.totalMatches || 0,
        finalPoints: ((s.wins||0) - (s.losses||0)) + (s.bonusNet || 0)
      });
    });
    if(rows.length === 0) return null;

    rows.sort(compareMonthlyStanding);

    return rows[0]?.name || null;
  }

  // 1) ØªØ­Ù‚Ù‚ Ù‡Ù„ ÙŠÙˆØ¬Ø¯ "Ø´Ù‡Ø± Ù…ÙƒØªÙ…Ù„" Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù†Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ÙˆÙ„Ù‡ Ù…Ø¨Ø§Ø±ÙŠØ§Øª
  const completedMonthsWithData = [];
    const maxMonthCutoff = (monthVal !== "all") ? Number(monthVal) : 12;

  for(let m=1; m<=12; m++){
    // Ù„Ùˆ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø­Ø¯Ø¯ Ø´Ù‡Ø±ØŒ Ù†Ø¹Ø±Ø¶/Ù†Ø­Ø³Ø¨ Ø§Ù„Ø´Ù‡ÙˆØ± Ø§Ù„Ù…ÙƒØªÙ…Ù„Ø© Ø­ØªÙ‰ Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ÙÙ‚Ø· (Ø´Ø§Ù…Ù„ Ø§Ù„Ø´Ù‡Ø± Ù†ÙØ³Ù‡)
    if(m > maxMonthCutoff) continue;
    if(!isMonthCompleted(year, m)) continue;
    if(!hasMatchesInMonth(year, m)) continue;
    completedMonthsWithData.push(m);
  }


  // Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡
  const noCompletedMonths = (completedMonthsWithData.length === 0);
  hint.style.display = "none";
  wrapper.style.display = "block";
  const championsEmptyMessage = noCompletedMonths
    ? "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø´Ù‡ÙˆØ± Ù…ÙƒØªÙ…Ù„Ø© Ø¯Ø§Ø®Ù„ Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø© Ù„Ø¹Ø±Ø¶ Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„."
    : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø³Ù†Ø©.";

  // Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
  title.textContent = `Ø³Ø¬Ù„ Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù„Ø³Ù†Ø© ${year} â€” ÙŠÙ…ÙƒÙ† Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ±ØªÙŠØ¨ Ù…Ù† Ø±Ø¤ÙˆØ³ Ø§Ù„Ø£Ø¹Ù…Ø¯Ø©`;

  // 2) ØªØ¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ + (Ø£ÙØ¶Ù„/Ø£Ø³ÙˆØ£ Ù…Ø±ÙƒØ²) Ø¨Ø·Ø±ÙŠÙ‚Ø© Ø¯Ù‚ÙŠÙ‚Ø©
  const byId = new Map();
  state.players.forEach(p=>{
    byId.set(p.id, {
      id: p.id,
      name: p.name,
      first: 0,
      second: 0,
      third: 0,
      ranks: [] // ÙƒÙ„ Ø§Ù„Ù…Ø±Ø§ÙƒØ² Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù†Ø©
    });
  });

  for(const month of completedMonthsWithData){
    const mMatches = state.matches.filter(mm=>{
      const ym = matchYearMonth(mm);
      if(!ym) return false;
      return ym.y===year && ym.m===month;
    });
    if(mMatches.length === 0) continue;

    const rangeEnd = endOfMonthDate(year, month);

    const rows = [];
    state.players.forEach(p=>{
      if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
      const s = computePlayerFullStats(p.id, mMatches);
      if((s.totalMatches || 0) === 0) return;
      rows.push({
        id: p.id,
        name: p.name,
        wins: s.wins || 0,
        winRate: (s.totalMatches ? ((s.wins||0) / (s.totalMatches||0)) : 0),
        totalMatches: s.totalMatches || 0,
        finalPoints: ((s.wins||0) - (s.losses||0)) + (s.bonusNet || 0)
      });
    });
    if(rows.length === 0) continue;

    rows.sort(compareMonthlyStanding);

    // Ø­ÙØ¸ Ø§Ù„Ø±Ø§Ù†Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
    rows.forEach((r, i)=>{
      const rec = byId.get(r.id);
      if(!rec) return;
      rec.ranks.push(i+1);
    });

    // Podium counts
    const top1 = rows[0]?.id || null;
    const top2 = rows[1]?.id || null;
    const top3 = rows[2]?.id || null;
    if(top1 && byId.get(top1)) byId.get(top1).first += 1;
    if(top2 && byId.get(top2)) byId.get(top2).second += 1;
    if(top3 && byId.get(top3)) byId.get(top3).third += 1;
  }

  // build summary
  let summary = Array.from(byId.values()).map(r=>{
    let best = (r.ranks.length ? Math.min(...r.ranks) : null);
    let worst = (r.ranks.length ? Math.max(...r.ranks) : null);

    // Safety: Ù„Ùˆ Ø¹Ù†Ø¯Ù‡ Ù…Ø±Ø§Øª Ù…Ø±ÙƒØ² Ø£ÙˆÙ„/Ø«Ø§Ù†ÙŠ/Ø«Ø§Ù„Ø« Ù„Ø§Ø²Ù… ÙŠÙ†Ø¹ÙƒØ³ Ø¹Ù„Ù‰ Ø£ÙØ¶Ù„ Ù…Ø±ÙƒØ² (Ø­ØªÙ‰ Ù„Ùˆ Ø­ØµÙ„ Ø£ÙŠ Ø®Ù„Ù„ ÙÙŠ ranks)
    if(r.first > 0) best = (best == null ? 1 : Math.min(best, 1));
    else if(r.second > 0) best = (best == null ? 2 : Math.min(best, 2));
    else if(r.third > 0) best = (best == null ? 3 : Math.min(best, 3));

    // Safety: Ù„Ùˆ Ù…ÙÙŠØ´ ranks Ù„Ø£ÙŠ Ø³Ø¨Ø¨ØŒ Ø®Ù„ÙŠ Ø§Ù„Ø£Ø³ÙˆØ£ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 3 Ù„Ùˆ Ø¹Ù†Ø¯Ù‡ Ù…ÙŠØ¯Ø§Ù„ÙŠØ©
    if(worst == null && (r.first > 0 || r.second > 0 || r.third > 0)) worst = 3;

    return { ...r, best, worst };
  }).filter(r=>{
    // ÙŠØ¸Ù‡Ø± Ù„Ùˆ Ø´Ø§Ø±Ùƒ ÙÙŠ Ø£ÙŠ Ø´Ù‡Ø± Ø¯Ø§Ø®Ù„ Ø§Ù„Ø³Ù†Ø© (Ù„Ø¯ÙŠÙ‡ ranks)
    return r.ranks && r.ranks.length > 0;
  });

  // ===== Sorting state for Champions Log =====
  if(!window.championsSort){
    window.championsSort = { column: "first", direction: "desc" };
  }

  function applyChampionsSort(arr){
    const col = window.championsSort.column;
    const dir = window.championsSort.direction === "asc" ? 1 : -1;

    const num = (v, fallback)=> (typeof v === "number" && !Number.isNaN(v)) ? v : fallback;

    arr.sort((a,b)=>{
      // best: Ø§Ù„Ø£ØµØºØ± Ø£ÙØ¶Ù„ØŒ worst: Ø§Ù„Ø£ÙƒØ¨Ø± Ø£Ø³ÙˆØ£ (Ù„ÙƒÙ† Ù†Ø³Ù…Ø­ Ø¨Ø¹ÙƒØ³Ù‡ Ø­Ø³Ø¨ Ø§Ù„Ø³Ù‡Ù…)
      if(col === "best"){
        const av = num(a.best, 9999);
        const bv = num(b.best, 9999);
        if(av !== bv) return (av - bv) * dir;
      } else if(col === "worst"){
        const av = num(a.worst, -1);
        const bv = num(b.worst, -1);
        if(av !== bv) return (av - bv) * dir;
      } else {
        const av = num(a[col], 0);
        const bv = num(b[col], 0);
        if(av !== bv) return (av - bv) * dir;
      }

      // Tie-break Ø«Ø§Ø¨Øª (Ù…Ù†Ø·Ù‚ÙŠ)
      if(b.first !== a.first) return b.first - a.first;
      if(b.second !== a.second) return b.second - a.second;
      if(b.third !== a.third) return b.third - a.third;

      // Ø§Ù„Ø£ÙØ¶Ù„/Ø§Ù„Ø£Ø³ÙˆØ£ ÙƒØªØ¹Ø§Ø¯Ù„
      const ab = num(a.best, 9999), bb = num(b.best, 9999);
      if(ab !== bb) return ab - bb;
      const aw = num(a.worst, -1), bw = num(b.worst, -1);
      if(aw !== bw) return aw - bw;

      return (a.name||"").localeCompare(b.name||"", "ar");
    });
  }

  applyChampionsSort(summary);

  // ===== Render Table =====
  head.innerHTML = "";
  body.innerHTML = "";

  const columns = [
    {label:"Ø§Ù„Ù…Ø±ÙƒØ²", key:"rank", sortable:false},
    {label:"Ø§Ù„Ù„Ø§Ø¹Ø¨", key:"name", sortable:false},
    {label:"ğŸ¥‡1", key:"first", sortable:true},
    {label:"ğŸ¥ˆ2", key:"second", sortable:true},
    {label:"ğŸ¥‰3", key:"third", sortable:true},
    {label:"Ø£ÙØ¶Ù„ Ù…Ø±ÙƒØ²", key:"best", sortable:true},
    {label:"Ø£Ø³ÙˆØ£ Ù…Ø±ÙƒØ²", key:"worst", sortable:true},
  ];

  const trh = document.createElement("tr");
  columns.forEach(c=>{
    const th = document.createElement("th");
    th.textContent = c.label;

    if(c.sortable){
      th.classList.add("sortable");
      th.dataset.col = c.key;

      const arrow = document.createElement("span");
      arrow.className = "sort-arrow";
      const isActive = (window.championsSort.column === c.key);
      arrow.textContent = isActive ? (window.championsSort.direction === "asc" ? "â–²" : "â–¼") : "â†•";
      th.appendChild(arrow);

      th.addEventListener("click", ()=>{
        if(window.championsSort.column === c.key){
          window.championsSort.direction = (window.championsSort.direction === "asc") ? "desc" : "asc";
        } else {
          window.championsSort.column = c.key;
          // default direction: counts desc, best asc, worst desc
          if(c.key === "best") window.championsSort.direction = "asc";
          else if(c.key === "worst") window.championsSort.direction = "desc";
          else window.championsSort.direction = "desc";
        }
        updateChampionsLog();
      });
    }

    trh.appendChild(th);
  });
  head.appendChild(trh);

  if(summary.length === 0){
    const tr = document.createElement("tr");
    const td = document.createElement("td");
    td.colSpan = columns.length;
    td.textContent = championsEmptyMessage;
    tr.appendChild(td);
    body.appendChild(tr);
  } else {
    summary.forEach((r, idx)=>{
      const tr = document.createElement("tr");
      tr.appendChild(createCell(idx+1));
      tr.appendChild(createCell(r.name || "-"));
      tr.appendChild(createCell(r.first || 0));
      tr.appendChild(createCell(r.second || 0));
      tr.appendChild(createCell(r.third || 0));
      tr.appendChild(createCell(r.best==null? "-" : r.best));
      tr.appendChild(createCell(r.worst==null? "-" : r.worst));
      body.appendChild(tr);
    });
  }

  // ===== Extra (Title holders) =====
  const endDate = getSelectedEndDate();
  const prev = prevMonthYearFromDate(endDate);

  const prevYear = endDate.getFullYear() - 1;
  const prevYearChampion = computeChampionNameForYear(prevYear);
  const prevMonthChampion = computeChampionNameForMonth(prev.y, prev.m);

  if(extra){
    extra.innerHTML = `
      <div>ğŸ† Ø­Ø§Ù…Ù„ Ù„Ù‚Ø¨ Ø§Ø®Ø± Ø³Ù†Ø© (<b>${prevYear}</b>): <b>${prevYearChampion || "-"}</b></div>
      <div>ğŸ… Ø­Ø§Ù…Ù„ Ù„Ù‚Ø¨ Ø§Ø®Ø± Ø´Ù‡Ø± (<b>${monthNames[prev.m-1]}</b> ${prev.y}): <b>${prevMonthChampion || "-"}</b></div>
    `;
  }
}
function updateMatchesLog(){
      const tbody = $("matchesLogBody");
      if(!tbody) return;
      tbody.innerHTML = "";

      // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„ÙÙ„ØªØ± Ø¨ØªØ§Ø¹ Ø§Ù„Ø³Ù†Ø©/Ø§Ù„Ø´Ù‡Ø±
      const matches = getFilteredMatches();

      if(matches.length === 0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙŠ Ù…Ø§ØªØ´Ø§Øª Ù…Ø³Ø¬Ù„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      // Ø£Ø­Ø¯Ø« Ù…Ø§ØªØ´ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰ Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
      const sorted = [...matches].sort((a,b)=>{
        const ta = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
        const tb = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
        if(tb !== ta) return tb - ta;
        return (b.date || "").localeCompare(a.date || "");
      });

      sorted.forEach((m,idx)=>{
        const tr = document.createElement("tr");

        tr.appendChild(createCell(idx + 1));
        const dateText = (m.date || "-") + (m.bonusApplied ? ` ğŸ+${Number(m.bonusValue||0)}` : "");
        tr.appendChild(createCell(dateText));
        tr.appendChild(createPlayersListCell(m.winners || []));
        tr.appendChild(createPlayersListCell(m.losers || []));

        const actionTd = document.createElement("td");
        if(isAdmin){
          const btn = document.createElement("button");
          btn.textContent = "ğŸ—‘ Ø­Ø°Ù";
          btn.className = "danger btn-small";
          btn.addEventListener("click", ()=> deleteMatchById(m.id));
          actionTd.appendChild(btn);
        } else {
          actionTd.textContent = "-";
        }
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });
    }

    // ===== FILTER YEAR/MONTH =====
    function updateFilterYearOptions(){
      const sel = $("filterYear");
      if(!sel) return;
      const yearsSet = new Set();
      state.matches.forEach(m=>{
        if(m.date) yearsSet.add(m.date.slice(0,4));
      });
      const current = sel.value || "all";
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value="all"; optAll.textContent="ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª";
      sel.appendChild(optAll);
      Array.from(yearsSet).sort().forEach(y=>{
        const o=document.createElement("option");
        o.value=y; o.textContent=y;
        sel.appendChild(o);
      });
      if(current && (current==="all" || yearsSet.has(current))) sel.value=current;
      else sel.value="all";
    }

    function getFilterLabel(yearVal, monthVal){
      const monthNames = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
      if(yearVal !== "all" && monthVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: " + monthNames[Number(monthVal)-1] + " " + yearVal;
      } else if(yearVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: Ø³Ù†Ø© " + yearVal;
      } else if(monthVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: Ø´Ù‡Ø± " + monthNames[Number(monthVal)-1] + " ÙÙŠ ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª.";
      }
      return "Ø§Ù„ÙØªØ±Ø©: ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª.";
    }

    function getFilteredMatches(){
      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      let filtered = state.matches;

      if(yearVal !== "all"){
        const y = Number(yearVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(0,4)) === y);
        if(monthVal !== "all"){
          const mo = Number(monthVal);
          filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
        }
      } else if(monthVal !== "all"){
        const mo = Number(monthVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
      }
      return filtered;
    }

    function createCell(text){
      const td=document.createElement("td");
      td.textContent=text;
      return td;
    }

    function createPlayerCellTd(playerId){
      const td=document.createElement("td");
      const p=getPlayerById(playerId);
      if(!p){ td.textContent="ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"; return td; }
      const wrapper=document.createElement("div");
      wrapper.className="player-cell";
      if(p.avatar){
        const img=document.createElement("img");
        img.src=p.avatar;
        img.className="player-avatar";
        wrapper.appendChild(img);
      }
      const span=document.createElement("span");
      span.textContent=p.name;
      wrapper.appendChild(span);
      td.appendChild(wrapper);
      return td;
    }

    function createPlayersListCell(ids){
      const td=document.createElement("td");
      ids.forEach((id,idx)=>{
        if(idx>0) td.appendChild(document.createTextNode(" + "));
        const p=getPlayerById(id);
        const wrapper=document.createElement("span");
        wrapper.className="player-cell";
        if(p && p.avatar){
          const img=document.createElement("img");
          img.src=p.avatar;
          img.className="player-avatar";
          wrapper.appendChild(img);
        }
        const span=document.createElement("span");
        span.textContent=p ? p.name : ("ID "+id);
        wrapper.appendChild(span);
        td.appendChild(wrapper);
      });
      return td;
    }

    // ===== LEADERBOARD =====
    function updateLeaderboard(){
      const matches = getFilteredMatches();
      const yearVal  = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      $("currentFilterLabel").textContent = getFilterLabel(yearVal, monthVal);

      const rows = [];

      // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ù†Ø·Ù‚ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„ÙˆØ§Ø­Ø¯ Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
      state.players.forEach(p => {
        // âœ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ùˆ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø© ØªÙ‚Ø¹ Ø¯Ø§Ø®Ù„ ÙØªØ±Ø© Ø§Ù„Ø­Ø¸Ø±
        if(!shouldShowPlayerForSelectedRange(p, getSelectedRangeEndDate())) return;

        const s = computePlayerFullStats(p.id, matches);

        // Ù„Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø§ Ù„Ø¹Ø¨Ø´ ÙˆÙ„Ø§ Ù…Ø§ØªØ´ ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø¯ÙŠØŒ Ø¨Ù†Ø®ÙÙ‘ÙŠÙ‡ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„
        if(s.totalMatches === 0) return;

        rows.push({
          id:       p.id,
          name:     p.name,
          wins:     s.wins,
          losses:   s.losses,
          matches:  s.totalMatches,
          basePoints: (s.wins - s.losses),
          finalPoints: (s.wins - s.losses) + (s.bonusNet || 0),
          points:   (s.wins - s.losses) + (s.bonusNet || 0),
          bonusPlus: s.bonusPlus || 0,
          bonusMinus: s.bonusMinus || 0,
          bonusNet: s.bonusNet || 0,
          rate:     s.winRate,
          // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ 2 / 3 / 4+ ÙÙˆØ²
          w2:       s.daysWin2,
          w3:       s.daysWin3,
          w4:       s.daysWin4plus,
          // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ 2 / 3 / 4+ Ø®Ø³Ø§Ø±Ø©
          l2:       s.daysLose2,
          l3:       s.daysLose3,
          l4:       s.daysLose4plus
        });
      });

      const cols = getLeaderboardColumns();

      // Ù†Ø·Ø¨Ù‘Ù‚ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ±Ø² Ø§Ù„Ø­Ø§Ù„ÙŠØ©
      applyLeaderboardSort(rows);

      // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const thead = $("leaderboardHead");
      thead.innerHTML = "";
      const headerTr = document.createElement("tr");

      cols.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.classList.add("sortable");
        th.dataset.col = col.key;

        const arrow = document.createElement("span");
        arrow.className = "sort-arrow";
        if (leaderboardSort.column === col.key) {
          arrow.textContent = leaderboardSort.direction === "asc" ? "â–²" : "â–¼";
        } else {
          arrow.textContent = "â†•";
        }

        th.appendChild(document.createTextNode(" "));
        th.appendChild(arrow);

        th.addEventListener("click", () => {
          if (leaderboardSort.column === col.key) {
            leaderboardSort.direction =
              leaderboardSort.direction === "asc" ? "desc" : "asc";
          } else {
            leaderboardSort.column   = col.key;
            leaderboardSort.direction = (col.key === "name") ? "asc" : "desc";
          }
          updateLeaderboard();
        });

        headerTr.appendChild(th);
      });

      thead.appendChild(headerTr);

      // Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const tbody = $("leaderboardBody");
      tbody.innerHTML = "";

      if (rows.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = cols.length;
        td.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        r.rank = idx + 1; // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø¨Ø¹Ø¯ Ø§Ù„ÙØ±Ø²

        cols.forEach(col => {
          if (col.key === "name") {
            // Ø®Ù„ÙŠØ© Ø§Ù„Ù„Ø§Ø¹Ø¨ (ØµÙˆØ±Ø© + Ø§Ø³Ù…)
            tr.appendChild(createPlayerCellTd(r.id));
          } else {
            let value;
            if (col.key === "rate") {
              value = r.rate.toFixed(1) + " Ùª";
            } else if (col.key === "rank") {
              value = r.rank;
            } else {
              value = r[col.key] ?? 0;
            }
            tr.appendChild(createCell(value));
          }
        });

        tbody.appendChild(tr);
      });
    }

    // ===== PLAYER ANALYSIS (Ø¨ÙØªØ±Ø© Ø§Ù„ÙÙ„ØªØ±) =====
    
    function computePlayerFullStats(playerId, matches){
      let wins = 0, losses = 0;
      let bonusPlus = 0, bonusMinus = 0;

      const dayMap = new Map();
      const teammateWin  = new Map(), teammateLose  = new Map();
      const opponentWin  = new Map(), opponentLose  = new Map();

      matches.forEach(m=>{
        const d = m.date || "Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®";
        if(!dayMap.has(d)) dayMap.set(d,{w:0,l:0});
        const ds = dayMap.get(d);

        const isW = (m.winners || []).includes(playerId);
        const isL = (m.losers  || []).includes(playerId);

        if(isW){
          wins++; ds.w++;
          if(m.bonusApplied){ bonusPlus += Number(m.bonusValue||0); }

          // Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„ÙÙˆØ²
          (m.winners || []).forEach(pid=>{
            if(pid!==playerId)
              teammateWin.set(pid,(teammateWin.get(pid)||0)+1);
          });

          // Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ù„ÙŠ Ø®Ø³Ø±ÙˆØ§ Ù…Ù†ÙŠ
          (m.losers || []).forEach(pid=>{
            opponentWin.set(pid,(opponentWin.get(pid)||0)+1);
          });
        }

        if(isL){
          losses++; ds.l++;
          if(m.bonusApplied){ bonusMinus += Number(m.bonusValue||0); }

          // Ø²Ù…Ù„Ø§Ø¡ Ø§Ù„Ø®Ø³Ø§Ø±Ø©
          (m.losers || []).forEach(pid=>{
            if(pid!==playerId)
              teammateLose.set(pid,(teammateLose.get(pid)||0)+1);
          });

          // Ø§Ù„Ø®ØµÙˆÙ… Ø§Ù„Ù„ÙŠ ÙƒØ³Ø¨ÙˆØ§ Ø¹Ù„ÙŠÙ‘
          (m.winners || []).forEach(pid=>{
            opponentLose.set(pid,(opponentLose.get(pid)||0)+1);
          });
        }
      });

      const total=wins+losses;
      const rate=total>0?(wins/total)*100:0;

      let dW2=0,dW3=0,dW4=0,dL2=0,dL3=0,dL4=0;
      dayMap.forEach(ds=>{
        if(ds.w===2)dW2++; else if(ds.w===3)dW3++; else if(ds.w>=4)dW4++;
        if(ds.l===2)dL2++; else if(ds.l===3)dL3++; else if(ds.l>=4)dL4++;
      });

      function best(map){
        let bestCount = 0;
        map.forEach((c)=>{ if(c > bestCount) bestCount = c; });
        if(bestCount === 0) return [];
        const result = [];
        map.forEach((c,id)=>{
          if(c === bestCount){
            const p = getPlayerById(id);
            result.push({
              id,
              name: p ? p.name : ("ID " + id),
              count: c
            });
          }
        });
        return result;
      }

      return {
        wins,
        losses,
        totalMatches: total,
        winRate: rate,
        bonusPlus,
        bonusMinus,
        bonusNet: bonusPlus - bonusMinus,

        daysWin2: dW2,
        daysWin3: dW3,
        daysWin4plus: dW4,
        daysLose2: dL2,
        daysLose3: dL3,
        daysLose4plus: dL4,

        bestTeammateWin:  best(teammateWin),
        bestTeammateLose: best(teammateLose),
        bestOpponentWin:  best(opponentWin),
        bestOpponentLose: best(opponentLose)
      };
    }

    function updatePlayerDetailsUI(){
      const sel=$("playerDetailsSelect");
      const summary=$("playerDetailsSummary");
      const box=$("playerDetailsStats");
      if(!sel || !sel.value){
        summary.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„Ù‡.";
        box.style.display="none"; return;
      }
      const id=sel.value;
      const player=getPlayerById(id);
      if(!player){summary.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù.";box.style.display="none";return;}

      // âœ… Ù„Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø­Ø¸ÙˆØ± Ø­Ø³Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©ØŒ Ù†Ø®ÙÙŠ Ø§Ù„ØªØ­Ù„ÙŠÙ„
      if(!shouldShowPlayerForSelectedRange(player, getSelectedRangeEndDate())){
        summary.textContent = `Ø§Ù„Ù„Ø§Ø¹Ø¨ "${player.name}" Ù…Ø­Ø¸ÙˆØ± ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© Ø­Ø³Ø¨ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„ÙÙ„ØªØ±.`;
        box.style.display = "none";
        return;
      }

      const matches = getFilteredMatches();
      const s=computePlayerFullStats(id, matches);

      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label = getFilterLabel(yearVal, monthVal);

      summary.innerHTML=`ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ <strong>${player.name}</strong> (${label})`;

      $("pTotalWins").textContent=s.wins;
      $("pTotalLosses").textContent=s.losses;
      $("pTotalMatches").textContent=s.totalMatches;
      $("pWinRate").textContent=s.winRate.toFixed(1)+"Ùª";
      $("pBonusPlus").textContent = s.bonusPlus || 0;
      $("pBonusMinus").textContent = s.bonusMinus || 0;
      $("pBonusNet").textContent = s.bonusNet || 0;

      $("pDaysWin2").textContent=s.daysWin2;
      $("pDaysWin3").textContent=s.daysWin3;
      $("pDaysWin4plus").textContent=s.daysWin4plus;
      $("pDaysLose2").textContent=s.daysLose2;
      $("pDaysLose3").textContent=s.daysLose3;
      $("pDaysLose4plus").textContent=s.daysLose4plus;

      // Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…ÙØ¶Ù„ (Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø£ÙƒØ«Ø± Ù…Ù† ÙˆØ§Ø­Ø¯)
      if(s.bestTeammateWin && s.bestTeammateWin.length > 0){
        $("pBestMateWinName").textContent =
          s.bestTeammateWin.map(x => x.name).join(" ØŒ ");
        $("pBestMateWinCount").textContent = s.bestTeammateWin[0].count;
      } else {
        $("pBestMateWinName").textContent = "-";
        $("pBestMateWinCount").textContent = "0";
      }

      if(s.bestTeammateLose && s.bestTeammateLose.length > 0){
        $("pBestMateLoseName").textContent =
          s.bestTeammateLose.map(x => x.name).join(" ØŒ ");
        $("pBestMateLoseCount").textContent = s.bestTeammateLose[0].count;
      } else {
        $("pBestMateLoseName").textContent = "-";
        $("pBestMateLoseCount").textContent = "0";
      }

      // Ø§Ù„Ø®ØµÙ… Ø§Ù„Ù…ÙØ¶Ù„ (Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ ÙƒØ³Ø¨Øª Ø¶Ø¯Ù‡ / Ø®Ø³Ø±Øª Ø¶Ø¯Ù‡)
      if(s.bestOpponentWin && s.bestOpponentWin.length > 0){
        $("pBestOppWinName").textContent =
          s.bestOpponentWin.map(x => x.name).join(" ØŒ ");
        $("pBestOppWinCount").textContent = s.bestOpponentWin[0].count;
      } else {
        $("pBestOppWinName").textContent = "-";
        $("pBestOppWinCount").textContent = "0";
      }

      if(s.bestOpponentLose && s.bestOpponentLose.length > 0){
        $("pBestOppLoseName").textContent =
          s.bestOpponentLose.map(x => x.name).join(" ØŒ ");
        $("pBestOppLoseCount").textContent = s.bestOpponentLose[0].count;
      } else {
        $("pBestOppLoseName").textContent = "-";
        $("pBestOppLoseCount").textContent = "0";
      }

      box.style.display="block";
    }

    // ===== H2H (Ø¨ÙØªØ±Ø© Ø§Ù„ÙÙ„ØªØ±) =====
    function updateHeadToHeadUI(reset=true){
      if(reset) $("h2hSummary").textContent='Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".';
    }


function analyzeHeadToHead(){
  const p1Str = $("h2hP1").value;
  const p2Str = $("h2hP2").value;
  const out   = $("h2hSummary");

  if(!p1Str || !p2Str){
    out.textContent = "Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.";
    return;
  }

  const p1 = p1Str, p2 = p2Str;
  if(p1 === p2){
    out.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø±ØªÙŠÙ†.";
    return;
  }

  const pl1 = getPlayerById(p1),
        pl2 = getPlayerById(p2);
  if(!pl1 || !pl2){
    out.textContent = "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.";
    return;
  }

  const matches = getFilteredMatches();

  // vs: Ø¶Ø¯ Ø¨Ø¹Ø¶ â€“ p1W / p2W
  // team: Ù…Ø¹ Ø¨Ø¹Ø¶ â€“ teamWins / teamLosses
  let vs = 0, p1W = 0, p2W = 0;
  let team = 0, teamWins = 0, teamLosses = 0;

  // ğŸ†• transfers
  let baseNet = 0;   // + ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ø­ØµÙ„ Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø· Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 2
  let bonusNet = 0;  // + ÙŠØ¹Ù†ÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ø­ØµÙ„ Ø¹Ù„Ù‰ Ø¨ÙˆÙ†Øµ Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 2

  matches.forEach(m=>{
    const w = m.winners || [];
    const l = m.losers  || [];

    const p1Win  = w.includes(p1);
    const p1Lose = l.includes(p1);
    const p2Win  = w.includes(p2);
    const p2Lose = l.includes(p2);

    // Ù…Ø¹ Ø¨Ø¹Ø¶ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚
    if( (p1Win && p2Win) || (p1Lose && p2Lose) ){
      team++;
      if(p1Win && p2Win)  teamWins++;
      if(p1Lose && p2Lose) teamLosses++;
      return;
    }

    // Ø¶Ø¯ Ø¨Ø¹Ø¶
    if( (p1Win && p2Lose) || (p2Win && p1Lose) ){
      vs++;
      const b = (m.bonusApplied ? Number(m.bonusValue||0) : 0);

      if(p1Win && p2Lose){
        p1W++;
        baseNet += 1;
        bonusNet += b;
      }
      if(p2Win && p1Lose){
        p2W++;
        baseNet -= 1;
        bonusNet -= b;
      }
    }
  });

  const yearVal  = $("filterYear").value;
  const monthVal = $("filterMonth").value;
  const label    = getFilterLabel(yearVal, monthVal);

  let html = `ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨ÙŠÙ† <strong>${pl1.name}</strong> Ùˆ <strong>${pl2.name}</strong> (${label}):<br/><br/>`;
  html += `â€¢ Ù„Ø¹Ø¨ÙˆØ§ Ø¶Ø¯ Ø¨Ø¹Ø¶ ÙÙŠ <strong>${vs}</strong> Ù…Ø§ØªØ´(Ø§Øª) Ø¹Ø´Ø±Ø©.<br/>`;
  html += `â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${pl1.name}</strong> Ø¹Ù„Ù‰ ${pl2.name}: <strong>${p1W}</strong> Ù…Ø±Ø©.<br/>`;
  html += `â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${pl2.name}</strong> Ø¹Ù„Ù‰ ${pl1.name}: <strong>${p2W}</strong> Ù…Ø±Ø©.<br/>`;
  html += `â€¢ Ù„Ø¹Ø¨ÙˆØ§ Ù…Ø¹Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ <strong>${team}</strong> Ù…Ø§ØªØ´(Ø§Øª) Ø¹Ø´Ø±Ø©.<br/>`;

  if(vs > 0){
    const r1 = (p1W / vs) * 100;
    const r2 = (p2W / vs) * 100;
    html += `<br/>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ‚Ø§Ø¨Ù„Ø§Ù† Ø¶Ø¯ Ø¨Ø¹Ø¶ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©:<br/>`;
    html += `â€¢ ${pl1.name}: <strong>${r1.toFixed(1)}Ùª</strong><br/>`;
    html += `â€¢ ${pl2.name}: <strong>${r2.toFixed(1)}Ùª</strong><br/>`;
  }

  // ğŸ†• Ù†Ø³Ø¨Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆÙ‡Ù… ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚
  if(team > 0){
    const teamWinRate  = (teamWins   / team) * 100;
    const teamLoseRate = (teamLosses / team) * 100;
    html += `<br/>Ù†Ø³Ø¨Ø© Ø§Ù„Ù†ØªØ§Ø¦Ø¬ Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙ„Ø¹Ø¨Ø§Ù† Ù…Ø¹Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©:<br/>`;
    html += `â€¢ ÙÙˆØ² Ù…Ø¹Ù‹Ø§: <strong>${teamWinRate.toFixed(1)}Ùª</strong> (${teamWins} Ù…Ù† ${team} Ù…Ø§ØªØ´Ø§Øª)<br/>`;
    html += `â€¢ Ø®Ø³Ø§Ø±Ø© Ù…Ø¹Ù‹Ø§: <strong>${teamLoseRate.toFixed(1)}Ùª</strong> (${teamLosses} Ù…Ù† ${team} Ù…Ø§ØªØ´Ø§Øª)<br/>`;
  }

  // ğŸ†• ØªÙˆØ³ÙŠØ¹ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© (Ø¨ÙˆÙ†Øµ + Ù†Ù‚Ø§Ø· Ø£Ø³Ø§Ø³ÙŠØ©)
  html += `<br/><b>ğŸ Ø§Ù„Ø¨ÙˆÙ†Øµ (Ù…Ø­Ø³ÙˆØ¨ Ù…Ù†ÙØµÙ„)</b><br/>`;
  html += `â€¢ Ø­ØµÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 Ø¹Ù„Ù‰ Ø¨ÙˆÙ†Øµ: <strong>${bonusNet}</strong><br/>`;
  html += `â€¢ Ø­ØµÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ø¹Ù„Ù‰ Ø¨ÙˆÙ†Øµ: <strong>${-bonusNet}</strong><br/>`;

  html += `<br/><b>ğŸ¯ Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© (Ø¨Ø¯ÙˆÙ† Ø¨ÙˆÙ†Øµ)</b><br/>`;
  html += `â€¢ Ø­ØµÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·: <strong>${baseNet}</strong><br/>`;
  html += `â€¢ Ø­ØµÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ 2 Ù…Ù† Ø§Ù„Ù„Ø§Ø¹Ø¨ 1 Ø¹Ù„Ù‰ Ù†Ù‚Ø§Ø·: <strong>${-baseNet}</strong><br/>`;

  out.innerHTML = html;
}


    // ===== TEAMS H2H (2 Ø¶Ø¯ 2) =====
    function normalizeTeamId(p1, p2){
      if(!p1 || !p2) return null;
      // Ù†Ø®Ù„ÙŠ Ø§Ù„Ù€ ID Ø«Ø§Ø¨Øª Ù…Ù‡Ù…Ø§ ÙƒØ§Ù† ØªØ±ØªÙŠØ¨ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
      return (p1 < p2) ? (p1 + "|" + p2) : (p2 + "|" + p1);
    }

    function resetTeamsH2HSummary(){
      const el = $("h2hTeamsSummary");
      if(el){
        el.textContent = 'Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".';
      }
    }

    function analyzeTeamsHeadToHead(){
      const t1p1 = $("h2hT1P1").value;
      const t1p2 = $("h2hT1P2").value;
      const t2p1 = $("h2hT2P1").value;
      const t2p2 = $("h2hT2P2").value;
      const out  = $("h2hTeamsSummary");

      if(!out) return;

      // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
      if(!t1p1 || !t1p2 || !t2p1 || !t2p2){
        out.textContent = "Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„ÙƒÙ„ ÙØ±ÙŠÙ‚ Ø£ÙˆÙ„Ù‹Ø§.";
        return;
      }

      // Ù…Ù…Ù†ÙˆØ¹ Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠØªÙƒØ±Ø± ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚
      if(t1p1 === t1p2 || t2p1 === t2p2){
        out.textContent = "Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† Ù…ÙƒØ§Ù† Ù„Ø§Ø¹Ø¨ 1 Ùˆ 2 ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚.";
        return;
      }

      // Ù„Ùˆ Ø­Ø§Ø¨Ø¨ ØªÙ…Ù†Ø¹ ØªÙƒØ±Ø§Ø± Ù„Ø§Ø¹Ø¨ Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ†:
      const all = [t1p1,t1p2,t2p1,t2p2];
      if(new Set(all).size < 4){
        out.textContent = "Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙ„Ø¹Ø¨ ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©.";
        return;
      }

      const team1Id = normalizeTeamId(t1p1, t1p2);
      const team2Id = normalizeTeamId(t2p1, t2p2);

      if(team1Id === team2Id){
        out.textContent = "Ù„Ø§ ÙŠÙ…ÙƒÙ† Ù…Ù‚Ø§Ø±Ù†Ø© Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ Ø¨Ù†ÙØ³Ù‡.";
        return;
      }

      const t1Name =
        getPlayerNameById(t1p1) + " + " + getPlayerNameById(t1p2);
      const t2Name =
        getPlayerNameById(t2p1) + " + " + getPlayerNameById(t2p2);

      const matches = getFilteredMatches();

      let vs = 0;
      let t1Wins = 0;
      let t2Wins = 0;

      matches.forEach(m=>{
        if(!m.winners || !m.losers) return;
        if(m.winners.length !== 2 || m.losers.length !== 2) return;

        const wTeamId = normalizeTeamId(m.winners[0], m.winners[1]);
        const lTeamId = normalizeTeamId(m.losers[0], m.losers[1]);

        if(!wTeamId || !lTeamId) return;

        // Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† Ø¨Ø§Ù„Ø¸Ø¨Ø·ØŸ
        if(
          (wTeamId === team1Id && lTeamId === team2Id) ||
          (wTeamId === team2Id && lTeamId === team1Id)
        ){
          vs++;
          if(wTeamId === team1Id) t1Wins++;
          if(wTeamId === team2Id) t2Wins++;
        }
      });

      const yearVal  = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label    = getFilterLabel(yearVal, monthVal);

      if(vs === 0){
        out.innerHTML =
          `Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£ÙŠ Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† <strong>${t1Name}</strong> Ùˆ <strong>${t2Name}</strong> ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø© (${label}).`;
        return;
      }

      const t1Rate = (t1Wins / vs) * 100;
      const t2Rate = (t2Wins / vs) * 100;

      let html = `ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨ÙŠÙ† Ø§Ù„ÙØ±ÙŠÙ‚ <strong>${t1Name}</strong> ÙˆØ§Ù„ÙØ±ÙŠÙ‚ <strong>${t2Name}</strong> (${label}):<br/><br/>`;
      html += `â€¢ Ù„Ø¹Ø¨ÙˆØ§ Ø¶Ø¯ Ø¨Ø¹Ø¶ ÙÙŠ <strong>${vs}</strong> Ù…Ø§ØªØ´(Ø§Øª) Ø¹Ø´Ø±Ø©.<br/>`;
      html += `â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${t1Name}</strong>: <strong>${t1Wins}</strong> Ù…Ø±Ø©.<br/>`;
      html += `â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${t2Name}</strong>: <strong>${t2Wins}</strong> Ù…Ø±Ø©.<br/>`;
      html += `<br/>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ‚Ø§Ø¨Ù„Ø§Ù† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©:<br/>`;
      html += `â€¢ ${t1Name}: <strong>${t1Rate.toFixed(1)}Ùª</strong><br/>`;
      html += `â€¢ ${t2Name}: <strong>${t2Rate.toFixed(1)}Ùª</strong><br/>`;

      out.innerHTML = html;
    }

    // ===== INIT =====
    function init(){
      initFirebase();
      updateAdminUI();
      updateBonusEligibility();
      ["winnerP1","winnerP2","loserP1","loserP2"].forEach(id=>{
        const el=$(id);
        if(el) el.addEventListener("change", updateBonusEligibility);
      });


      // âœ… Ø¶Ø¨Ø· Ø§Ù„ÙÙ„ØªØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø¹Ù„Ù‰ "Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ"
      const now = new Date();
      const currentYear  = String(now.getFullYear());
      const currentMonth = String(now.getMonth() + 1); // Ù…Ù† 1 Ø¥Ù„Ù‰ 12

      const fy = $("filterYear");
      const fm = $("filterMonth");

      // Ù†Ø¶Ù…Ù† Ø¥Ù† Ø³Ù†Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©ØŒ ÙˆÙ„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯Ø© Ù†Ø¶ÙŠÙÙ‡Ø§
      if(fy){
        let yearOpt = Array.from(fy.options).find(o => o.value === currentYear);
        if(!yearOpt){
          yearOpt = document.createElement("option");
          yearOpt.value = currentYear;
          yearOpt.textContent = currentYear;
          fy.appendChild(yearOpt);
        }
        fy.value = currentYear;
      }

      if(fm){
        fm.value = currentMonth; // Ù„Ø£Ù† Ø§Ù„Ø´Ù‡ÙˆØ± 1..12 Ù…ÙˆØ¬ÙˆØ¯Ø© Ø¨Ø§Ù„ÙØ¹Ù„ ÙÙŠ Ø§Ù„Ù€ HTML
      }

      // Ù†Ø­Ø¯Ù‘Ø« Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø³Ø¬Ù„ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠØ©      updateLeaderboard();
      updateChampionsLog();
      updateMatchesLog();
      updateHeadToHeadUI(true);
      if($("playerDetailsSelect")) updatePlayerDetailsUI();

      // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù„Ø³ØªÙŠÙ†Ø±Ø² Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ
      $("addPlayerBtn").addEventListener("click",addPlayer);
      $("addMatchBtn").addEventListener("click",addMatch);
      $("bonusBtn").addEventListener("click",toggleBonus);
      $("resetAllBtn").addEventListener("click",resetAll);
      $("playerDetailsSelect").addEventListener("change",updatePlayerDetailsUI);
      $("h2hAnalyzeBtn").addEventListener("click",analyzeHeadToHead);
      $("enableAdminBtn").addEventListener("click",enableAdminMode);
      $("disableAdminBtn").addEventListener("click",disableAdminMode);

      // â­ Ø²Ø±Ø§Ø± ØªØ­Ù„ÙŠÙ„ Ù…ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„ÙØ±Ù‚ 2 Ø¶Ø¯ 2
      const h2hTeamsBtn = $("h2hTeamsAnalyzeBtn");
      if (h2hTeamsBtn){
        h2hTeamsBtn.addEventListener("click", analyzeTeamsHeadToHead);
      }

      $("filterYear").addEventListener("change",()=>{
        updatePlayersUI();
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
        else updateHeadToHeadUI(true);

        updateMatchesLog();
        updateChampionsLog();
        updateChampionsLog();
        // â­ Ø±Ø¬Ù‘Ø¹ Ù†Øµ Ù…Ù„Ø®Øµ Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„ÙØ±Ù‚ Ù„Ù„ÙˆØ¶Ø¹ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
        resetTeamsH2HSummary();
      });

      $("filterMonth").addEventListener("change",()=>{
        updatePlayersUI();
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
        else updateHeadToHeadUI(true);

        updateMatchesLog();
        updateChampionsLog();
        // â­ Ø¨Ø±Ø¶Ù‡ Ù†Ø±Ø¬Ù‘Ø¹ Ù…Ù„Ø®Øµ Ø§Ù„ÙØ±Ù‚
        resetTeamsH2HSummary();
      });

      const toggleViewBtn = $("leaderboardToggleViewBtn");
      if(toggleViewBtn){
        toggleViewBtn.addEventListener("click", ()=>{
          leaderboardViewMode = (leaderboardViewMode === "compact") ? "detailed" : "compact";
          toggleViewBtn.textContent = (leaderboardViewMode === "compact")
            ? "ğŸ“Š Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ"
            : "ğŸ“‹ Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ±";
          updateLeaderboard();
          if($("playerDetailsSelect").value) updatePlayerDetailsUI();
          if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
          else updateHeadToHeadUI(true);

          // Ù…Ø´ Ù„Ø§Ø²Ù… Ù‡Ù†Ø§ Ù†Ø­Ù„Ù„ Ø§Ù„ÙØ±Ù‚ ØªØ§Ù†ÙŠØŒ Ø¨Ø³ Ù„Ùˆ Ø­Ø§Ø¨Ø¨:
          // resetTeamsH2HSummary();
        });
      }

      $("togglePlayersListBtn").addEventListener("click", togglePlayersList);
      $("toggleMatchesLogBtn").addEventListener("click", toggleMatchesLog);
    }

    document.addEventListener("DOMContentLoaded",init);
  
  // ===== Init Theme + Language =====
  (function(){
    const langSelect = document.getElementById("langSelect");
    if (langSelect) {
      langSelect.value = getLang();
      langSelect.addEventListener("change", (e) => setLang(e.target.value));
    }
    const themeBtn = document.getElementById("themeToggleBtn");
    if (themeBtn) themeBtn.addEventListener("click", toggleTheme);

    applyLang(getLang());
    applyTheme(getTheme());
  })();

</script>
</body>
</html>

