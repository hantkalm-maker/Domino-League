<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>ุจุฑูุงูุฌ ุชุฑุชูุจ ุงูุฏููููู - ุงูุนุดุฑุฉ (151)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      direction: rtl;
    }

    th.sortable {
      cursor: pointer;
      white-space: nowrap;
    }

    .sort-arrow {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-right: 4px;
    }

    header {
      background: #222;
      color: #fff;
      padding: 16px 24px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      max-width: 980px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    .field {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button.primary {
      background: #2563eb;
      color: #fff;
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.danger {
      background: #b91c1c;
      color: #fff;
    }

    button.danger:hover {
      background: #991b1b;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:active:not(:disabled) {
      transform: scale(0.97);
    }

    .small-text {
      font-size: 0.8rem;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f1f5f9;
      font-weight: 700;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-box {
      border-radius: 8px;
      background: #f9fafb;
      padding: 8px;
      font-size: 0.8rem;
      text-align: center;
    }

    .stat-box strong {
      display: block;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
    }

    .admin-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .admin-bar-text {
      font-size: 0.8rem;
    }

    .player-cell {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .player-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    /* Bonus button highlight when available */
    #bonusBtn.bonus-ready{
      background: #f59e0b;
      color: #111;
    }
    #bonusBtn:disabled{
      opacity: 0.5;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 0.8rem;
        padding: 6px 4px;
      }
    }
  </style>

  <!-- Firebase (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>ุจุฑูุงูุฌ ุชุฑุชูุจ ุงูุฏููููู ุงูุฒูุฌู - ุงูุนุดุฑุฉ (151)</h1>
    <div class="small-text">
      ูู ูุงุชุด (ุนุดุฑุฉ) = ุงููุฑูู ุงููุณุจุงู +1 ููู ูุงุนุจ / ุงูุฎุณุฑุงู -1 ููู ูุงุนุจ
    </div>
  </header>

  <main>
    <!-- ุฅุฏุงุฑุฉ ุงููุงุนุจูู -->
    <section class="card">
      <h2>๐ค ุฅุฏุงุฑุฉ ุงููุงุนุจูู</h2>
      <div class="row">
        <div class="field">
          <label for="playerName">ุงุณู ุงููุงุนุจ ุงูุฌุฏูุฏ</label>
          <input type="text" id="playerName" placeholder="ูุซุงู: ุฃุญูุฏุ ุนููุ ุญุณุงู..." />
        </div>
        <div class="field">
          <label for="playerAvatarFile">ุตูุฑุฉ ุงููุงุนุจ (ุงุฎุชูุงุฑู)</label>
          <input type="file" id="playerAvatarFile" accept="image/*" />
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addPlayerBtn">โ ุฅุถุงูุฉ ูุงุนุจ</button>
        </div>
      </div>

      <!-- ุฒุฑ ุนุฑุถ/ุฅุฎูุงุก ูุงุฆูุฉ ุงููุงุนุจูู -->
      <div class="row" style="margin-bottom:4px;">
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="togglePlayersListBtn">๐ฅ ุนุฑุถ ูุงุฆูุฉ ุงููุงุนุจูู</button>
        </div>
      </div>

      <!-- ุบูุงู ูุงุฆูุฉ ุงููุงุนุจูู (ูุฎูู ุงูุชุฑุงุถููุง) -->
      <div id="playersListWrapper" style="display:none;">
        <div class="small-text" id="playersListInfo"></div>

        <!-- ุฌุฏูู ุงููุงุนุจูู ููุชุนุฏูู -->
        <table style="margin-top:8px;">
          <thead>
            <tr>
              <th>#</th>
              <th>ุงููุงุนุจ</th>
              <th>ุฅุฌุฑุงุกุงุช</th>
            </tr>
          </thead>
          <tbody id="playersTableBody"></tbody>
        </table>
        <div class="small-text">
          ุชูุฏุฑ ุชุนุฏูู ุงุณู ุงููุงุนุจ ุฃู ุชุถูู/ุชุบููุฑ ุตูุฑุฉ ุงููุงุนุจ ูู ุงูุฌุฏูู (ุงูุชุนุฏูู ูุชุงุญ ูููุฏูุฑ ููุท).
        </div>
      </div>
    </section>

    <!-- ุชุณุฌูู ูุชูุฌุฉ ูุงุชุด -->
    <section class="card">
      <h2>๐งฎ ุชุณุฌูู ูุชูุฌุฉ ูุงุชุด (ุนุดุฑุฉ ูุงููุฉ)</h2>
      <div class="row">
        <div class="field">
          <label for="matchDate">ุชุงุฑูุฎ ุงููุงุชุด</label>
          <input type="date" id="matchDate" />
          <span class="small-text">ูู ุชุฑูุชู ูุงุถูุ ููุชุณุฌู ุจุชุงุฑูุฎ ุงูููู</span>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ุงููุฑูู ุงููุณุจุงู - ูุงุนุจ 1</label>
          <select id="winnerP1"></select>
        </div>
        <div class="field">
          <label>ุงููุฑูู ุงููุณุจุงู - ูุงุนุจ 2</label>
          <select id="winnerP2"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>ุงููุฑูู ุงูุฎุณุฑุงู - ูุงุนุจ 1</label>
          <select id="loserP1"></select>
        </div>
        <div class="field">
          <label>ุงููุฑูู ุงูุฎุณุฑุงู - ูุงุนุจ 2</label>
          <select id="loserP2"></select>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addMatchBtn">โ ุญูุธ ูุชูุฌุฉ ุงููุงุชุด</button>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="bonusBtn" disabled>๐ ุจููุต (ุบูุฑ ูุชุงุญ)</button>
        </div>
      </div>
      <div class="small-text">
        ููุงุญุธุฉ: ููุณ ุงููุงุนุจ ูุง ูููุนุด ูููู ูู ุงููุฑูููู ูู ููุณ ุงููุงุชุด.
      </div>
    </section>

    <!-- ุงูุชุฑุชูุจ ูุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ -->
    <section class="card">
      <h2>๐ ุงูุชุฑุชูุจ ูุงูุฅุญุตุงุฆูุงุช ุงูุนุงูุฉ</h2>
      <div class="row">
        <div class="field">
          <label for="filterYear">ุงูุณูุฉ</label>
          <select id="filterYear">
            <option value="all">ูู ุงูุณููุงุช</option>
          </select>
        </div>
        <div class="field">
          <label for="filterMonth">ุงูุดูุฑ</label>
          <select id="filterMonth">
            <option value="all">ูู ุงูุดููุฑ</option>
            <option value="1">ููุงูุฑ</option>
            <option value="2">ูุจุฑุงูุฑ</option>
            <option value="3">ูุงุฑุณ</option>
            <option value="4">ุฃุจุฑูู</option>
            <option value="5">ูุงูู</option>
            <option value="6">ููููู</option>
            <option value="7">ููููู</option>
            <option value="8">ุฃุบุณุทุณ</option>
            <option value="9">ุณุจุชูุจุฑ</option>
            <option value="10">ุฃูุชูุจุฑ</option>
            <option value="11">ููููุจุฑ</option>
            <option value="12">ุฏูุณูุจุฑ</option>
          </select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button id="leaderboardToggleViewBtn">๐ ุนุฑุถ ุชูุตููู</button>
        </div>
      </div>

      <div class="small-text" id="currentFilterLabel"></div>

      <table id="leaderboardTable">
        <thead id="leaderboardHead"></thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </section>


    <!-- ุณุฌู ุงูุฃุจุทุงู -->
    <section class="card" id="championsLogCard">
      <h2>๐ ุณุฌู ุงูุฃุจุทุงู (ุดูุฑู)</h2>
      <div class="small-text" id="championsLogHint">
        ุงุฎุชุฑ ุณูุฉ ูุญุฏุฏุฉ ูุนุฑุถ ุณุฌู ุฃุจุทุงู ุงูุดููุฑ (ูุซู ุณุฌู ุงูุฏูุฑู ุงูุฅูุฌููุฒู).
      </div>

      <div id="championsLogWrapper" style="display:none;">
        <div class="small-text" id="championsLogTitle" style="margin-bottom:8px;"></div>
        <table id="championsLogTable">
          <thead id="championsLogHead"></thead>
          <tbody id="championsLogBody"></tbody>
        </table>

        <div id="championsLogExtra" class="small-text" style="margin-top:10px; line-height:1.9;"></div>
      </div>
    </section>

    <!-- ุณุฌู ุงููุงุชุดุงุช -->
    <section class="card">
      <h2>๐ ุณุฌู ุงููุงุชุดุงุช (ูู ุงูููุช)</h2>

      <div class="row" style="margin-bottom:4px;">
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="toggleMatchesLogBtn">๐๏ธ ุนุฑุถ ุงูุณุฌู</button>
        </div>
      </div>

      <div id="matchesLogWrapper" style="display:none;">
        <div class="small-text">
          ุฃุญุฏุซ ูุงุชุด ูู ุงูุฃุนูู. ููููู ุญุฐู ุฃู ูุงุชุด ุบูุท ุจุฏูู ุงูุชุฃุซูุฑ ุนูู ุงูุจุงูู.
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>ุงูุชุงุฑูุฎ</th>
              <th>ุงููุฑูู ุงููุณุจุงู</th>
              <th>ุงููุฑูู ุงูุฎุณุฑุงู</th>
              <th>ุญุฐู</th>
            </tr>
          </thead>
          <tbody id="matchesLogBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ุชุญููู ูุงุนุจ ูุงุญุฏ -->
    <section class="card">
      <h2>๐ ุชุญููู ูุงุนุจ ูููุฑุฏ</h2>
      <div class="row">
        <div class="field">
          <label for="playerDetailsSelect">ุงุฎุชุฑ ูุงุนุจ</label>
          <select id="playerDetailsSelect"></select>
        </div>
      </div>
      <div id="playerDetailsSummary" class="small-text">
        ุงุฎุชุฑ ูุงุนุจ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุชุญูููู.
      </div>

      <div id="playerDetailsStats" style="margin-top:10px; display:none;">
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pTotalWins">0</strong>
            ุฅุฌูุงูู ูุฑุงุช ุงูููุฒ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
          </div>
          <div class="stat-box">
            <strong id="pTotalLosses">0</strong>
            ุฅุฌูุงูู ูุฑุงุช ุงูุฎุณุงุฑุฉ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
          </div>
          <div class="stat-box">
            <strong id="pTotalMatches">0</strong>
            ุฅุฌูุงูู ุงููุงุชุดุงุช ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
          </div>
          <div class="stat-box">
            <strong id="pWinRate">0%</strong>
            ูุณุจุฉ ุงูููุฒ ูู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
          </div>
          <div class="stat-box">
            <strong id="pBonusPlus">0</strong>
            ุจููุต + (ููุณุจ)
          </div>
          <div class="stat-box">
            <strong id="pBonusMinus">0</strong>
            ุจููุต โ (ุฎุณุงุฑุฉ)
          </div>
          <div class="stat-box">
            <strong id="pBonusNet">0</strong>
            ุตุงูู ุงูุจููุต
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">๐ ุชุญููู ุฃูุงู ุงูููุฒ ูุงูุฎุณุงุฑุฉ ูู ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pDaysWin2">0</strong>
            ุฃูุงู ูุณุจ ูููุง ูุฑุชูู
          </div>
          <div class="stat-box">
            <strong id="pDaysWin3">0</strong>
            ุฃูุงู ูุณุจ ูููุง 3 ูุฑุงุช
          </div>
          <div class="stat-box">
            <strong id="pDaysWin4plus">0</strong>
            ุฃูุงู ูุณุจ ูููุง 4 ูุฑุงุช ุฃู ุฃูุซุฑ
          </div>
          <div class="stat-box">
            <strong id="pDaysLose2">0</strong>
            ุฃูุงู ุฎุณุฑ ูููุง ูุฑุชูู
          </div>
          <div class="stat-box">
            <strong id="pDaysLose3">0</strong>
            ุฃูุงู ุฎุณุฑ ูููุง 3 ูุฑุงุช
          </div>
          <div class="stat-box">
            <strong id="pDaysLose4plus">0</strong>
            ุฃูุงู ุฎุณุฑ ูููุง 4 ูุฑุงุช ุฃู ุฃูุซุฑ
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">๐ค ุงูุดุฑูู ุงูููุถู ูู ููุณ ุงููุชุฑุฉ</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pBestMateWinName">-</strong>
            ุฃูุชุฑ ูุงุญุฏ ูุณุจุช ูุนุงู
            <div class="small-text">
              ุนุฏุฏ ุงููุฑุงุช: <span id="pBestMateWinCount">0</span>
            </div>
          </div>
          <div class="stat-box">
            <strong id="pBestMateLoseName">-</strong>
            ุฃูุชุฑ ูุงุญุฏ ุฎุณุฑูุช ูุนุงู
            <div class="small-text">
              ุนุฏุฏ ุงููุฑุงุช: <span id="pBestMateLoseCount">0</span>
            </div>
          </div>
        </div>
        <h3 style="font-size:0.95rem; margin-top:14px;">๐ ุงูุฎุตู ุงูููุถู ูู ููุณ ุงููุชุฑุฉ</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pBestOppWinName">-</strong>
            ุฃูุชุฑ ูุงุญุฏ ูุณุจุช ุถุฏู
            <div class="small-text">
              ุนุฏุฏ ุงููุฑุงุช: <span id="pBestOppWinCount">0</span>
            </div>
          </div>
          <div class="stat-box">
            <strong id="pBestOppLoseName">-</strong>
            ุฃูุชุฑ ูุงุญุฏ ุฎุณุฑุช ุถุฏู
            <div class="small-text">
              ุนุฏุฏ ุงููุฑุงุช: <span id="pBestOppLoseCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ุชุญููู ุงูููุงุฌูุงุช ุงููุจุงุดุฑุฉ -->
    <section class="card">
      <h2>โ๏ธ ุชุญููู ุงูููุงุฌูุงุช ุงููุจุงุดุฑุฉ ุจูู ูุงุนุจูู</h2>
      <div class="row">
        <div class="field">
          <label for="h2hP1">ุงููุงุนุจ ุงูุฃูู</label>
          <select id="h2hP1"></select>
        </div>
        <div class="field">
          <label for="h2hP2">ุงููุงุนุจ ุงูุซุงูู</label>
          <select id="h2hP2"></select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="h2hAnalyzeBtn">๐ ุชุญููู ุงูููุงุฌูุฉ</button>
        </div>
      </div>
      <div id="h2hSummary" class="small-text">
        ุงุฎุชุฑ ูุงุนุจูู ุซู ุงุถุบุท "ุชุญููู ุงูููุงุฌูุฉ".
      </div>
    </section>

    <!-- ุชุญููู ุงูููุงุฌูุงุช ุงููุจุงุดุฑุฉ ุจูู ูุฑู 2 ุถุฏ 2 -->
    <section class="card">
      <h2>๐งฉ ุชุญููู ุงูููุงุฌูุงุช ุงููุจุงุดุฑุฉ ุจูู ูุฑู (2 ุถุฏ 2)</h2>

      <div class="row">
        <div class="field">
          <label for="h2hT1P1">ุงููุฑูู ุงูุฃูู - ูุงุนุจ 1</label>
          <select id="h2hT1P1"></select>
        </div>
        <div class="field">
          <label for="h2hT1P2">ุงููุฑูู ุงูุฃูู - ูุงุนุจ 2</label>
          <select id="h2hT1P2"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label for="h2hT2P1">ุงููุฑูู ุงูุซุงูู - ูุงุนุจ 1</label>
          <select id="h2hT2P1"></select>
        </div>
        <div class="field">
          <label for="h2hT2P2">ุงููุฑูู ุงูุซุงูู - ูุงุนุจ 2</label>
          <select id="h2hT2P2"></select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="h2hTeamsAnalyzeBtn">๐ ุชุญููู ุงูููุงุฌูุฉ</button>
        </div>
      </div>

      <div id="h2hTeamsSummary" class="small-text">
        ุงุฎุชุฑ ูุงุนุจู ุงููุฑูููู ุซู ุงุถุบุท "ุชุญููู ุงูููุงุฌูุฉ".
      </div>
    </section>

    <!-- ูุณู ุงููุฏูุฑ ูุงูุฅุฏุงุฑุฉ ุงููุชูุฏูุฉ -->
    <section class="card">
      <h2>๐ ูุถุน ุงููุฏูุฑ ูุงูุฅุฏุงุฑุฉ ุงููุชูุฏูุฉ</h2>

      <div class="admin-bar">
        <button class="primary" id="enableAdminBtn">๐ ุชูุนูู ูุถุน ุงููุฏูุฑ</button>
        <button class="danger" id="disableAdminBtn" style="display:none;">๐ช ููู ูุถุน ุงููุฏูุฑ</button>
        <div id="adminStatusText" class="admin-bar-text">
          ูุถุน ุงููุดุงูุฏุฉ ููุท: ูุง ูููู ุชุนุฏูู ุงูุจูุงูุงุช ุฅูุง ุจุนุฏ ุฅุฏุฎุงู ููุฏ ุงููุฏูุฑ.
        </div>
      </div>

      <hr style="margin:12px 0; border:none; border-top:1px solid #eee;">

      <h3 class="small-text" style="margin-bottom:8px;">ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช (ูููุฏูุฑ ููุท)</h3>
      <div class="row">
        <div class="field" style="flex:0 0 auto;">
          <button class="danger" id="resetAllBtn">๐งจ ูุณุญ ูู ุงูุจูุงูุงุช</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="backupBtn" disabled>๐พ ูุณุฎ ุงุญุชูุงุทู (ูุฑูุจูุง)</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="importBtn" disabled>๐ฅ ุงุณุชูุฑุงุฏ ุงูุจูุงูุงุช (ูุฑูุจูุง)</button>
        </div>
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="exportBtn" disabled>๐ค ุชุตุฏูุฑ ุงูุจูุงูุงุช (ูุฑูุจูุง)</button>
        </div>
      </div>

      <div class="small-text">
        ุฒุฑ <strong>ูุณุญ ูู ุงูุจูุงูุงุช</strong> ููุณุญ ูู ุงููุงุนุจูู ููู ุงููุงุชุดุงุช ููุงุฆููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช (ููุงุณุชุฎุฏุงู ุจุญุฐุฑ ุดุฏูุฏ).<br>
        ุฃุฒุฑุงุฑ ุงููุณุฎ ุงูุงุญุชูุงุทู ูุงูุงุณุชูุฑุงุฏ ูุงูุชุตุฏูุฑ <strong>ุบูุฑ ููุนููุฉ ุญุงูููุง</strong>ุ ููููุนูููุง ุจุนุฏ ูุง ูุถุจุท ููุทู ุญูุธ/ุงุณุชุฑุฌุงุน ุงูุจูุงูุงุช.
      </div>
    </section>

    <section class="card">
      <h2>โน๏ธ ููุงุญุธุงุช ุงูุงุณุชุฎุฏุงู</h2>
      <ul class="small-text">
        <li>ูู ุบูุฑ ุชูุนูู ูุถุน ุงููุฏูุฑุ ุงูุจุฑูุงูุฌ ูู ูุถุน ุงููุดุงูุฏุฉ ููุท.</li>
        <li>ูู ุงูุจูุงูุงุช ูุญููุธุฉ ุฃูููุงูู ูู Firebase Firestoreุ ุชูุฏุฑ ุชูุชุญ ูู ุฃู ุฌูุงุฒ.</li>
        <li>ุงุณุชุฎุฏู ููุชุฑ ุงูุณูุฉ ูุงูุดูุฑ ููุชุญูู ูู ูุชุฑุฉ ุงูุฅุญุตุงุฆูุงุช ููุชูุฑุชูุจ ูุงูุชุญููู ูุงูููุงุฌูุงุช.</li>
      </ul>
    </section>
  </main>

  <script>
    const ADMIN_PIN = "1510"; // ุบูุฑู ูู ุญุงุจุจ

    let isAdmin = false;
    let matchesLogVisible = false;  // ูููุง ูุฎููู ูุฎูู ุงูุชุฑุงุถููุง
    let playersListVisible = false; // ุฌุฏูุฏ: ูุงุฆูุฉ ุงููุงุนุจูู ูุฎููุฉ ุงูุชุฑุงุถููุง
    let db = null;

    let state = {
      players: [], // {id, name, avatar}
      matches: []  // {id, date, winners, losers, createdAt}
    };

    // ===== BONUS (Streak Bonus) =====
    // ูุธูุฑ ุฒุฑ ุงูุจููุต ููุท ุนูุฏูุง ูููู ููุงู ุงุญุชูุงู "ุณุชุฑูู":
    // ุขุฎุฑ ูุงุชุด ูุณุฌู ูุงู ุจููุณ ุงูุฃุฑุจุน ูุงุนุจูู + ููุณ ุชูุณููุฉ ุงููุฑูููู + ููุณ ุงููุฑูู ูุงุฒ.
    let bonusEligible = false;
    let bonusApplied  = false;
    let bonusValue    = 0;
    let bonusSuggested = 0;

    function normTeam(arr){
      return (arr || []).slice().sort();
    }
    function teamsEqual(a,b){
      if(a.length !== b.length) return false;
      for(let i=0;i<a.length;i++) if(a[i]!==b[i]) return false;
      return true;
    }

    function getLatestMatch(){
      if(!state.matches || state.matches.length===0) return null;
      const sorted = [...state.matches].sort((a,b)=>{
        const ta = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
        const tb = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
        if(tb !== ta) return tb - ta;
        return (b.date || "").localeCompare(a.date || "");
      });
      return sorted[0] || null;
    }

    function updateBonusEligibility(){
      const btn = $("bonusBtn");
      if(!btn) return;

      // ุงูุชุฑุงุถููุง: ุบูุฑ ูุชุงุญ
      bonusEligible = false;
      bonusSuggested = 0;

      // ูู ูุด ูุฏูุฑ -> ูุฎูู/ููููู
      if(!isAdmin){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "๐ ุจููุต (ุบูุฑ ูุชุงุญ)";
        return;
      }

      const w1=$("winnerP1")?.value || "";
      const w2=$("winnerP2")?.value || "";
      const l1=$("loserP1")?.value || "";
      const l2=$("loserP2")?.value || "";

      if(!w1 || !w2 || !l1 || !l2){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "๐ ุจููุต (ุบูุฑ ูุชุงุญ)";
        return;
      }

      const chosen=[w1,w2,l1,l2];
      if(new Set(chosen).size < 4){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "๐ ุจููุต (ุบูุฑ ูุชุงุญ)";
        return;
      }

      const latest = getLatestMatch();
      if(!latest){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "๐ ุจููุต (ุบูุฑ ูุชุงุญ)";
        return;
      }

      const curW = normTeam([w1,w2]);
      const curL = normTeam([l1,l2]);

      const lastW = normTeam(latest.winners || []);
      const lastL = normTeam(latest.losers || []);

      // ููุณ ุงูุชูุณููุฉ + ููุณ ุงููุงุฆุฒ = ุงุญุชูุงู ุณุชุฑูู
      if(teamsEqual(curW, lastW) && teamsEqual(curL, lastL)){
        bonusEligible = true;
        const lastBonus = (latest.bonusApplied ? (Number(latest.bonusValue)||0) : 0);
        bonusSuggested = lastBonus + 1;
      }

      if(!bonusEligible){
        bonusApplied = false;
        bonusValue = 0;
        btn.disabled = true;
        btn.classList.remove("bonus-ready");
        btn.textContent = "๐ ุจููุต (ุบูุฑ ูุชุงุญ)";
        return;
      }

      // ูุชุงุญ: ููุนูู ุงูุฒุฑ ููุธููู
      btn.disabled = false;
      btn.classList.add("bonus-ready");

      // ูู ูุณู ูุด ูุชูุนูุ ูุนุฑุถ ุงููููุฉ ุงูููุชุฑุญุฉ
      if(!bonusApplied){
        btn.textContent = `๐ ุฅุถุงูุฉ ุจููุต (+${bonusSuggested})`;
      }else{
        btn.textContent = `๐ ุจููุต ูููุนูู (+${bonusValue})`;
      }
    }

    function toggleBonus(){
      if(!isAdmin) return;
      if(!bonusEligible) return;

      bonusApplied = !bonusApplied;
      if(bonusApplied){
        bonusValue = bonusSuggested || 1;
      }else{
        bonusValue = 0;
      }
      updateBonusEligibility();
    }


    // ูุถุน ุนุฑุถ ุงูุชุฑุชูุจ (ูุฎุชุตุฑ / ุชูุตููู) + ุฅุนุฏุงุฏุงุช ุงููุฑุฒ
    let leaderboardViewMode = "compact"; // "compact" ุฃู "detailed"
    let leaderboardSort = {
      column: "points",   // ุงูุนููุฏ ุงูุงูุชุฑุงุถู ูููุฑุฒ
      direction: "desc"   // "asc" ุฃู "desc"
    };

    function getLeaderboardColumns(){
      if(leaderboardViewMode === "compact"){
        return [
          {key:"rank",   label:"ุงูุชุฑุชูุจ"},
          {key:"name",   label:"ุงููุงุนุจ"},
          {key:"points", label:"ุงูููุงุท"},
          {key:"bonusNet", label:"ุจููุต"},
          {key:"wins",   label:"ููุฒ"},
          {key:"losses", label:"ุฎุณุงุฑุฉ"},
          {key:"matches",label:"ุนุฏุฏ ุงููุงุชุดุงุช"},
          {key:"rate",   label:"% ุงูููุฒ"}
        ];
      } else {
        return [
          {key:"rank",   label:"ุงูุชุฑุชูุจ"},
          {key:"name",   label:"ุงููุงุนุจ"},
          {key:"points", label:"ุงูููุงุท"},
          {key:"bonusNet", label:"ุจููุต"},
          {key:"wins",   label:"ููุฒ"},
          {key:"losses", label:"ุฎุณุงุฑุฉ"},
          {key:"matches",label:"ุนุฏุฏ ุงููุงุชุดุงุช"},
          {key:"rate",   label:"% ุงูููุฒ"},
          {key:"w2",     label:"ุซูุงุฆูุฉ ู"},
          {key:"w3",     label:"ุซูุงุซูุฉ ู"},
          {key:"w4",     label:"ุฑุจุงุนูุฉ ู"},
          {key:"l2",     label:"ุซูุงุฆูุฉ ุฎ"},
          {key:"l3",     label:"ุซูุงุซูุฉ ุฎ"},
          {key:"l4",     label:"ุฑุจุงุนูุฉ ุฎ"}
        ];
      }
    }

    
    function applyLeaderboardSort(rows){
      const col = leaderboardSort.column;
      const dir = leaderboardSort.direction === "asc" ? 1 : -1;

      // โ ูุงุนุฏุฉ ุงูุชุฑุชูุจ ุงูุฃุณุงุณูุฉ ุงููุทููุจุฉ:
      // 1) ุงูููุงุท ุงูููุงุฆูุฉ (Points + Bonus)
      // 2) ุนุฏุฏ ุงูููุฒ
      // 3) ุงูุงุณู
      function sortByFinalPoints(a,b){
        if((b.finalPoints ?? 0) !== (a.finalPoints ?? 0)) return (b.finalPoints - a.finalPoints);
        if((b.wins ?? 0) !== (a.wins ?? 0)) return (b.wins - a.wins);
        return a.name.localeCompare(b.name,"ar");
      }

      // ูู ุงููุณุชุฎุฏู ุจูุนูู ูุฑุฒ ุนูู ุงูููุงุท/ุงูุชุฑุชูุจ -> ูุทุจู ุงููุงุนุฏุฉ ุงูุฃุณุงุณูุฉ
      if(col === "points" || col === "rank"){
        rows.sort(sortByFinalPoints);
        if(dir === -1){
          // desc (ุงูุงูุชุฑุงุถู): ูุง ุดูุก
        } else {
          // asc: ูุนูุณ
          rows.reverse();
        }
        return;
      }

      // ูุฑุฒ ุญุณุจ ุงูุงุณู
      if(col === "name"){
        rows.sort((a,b)=> dir * a.name.localeCompare(b.name,"ar"));
        return;
      }

      // ุจุงูู ุงูุฃุนูุฏุฉ ุงูุฑูููุฉ: ูุฑุฒ ุจุงูุนููุฏ ุซู ุงูุงุณู
      rows.sort((a,b)=>{
        const av = a[col] ?? 0;
        const bv = b[col] ?? 0;
        if(av < bv) return -1 * dir;
        if(av > bv) return  1 * dir;
        // ูุณุฑ ุงูุชุนุงุฏู ุจุงูุงุณู
        return a.name.localeCompare(b.name,"ar");
      });
    }


    function $(id){return document.getElementById(id);}

    // ===== Firebase init =====
    function initFirebase(){
      const firebaseConfig = {
        apiKey: "AIzaSyDmNo5FIHlW6fcZmCh0TVYzjc9NIia_iM8",
        authDomain: "domino-league-c2d94.firebaseapp.com",
        projectId: "domino-league-c2d94",
        storageBucket: "domino-league-c2d94.firebasestorage.app",
        messagingSenderId: "928957805726",
        appId: "1:928957805726:web:d6f7bc867cbfb6c824f78f",
        measurementId: "G-J2TJQD7QQ"
      };

      // ุชุดุบูู Firebase ุจูุณุฎุฉ compat ุงููู ุญุงุทูููุง ูู <script> ููู
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();

      // ุงุณุชูุน ูุฃู ุชุบููุฑุงุช ูู ุงููุงุนุจูู
      db.collection("players").onSnapshot(snapshot => {
        const players = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          players.push({
            id: doc.id,
            name: data.name,
            avatar: data.avatar || null,
            banPeriods: data.banPeriods || []
          });
        });
        state.players = players;
        updatePlayersUI();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateMatchesLog();
        updateBonusEligibility();
        updateChampionsLog();
      });

      // ุงุณุชูุน ูุฃู ุชุบููุฑุงุช ูู ุงููุงุชุดุงุช
      db.collection("matches").onSnapshot(snapshot => {
        const matches = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          matches.push({
            id: doc.id,
            date: data.date || null,
            winners: data.winners || [],
            losers: data.losers || [],
            players: data.players || [],
            createdAt: data.createdAt || null,
            bonusApplied: data.bonusApplied || false,
            bonusValue: Number(data.bonusValue || 0)
          });
        });
        state.matches = matches;
        updateFilterYearOptions();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateHeadToHeadUI(false);
        updateMatchesLog();
        updateChampionsLog();
      });
    }

    // ===== ADMIN =====
    function updateAdminUI(){
      const ids = ["addPlayerBtn","addMatchBtn","resetAllBtn","bonusBtn"];
      ids.forEach(id=>{
        const el=$(id);
        if(el) el.disabled = !isAdmin;
      });
      ["playerName","playerAvatarFile","matchDate","winnerP1","winnerP2","loserP1","loserP2"]
        .forEach(id=>{
          const el=$(id);
          if(el) el.disabled = !isAdmin;
        });

      $("enableAdminBtn").style.display = isAdmin ? "none" : "inline-block";
      $("disableAdminBtn").style.display = isAdmin ? "inline-block" : "none";
      $("adminStatusText").textContent = isAdmin
        ? "ูุถุน ุงููุฏูุฑ ูููุนูู: ูุณููุญ ุจุฅุถุงูุฉ ูุงุนุจูู ูุชุณุฌูู/ุญุฐู ุงููุงุชุดุงุช ููุณุญ ุงูุจูุงูุงุช."
        : "ูุถุน ุงููุดุงูุฏุฉ ููุท: ูุง ูููู ุชุนุฏูู ุงูุจูุงูุงุช ุฅูุง ุจุนุฏ ุฅุฏุฎุงู ููุฏ ุงููุฏูุฑ.";

      // ุนูุดุงู ุฃุฒุฑุงุฑ ุชุนุฏูู ุงููุงุนุจูู ุชุธูุฑ/ุชุฎุชูู ุญุณุจ ูุถุน ุงููุฏูุฑ
      updateMatchesLog();
      updatePlayersUI();
      updateBonusEligibility();
    }

    function enableAdminMode(){
      const pin = prompt("ุฃุฏุฎู ููุฏ ุงููุฏูุฑ:");
      if(pin === null) return;
      if(pin === ADMIN_PIN){
        isAdmin = true;
        alert("ุชู ุชูุนูู ูุถุน ุงููุฏูุฑ.");
      } else {
        alert("ููุฏ ุบูุฑ ุตุญูุญ.");
      }
      updateAdminUI();
    }

    function disableAdminMode(){
      isAdmin = false;
      updateAdminUI();
    }

    // ===== TOGGLE MATCHES LOG =====
    function toggleMatchesLog(){
      const wrapper = $("matchesLogWrapper");
      const btn = $("toggleMatchesLogBtn");
      if(!wrapper || !btn) return;
      matchesLogVisible = !matchesLogVisible;
      wrapper.style.display = matchesLogVisible ? "" : "none";
      btn.textContent = matchesLogVisible ? "๐๏ธ ุฅุฎูุงุก ุงูุณุฌู" : "๐๏ธ ุนุฑุถ ุงูุณุฌู";
    }

    function togglePlayersList(){
      const wrapper = $("playersListWrapper");
      const btn = $("togglePlayersListBtn");
      if(!wrapper || !btn) return;
      playersListVisible = !playersListVisible;
      wrapper.style.display = playersListVisible ? "" : "none";
      btn.textContent = playersListVisible
        ? "๐ฅ ุฅุฎูุงุก ูุงุฆูุฉ ุงููุงุนุจูู"
        : "๐ฅ ุนุฑุถ ูุงุฆูุฉ ุงููุงุนุจูู";
      }

    // ===== PLAYERS =====
    function getPlayerById(id){
      return state.players.find(p=>p.id===id) || null;
    }

    function getPlayerNameById(id){
      const p = getPlayerById(id);
      return p ? p.name : ("ID "+id);
    }


    // ===== BAN / UNBAN helpers =====
    function tsToDate(v){
      if(!v) return null;
      if(typeof v.toDate === "function") return v.toDate();
      if(typeof v.seconds === "number") return new Date(v.seconds * 1000);
      // fallback (string/date)
      return new Date(v);
    }

    function isDateInBanPeriods(dateObj, banPeriods){
      if(!dateObj) return false;
      const t = dateObj.getTime();
      const periods = banPeriods || [];
      return periods.some(p=>{
        const fromD = tsToDate(p.from);
        const toD   = p.to ? tsToDate(p.to) : null;
        if(!fromD) return false;
        const fromT = fromD.getTime();
        const toT   = toD ? toD.getTime() : null;
        return (toT === null) ? (t >= fromT) : (t >= fromT && t <= toT);
      });
    }

    function isPlayerCurrentlyBanned(player){
      const periods = (player && player.banPeriods) ? player.banPeriods : [];
      return periods.some(p => p && p.to == null);
    }

    // โ ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ = ุขุฎุฑ ุชุงุฑูุฎ ููุฌูุฏ ูู ุงููุงุชุดุงุช ุจุนุฏ ุชุทุจูู ุงูููุชุฑ (ููู ูููุดุ ูุณุชุฎุฏู ุชุงุฑูุฎ ุงูููู)
    function getSelectedRangeEndDate(){
      const matches = getFilteredMatches();
      let max = null;
      matches.forEach(m=>{
        if(!m.date) return;
        const d = new Date(m.date + "T23:59:59");
        if(!max || d > max) max = d;
      });
      return max || new Date();
    }

    // โ ุฅุธูุงุฑ ุงููุงุนุจ ูู ุงูุฅุญุตุงุฆูุงุช ูุนุชูุฏ ุนูู "ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ"
    function shouldShowPlayerForSelectedRange(player, rangeEndDate){
      return !isDateInBanPeriods(rangeEndDate, player.banPeriods || []);
    }


    
    function updatePlayersUI(){
      // ุชุฑุชูุจ ุงููุงุนุจูู ุฃุจุฌุฏููุง ุจุงูุงุณู
      const playersAll = [...state.players].sort((a,b)=> a.name.localeCompare(b.name,"ar"));

      // โ ุชุณุฌูู ูุงุชุดุงุช ุฌุฏูุฏุฉ: ููููุน ุงููุงุนุจ ุงููุญุธูุฑ ุญุงูููุง
      const playersForMatch = playersAll.filter(p => !isPlayerCurrentlyBanned(p));

      // โ ุงูุชุญูููุงุช/ุงูุฅุญุตุงุฆูุงุช: ูุนุชูุฏ ุนูู ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ
      const rangeEnd = getSelectedRangeEndDate();
      const playersForAnalytics = playersAll.filter(p => shouldShowPlayerForSelectedRange(p, rangeEnd));

      const scoreSelectIds = ["winnerP1","winnerP2","loserP1","loserP2"];
      const analyticsSelectIds = [
        "playerDetailsSelect",
        "h2hP1",
        "h2hP2",
        "h2hT1P1",
        "h2hT1P2",
        "h2hT2P1",
        "h2hT2P2"
      ];

      // ุชุญุฏูุซ ุงูู select ุจุชุงุนุฉ ุชุณุฌูู ุงููุงุชุดุงุช
      scoreSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        const current = sel.value;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="ุงุฎุชุฑ ูุงุนุจ...";
        sel.appendChild(opt);

        playersForMatch.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });

        // ุญุงูู ุชุญุงูุธ ุนูู ุงูุงุฎุชูุงุฑ ูู ูุงุฒุงู ูุชุงุญ
        if(current && playersForMatch.some(p=>p.id===current)) sel.value=current;
      });

      // ุชุญุฏูุซ ุงูู select ุจุชุงุนุฉ ุงูุชุญููู ูุงูููุงุฌูุงุช
      analyticsSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        const current = sel.value;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="ุงุฎุชุฑ ูุงุนุจ...";
        sel.appendChild(opt);

        playersForAnalytics.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });

        if(current && playersForAnalytics.some(p=>p.id===current)) sel.value=current;
        else if(id === "playerDetailsSelect"){
          // ูู ุงููุงุนุจ ุงููุฎุชุงุฑ ุงุฎุชูู ุจุณุจุจ ุงูุญุธุฑ/ุงููุชุฑุฉุ ูุฎูู ุงูุชุญููู
          updatePlayerDetailsUI();
        }
      });

      // ุงูุณุทุฑ ุงููุตู ุชุญุช ูุณู ุฅุฏุงุฑุฉ ุงููุงุนุจูู
      const info = $("playersListInfo");
      if(info){
        if(playersAll.length===0){
          info.textContent="ูุง ููุฌุฏ ูุงุนุจูู ุญุชู ุงูุขู. ุฃุถูู ุจุนุถ ุงููุงุนุจูู ุฃููุงู.";
        } else {
          info.textContent="ุงููุงุนุจูู ุงููุณุฌูููู: " + playersAll.map(p=>p.name).join("ุ ");
        }
      }

      // ุฌุฏูู ุงููุงุนุจูู (ุนุฑุถ + ุชุนุฏูู + ุญุธุฑ/ุญุฐู)
      const tbody = $("playersTableBody");
      if(!tbody) return;
      tbody.innerHTML = "";

      if(playersAll.length===0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "ูุง ููุฌุฏ ูุงุนุจูู ุญุชู ุงูุขู.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      playersAll.forEach((p, idx)=>{
        const tr = document.createElement("tr");

        // ุฑูู
        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        // ุงููุงุนุจ (ุตูุฑุฉ + ุงุณู + ุญุงูุฉ ุงูุญุธุฑ)
        const tdPlayer = document.createElement("td");
        const wrapper = document.createElement("div");
        wrapper.className = "player-cell";

        if(p.avatar){
          const img = document.createElement("img");
          img.src = p.avatar;
          img.className = "player-avatar";
          wrapper.appendChild(img);
        }

        const span = document.createElement("span");
        span.textContent = p.name;
        wrapper.appendChild(span);

        // Badge ููุญุงูุฉ
        const bannedNow = isPlayerCurrentlyBanned(p);
        const badge = document.createElement("span");
        badge.style.fontSize = "0.75rem";
        badge.style.padding = "2px 6px";
        badge.style.borderRadius = "999px";
        badge.style.border = "1px solid #ddd";
        badge.style.marginRight = "6px";
        badge.textContent = bannedNow ? "ูุญุธูุฑ" : "ูุดุท";
        wrapper.appendChild(badge);

        tdPlayer.appendChild(wrapper);
        tr.appendChild(tdPlayer);

        // ุงูุฅุฌุฑุงุกุงุช
        const tdActions = document.createElement("td");
        if(isAdmin){
          // ุชุนุฏูู ุงูุงุณู
          const editBtn = document.createElement("button");
          editBtn.textContent = "โ๏ธ ุชุนุฏูู ุงูุงุณู";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", ()=>editPlayerName(p.id, p.name));
          tdActions.appendChild(editBtn);

          // ุชุนุฏูู ุงูุตูุฑุฉ
          const imgBtn = document.createElement("button");
          imgBtn.textContent = "๐ผ ุตูุฑุฉ";
          imgBtn.className = "btn-small";
          imgBtn.style.marginRight = "4px";

          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/*";
          fileInput.style.display = "none";
          fileInput.addEventListener("change", ()=>{
            const file = fileInput.files[0];
            if(file){
              changePlayerAvatar(p.id, file);
            }
            fileInput.value = "";
          });
          imgBtn.addEventListener("click", ()=>fileInput.click());

          tdActions.appendChild(imgBtn);
          tdActions.appendChild(fileInput);

          // ุญุธุฑ / ูู ุงูุญุธุฑ
          const banBtn = document.createElement("button");
          banBtn.className = "btn-small";
          banBtn.style.marginRight = "4px";
          banBtn.textContent = bannedNow ? "โ ูู ุงูุญุธุฑ" : "โ ุญุธุฑ";
          banBtn.addEventListener("click", async ()=>{
            if(bannedNow){
              if(!confirm(`ูู ุญุธุฑ ุงููุงุนุจ "${p.name}"ุ`)) return;
              await unbanPlayer(p.id);
            } else {
              if(!confirm(`ุญุธุฑ ุงููุงุนุจ "${p.name}"ุ\n\nูู ูุธูุฑ ูู ุชุณุฌูู ุงููุงุชุดุงุช ุงูุฌุฏูุฏุฉุ ููู ูุธูุฑ ูู ุงูุฅุญุตุงุฆูุงุช ุนูุฏูุง ุชูุน ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ ุฏุงุฎู ูุชุฑุฉ ุงูุญุธุฑ.`)) return;
              await banPlayer(p.id);
            }
          });
          tdActions.appendChild(banBtn);

          // ุญุฐู ูุงุนุจ (ููุงุฆู)
          const delBtn = document.createElement("button");
          delBtn.textContent = "๐ ุญุฐู";
          delBtn.className = "danger btn-small";
          delBtn.addEventListener("click", ()=> deletePlayerAndMatches(p.id, p.name));
          tdActions.appendChild(delBtn);

        } else {
          tdActions.textContent = "-";
        }

        tr.appendChild(tdActions);
        tbody.appendChild(tr);
      });

      // ุชุญุฏูุซ ุฅููุงููุฉ ุงูุจููุต ุจุนุฏ ุชุบููุฑ ุงูููุงุฆู
      updateBonusEligibility();
    }


    function addPlayer(){
      if(!isAdmin || !db) return;
      const nameInput = $("playerName");
      const fileInput = $("playerAvatarFile");
      const name = nameInput.value.trim();
      if(!name){ alert("ุงูุชุจ ุงุณู ุงููุงุนุจ ุฃููุงู."); return; }

      const finishAdd = (avatarData)=>{
        db.collection("players").add({
          name,
          avatar: avatarData || null,
          banPeriods: []
        }).then(()=>{
          nameInput.value="";
          fileInput.value="";
        }).catch(err=>{
          console.error(err);
          alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ุฅุถุงูุฉ ุงููุงุนุจ.");
        });
      };

      const file = fileInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e => finishAdd(e.target.result);
        reader.readAsDataURL(file);
      } else {
        finishAdd(null);
      }
    }

    function editPlayerName(playerId, currentName){
      if(!isAdmin || !db) return;
      const newName = prompt("ุงูุชุจ ุงูุงุณู ุงูุฌุฏูุฏ ูููุงุนุจ:", currentName || "");
      if(newName === null) return; // ุงููุณุชุฎุฏู ูุบู
      const trimmed = newName.trim();
      if(!trimmed){
        alert("ุงูุงุณู ูุง ูููู ุฃู ูููู ูุงุฑุบ.");
        return;
      }
      db.collection("players").doc(playerId).update({ name: trimmed })
        .catch(err=>{
          console.error(err);
          alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ุชุนุฏูู ุงุณู ุงููุงุนุจ.");
        });
    }

    function changePlayerAvatar(playerId, file){
      if(!isAdmin || !db || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const avatarData = e.target.result;
        db.collection("players").doc(playerId).update({ avatar: avatarData })
          .catch(err=>{
            console.error(err);
            alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ุชุญุฏูุซ ุตูุฑุฉ ุงููุงุนุจ.");
          });
      };
      reader.readAsDataURL(file);
    }

    // ===== ADMIN: Delete Player (delete player + all matches retroactively) =====
    async function deletePlayerAndMatches(playerId, playerName){
      if(!isAdmin || !db) return;

      const typed = prompt(
        `โ๏ธ ุญุฐู ูุงุนุจ ููุงุฆู\n\nุงููุงุนุจ: ${playerName}\nุณูุชู ุญุฐู ุงููุงุนุจ + ุญุฐู ูู ุงููุงุชุดุงุช ุงูุชู ุดุงุฑู ูููุง ุจุฃุซุฑ ุฑุฌุนู.\n\nุงูุชุจ DELETE ููุชุฃููุฏ:`
      );
      if(typed !== "DELETE") return;

      const typedName = prompt(`ุงูุชุจ ุงุณู ุงููุงุนุจ ุจุงูุถุจุท ููุชุฃููุฏ:\n${playerName}`);
      if(typedName !== playerName) return;

      // ูุฌูุน ูู ุงููุงุชุดุงุช ุงูุชู ุดุงุฑู ูููุง ุงููุงุนุจ (ุญุชู ูู ุงูุฏููููููุชุงุช ุงููุฏููุฉ ูุง ุชุญุชูู players[])
      const snap = await db.collection("matches").get();
      const toDelete = [];
      snap.forEach(doc=>{
        const d = doc.data() || {};
        const w = d.winners || [];
        const l = d.losers  || [];
        const p = d.players || [];
        if(w.includes(playerId) || l.includes(playerId) || p.includes(playerId)){
          toDelete.push(doc.ref);
        }
      });

      // ุญุฐู ุงููุงุชุดุงุช ูู ุฏูุนุงุช
      let deletedCount = 0;
      for(let i=0;i<toDelete.length;i+=400){
        const batch = db.batch();
        toDelete.slice(i,i+400).forEach(ref=> batch.delete(ref));
        await batch.commit();
        deletedCount += Math.min(400, toDelete.length - i);
      }

      // ุญุฐู ุงููุงุนุจ
      await db.collection("players").doc(playerId).delete();

      alert(`โ ุชู ุญุฐู ุงููุงุนุจ "${playerName}" ูุญุฐู ${deletedCount} ูุงุชุด(ุงุช) ูุฑุชุจุทุฉ ุจู.`);
      // ุงูู onSnapshot ููุชููู ุงูุชุญุฏูุซ
    }

    // ===== ADMIN: Ban / Unban =====
    async function banPlayer(playerId){
      if(!isAdmin || !db) return;
      const ref = db.collection("players").doc(playerId);
      const now = firebase.firestore.Timestamp.now();

      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(ref);
        if(!doc.exists) return;
        const data = doc.data() || {};
        const periods = (data.banPeriods || []).slice();

        // ูู ุจุงููุนู ูุญุธูุฑ ุญุงูููุง
        if(periods.some(p => p && p.to == null)) return;

        periods.push({ from: now, to: null });
        tx.update(ref, { banPeriods: periods });
      });
    }

    async function unbanPlayer(playerId){
      if(!isAdmin || !db) return;
      const ref = db.collection("players").doc(playerId);
      const now = firebase.firestore.Timestamp.now();

      await db.runTransaction(async (tx)=>{
        const doc = await tx.get(ref);
        if(!doc.exists) return;
        const data = doc.data() || {};
        const periods = (data.banPeriods || []).slice();

        // ุงููู ุฃุญุฏุซ ูุชุฑุฉ ุญุธุฑ ููุชูุญุฉ
        for(let i=periods.length-1;i>=0;i--){
          if(periods[i] && periods[i].to == null){
            periods[i] = { ...periods[i], to: now };
            break;
          }
        }
        tx.update(ref, { banPeriods: periods });
      });
    }


      // ===== MATCHES ===== }

    // ===== MATCHES =====
    function addMatch(){
      if(!isAdmin || !db) return;
      if(state.players.length<4){ alert("ูุงุฒู ูููู ููู ุนูู ุงูุฃูู 4 ูุงุนุจูู."); return; }
      const w1=$("winnerP1").value;
      const w2=$("winnerP2").value;
      const l1=$("loserP1").value;
      const l2=$("loserP2").value;
      if(!w1||!w2||!l1||!l2){ alert("ุงุฎุชุฑ ูู ุงููุงุนุจูู."); return; }
      const chosen=[w1,w2,l1,l2];
      if(new Set(chosen).size<4){ alert("ููุณ ุงููุงุนุจ ูุง ูููู ุฃู ูููู ูู ุฃูุซุฑ ูู ููุงู."); return; }

      // โ ููููุน ุชุณุฌูู ูุงุชุด ุฌุฏูุฏ ูู ุฃู ูุงุนุจ ูุญุธูุฑ ุญุงูููุง
      const now = new Date();
      for(const pid of chosen){
        const pl = getPlayerById(pid);
        if(pl && isPlayerCurrentlyBanned(pl)){
          alert(`ูุง ูููู ุชุณุฌูู ุงููุงุชุด ูุฃู ุงููุงุนุจ "${pl.name}" ูุญุธูุฑ ุญุงูููุง.`);
          return;
        }
      }

      // ุชุญุฏูุซ ุญุงูุฉ ุงูุจููุต ูุจู ุงูุญูุธ
      updateBonusEligibility();
      if(bonusApplied && !bonusEligible){
        bonusApplied = false; bonusValue = 0;
      }

      let dateStr=$("matchDate").value;
      if(!dateStr){
        const now=new Date();
        const y=now.getFullYear();
        const m=String(now.getMonth()+1).padStart(2,"0");
        const d=String(now.getDate()).padStart(2,"0");
        dateStr=`${y}-${m}-${d}`;
      }

      db.collection("matches").add({
        date: dateStr,
        winners:[w1,w2],
        losers:[l1,l2],
        players:[w1,w2,l1,l2],
        createdAt: firebase.firestore.FieldValue.serverTimestamp(),
        bonusApplied: bonusApplied || false,
        bonusValue: bonusApplied ? (Number(bonusValue)||0) : 0
      }).then(()=>{
        $("matchDate").value="";
        ["winnerP1","winnerP2","loserP1","loserP2"].forEach(id=>$(id).value="");
        bonusApplied = false;
        bonusValue = 0;
        updateBonusEligibility();
      }).catch(err=>{
        console.error(err);
        alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ุญูุธ ุงููุงุชุด.");
      });
    }

    function resetAll(){
      if(!isAdmin || !db) return;
      if(!confirm("ุณูุชู ูุณุญ ูู ุงููุงุนุจูู ูุงููุชุงุฆุฌ ููุงุฆููุง ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช. ูุชุฃูุฏุ")) return;

      // ูุณุญ ูู ุงููุงุชุดุงุช
      db.collection("matches").get().then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).then(()=>{
        return db.collection("players").get();
      }).then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).catch(err=>{
        console.error(err);
        alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ูุณุญ ุงูุจูุงูุงุช.");
      });
    }
    // ===== MATCHES LOG (ุนุฑุถ + ุญุฐู) =====
    function deleteMatchById(id){
      if(!isAdmin || !db) return;
      if(!confirm("ูู ุชุฑูุฏ ุจุงูุชุฃููุฏ ุญุฐู ูุฐุง ุงููุงุชุดุ")) return;
      db.collection("matches").doc(id).delete().catch(err=>{
        console.error(err);
        alert("ุญุตู ุฎุทุฃ ุฃุซูุงุก ุญุฐู ุงููุงุชุด.");
      });
    }

    
    // ===== CHAMPIONS LOG (Monthly podiums per selected year) =====
    function updateChampionsLog(){
      const yearVal = $("filterYear")?.value || "all";
      const monthVal = $("filterMonth")?.value || "all";
      const wrapper = $("championsLogWrapper");
      const hint = $("championsLogHint");
      const title = $("championsLogTitle");
      const head = $("championsLogHead");
      const body = $("championsLogBody");
      const extra = $("championsLogExtra");
      const card = $("championsLogCard");

      if(!wrapper || !head || !body || !title || !hint) return;
      if(!card) return;
      if(extra) extra.innerHTML = "";

      if(yearVal === "all"){
        wrapper.style.display = "none";
        hint.style.display = "block";
        head.innerHTML = "";
        body.innerHTML = "";
        return;
      }

      const year = Number(yearVal);
      hint.style.display = "none";
      wrapper.style.display = "block";
      title.textContent = `ุณุฌู ุงูุฃุจุทุงู ูุณูุฉ ${year} โ ุงูุชุฑุชูุจ ุญุณุจ ุนุฏุฏ ๐ฅ ุซู ๐ฅ ุซู ๐ฅ`;

      const monthNames = ["ููุงูุฑ","ูุจุฑุงูุฑ","ูุงุฑุณ","ุฃุจุฑูู","ูุงูู","ููููู","ููููู","ุฃุบุณุทุณ","ุณุจุชูุจุฑ","ุฃูุชูุจุฑ","ููููุจุฑ","ุฏูุณูุจุฑ"];

      // Helper: end-of-month date (used for ban visibility rule)
      function endOfMonthDate(y, m){ // m:1-12
        const d = new Date(y, m, 0); // last day of month
        d.setHours(23,59,59,999);
        return d;
      }

      function getLastMonthWithMatchesInYear(y){
        let maxM = null;
        state.matches.forEach(m=>{
          if(!m.date) return;
          const yy = Number(m.date.slice(0,4));
          if(yy !== y) return;
          const mm = Number(m.date.slice(5,7));
          if(!maxM || mm > maxM) maxM = mm;
        });
        return maxM;
      }

      function computeChampionNameForMonth(y, m){
        if(!y || !m) return null;
        const mMatches = state.matches.filter(mm=>{
          if(!mm.date) return false;
          const yy = Number(mm.date.slice(0,4));
          const mo = Number(mm.date.slice(5,7));
          return yy===y && mo===m;
        });
        if(mMatches.length === 0) return null;
        const rangeEnd = endOfMonthDate(y, m);

        const rows = [];
        state.players.forEach(p=>{
          if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
          const s = computePlayerFullStats(p.id, mMatches);
          if(s.totalMatches === 0) return;
          rows.push({
            id: p.id,
            name: p.name,
            wins: s.wins || 0,
            finalPoints: (s.points || 0) + (s.bonusNet || 0)
          });
        });
        if(rows.length === 0) return null;
        rows.sort((a,b)=>{
          if(b.finalPoints !== a.finalPoints) return b.finalPoints - a.finalPoints;
          if(b.wins !== a.wins) return b.wins - a.wins;
          return (a.name||"").localeCompare(b.name||"", "ar");
        });
        return rows[0]?.name || null;
      }

      function computeChampionNameForYear(y){
        if(!y) return null;
        const yMatches = state.matches.filter(mm=>{
          if(!mm.date) return false;
          const yy = Number(mm.date.slice(0,4));
          return yy===y;
        });
        if(yMatches.length === 0) return null;

        const rangeEnd = endOfMonthDate(y, 12); // end of year

        const rows = [];
        state.players.forEach(p=>{
          if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
          const s = computePlayerFullStats(p.id, yMatches);
          if((s.totalMatches || 0) === 0) return;
          rows.push({
            id: p.id,
            name: p.name,
            wins: s.wins || 0,
            finalPoints: (s.points || 0) + (s.bonusNet || 0)
          });
        });
        if(rows.length === 0) return null;
        rows.sort((a,b)=>{
          if(b.finalPoints !== a.finalPoints) return b.finalPoints - a.finalPoints;
          if(b.wins !== a.wins) return b.wins - a.wins;
          return (a.name||"").localeCompare(b.name||"", "ar");
        });
        return rows[0]?.name || null;
      }

      // Per-player summary
      const byId = new Map();
      state.players.forEach(p=>{
        byId.set(p.id, {
          id: p.id,
          name: p.name,
          first: 0,
          second: 0,
          third: 0,
          best: null,
          worst: null
        });
      });

      // For each month, compute standings and podium
      for(let month=1; month<=12; month++){
        const mMatches = state.matches.filter(m=>{
          if(!m.date) return false;
          const y = Number(m.date.slice(0,4));
          const mo = Number(m.date.slice(5,7));
          return y===year && mo===month;
        });

        if(mMatches.length === 0) continue;

        const rangeEnd = endOfMonthDate(year, month);

        // Build monthly rows using same logic as leaderboard
        const rows = [];
        state.players.forEach(p=>{
          if(!shouldShowPlayerForSelectedRange(p, rangeEnd)) return;
          const s = computePlayerFullStats(p.id, mMatches);
          if(s.totalMatches === 0) return;
          rows.push({
            id: p.id,
            name: p.name,
            wins: s.wins || 0,
            finalPoints: (s.points || 0) + (s.bonusNet || 0)
          });
        });

        if(rows.length === 0) continue;

        // Sort: final points desc, wins desc, name asc
        rows.sort((a,b)=>{
          if(b.finalPoints !== a.finalPoints) return b.finalPoints - a.finalPoints;
          if(b.wins !== a.wins) return b.wins - a.wins;
          return (a.name||"").localeCompare(b.name||"", "ar");
        });

        // Update best/worst ranks for participants
        rows.forEach((r, i)=>{
          const rec = byId.get(r.id);
          if(!rec) return;
          const rank = i+1;
          if(rec.best === null || rank < rec.best) rec.best = rank;
          if(rec.worst === null || rank > rec.worst) rec.worst = rank;
        });

        // Podium counts
        const top1 = rows[0]?.id || null;
        const top2 = rows[1]?.id || null;
        const top3 = rows[2]?.id || null;

        if(top1 && byId.get(top1)) byId.get(top1).first += 1;
        if(top2 && byId.get(top2)) byId.get(top2).second += 1;
        if(top3 && byId.get(top3)) byId.get(top3).third += 1;
      }

      // Build final table rows (only players with at least one podium or at least one participation)
      const summary = Array.from(byId.values()).filter(r=>{
        const hasPodium = (r.first+r.second+r.third) > 0;
        const hasRanks = r.best !== null;
        return hasPodium || hasRanks;
      });

      // Sort by ๐ฅ then ๐ฅ then ๐ฅ then name
      summary.sort((a,b)=>{
        if(b.first !== a.first) return b.first - a.first;
        if(b.second !== a.second) return b.second - a.second;
        if(b.third !== a.third) return b.third - a.third;
        return (a.name||"").localeCompare(b.name||"", "ar");
      });

      // Render
      head.innerHTML = "";
      body.innerHTML = "";

      const trh = document.createElement("tr");
      [
        {label:"ุงููุงุนุจ", key:"name"},
        {label:"๐ฅ1", key:"first"},
        {label:"๐ฅ2", key:"second"},
        {label:"๐ฅ3", key:"third"},
        {label:"ุฃูุถู ูุฑูุฒ", key:"best"},
        {label:"ุฃุณูุฃ ูุฑูุฒ", key:"worst"},
      ].forEach(c=>{
        const th = document.createElement("th");
        th.textContent = c.label;
        trh.appendChild(th);
      });
      head.appendChild(trh);

      if(summary.length === 0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 6;
        td.textContent = "ูุง ุชูุฌุฏ ุจูุงูุงุช ูุงููุฉ ููุฐู ุงูุณูุฉ.";
        tr.appendChild(td);
        body.appendChild(tr);

        // Extra (title holders) based on filter end
        if(extra){
          const endM = (monthVal !== "all") ? Number(monthVal) : (getLastMonthWithMatchesInYear(year) || 12);
          const prevYearChampion = computeChampionNameForYear(year-1);
          const prevMonth = (endM === 1) ? {y: year-1, m: 12} : {y: year, m: endM-1};
          const prevMonthChampion = computeChampionNameForMonth(prevMonth.y, prevMonth.m);

          extra.innerHTML = `
            <div>๐ ุญุงูู ููุจ ุงุฎุฑ ุณูุฉ (<b>${year-1}</b>): <b>${prevYearChampion || "-"}</b></div>
            <div>๐ ุญุงูู ููุจ ุงุฎุฑ ุดูุฑ (<b>${monthNames[prevMonth.m-1]}</b> ${prevMonth.y}): <b>${prevMonthChampion || "-"}</b></div>
          `;
        }
        return;
      }

      summary.forEach(r=>{
        const tr = document.createElement("tr");

        const nameTd = document.createElement("td");
        nameTd.textContent = r.name || "-";
        tr.appendChild(nameTd);

        const td1 = document.createElement("td"); td1.textContent = r.first; tr.appendChild(td1);
        const td2 = document.createElement("td"); td2.textContent = r.second; tr.appendChild(td2);
        const td3 = document.createElement("td"); td3.textContent = r.third; tr.appendChild(td3);

        const bestTd = document.createElement("td"); bestTd.textContent = (r.best===null? "-" : r.best); tr.appendChild(bestTd);
        const worstTd= document.createElement("td"); worstTd.textContent= (r.worst===null? "-" : r.worst); tr.appendChild(worstTd);

        body.appendChild(tr);
      });

      // Extra (title holders) based on filter end
      if(extra){
        const endM = (monthVal !== "all") ? Number(monthVal) : (getLastMonthWithMatchesInYear(year) || 12);
        const prevYearChampion = computeChampionNameForYear(year-1);
        const prevMonth = (endM === 1) ? {y: year-1, m: 12} : {y: year, m: endM-1};
        const prevMonthChampion = computeChampionNameForMonth(prevMonth.y, prevMonth.m);

        extra.innerHTML = `
          <div>๐ ุญุงูู ููุจ ุงุฎุฑ ุณูุฉ (<b>${year-1}</b>): <b>${prevYearChampion || "-"}</b></div>
          <div>๐ ุญุงูู ููุจ ุงุฎุฑ ุดูุฑ (<b>${monthNames[prevMonth.m-1]}</b> ${prevMonth.y}): <b>${prevMonthChampion || "-"}</b></div>
        `;
      }
    }


function updateMatchesLog(){
      const tbody = $("matchesLogBody");
      if(!tbody) return;
      tbody.innerHTML = "";

      // ูุณุชุฎุฏู ููุณ ุงูููุชุฑ ุจุชุงุน ุงูุณูุฉ/ุงูุดูุฑ
      const matches = getFilteredMatches();

      if(matches.length === 0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 5;
        td.textContent = "ูุง ููุฌุฏ ุฃู ูุงุชุดุงุช ูุณุฌูุฉ ูู ูุฐู ุงููุชุฑุฉ.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      // ุฃุญุฏุซ ูุงุชุด ูู ุงูุฃุนูู ุฏุงุฎู ุงููุชุฑุฉ ุงููุญุฏุฏุฉ
      const sorted = [...matches].sort((a,b)=>{
        const ta = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
        const tb = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
        if(tb !== ta) return tb - ta;
        return (b.date || "").localeCompare(a.date || "");
      });

      sorted.forEach((m,idx)=>{
        const tr = document.createElement("tr");

        tr.appendChild(createCell(idx + 1));
        const dateText = (m.date || "-") + (m.bonusApplied ? ` ๐+${Number(m.bonusValue||0)}` : "");
        tr.appendChild(createCell(dateText));
        tr.appendChild(createPlayersListCell(m.winners || []));
        tr.appendChild(createPlayersListCell(m.losers || []));

        const actionTd = document.createElement("td");
        if(isAdmin){
          const btn = document.createElement("button");
          btn.textContent = "๐ ุญุฐู";
          btn.className = "danger btn-small";
          btn.addEventListener("click", ()=> deleteMatchById(m.id));
          actionTd.appendChild(btn);
        } else {
          actionTd.textContent = "-";
        }
        tr.appendChild(actionTd);

        tbody.appendChild(tr);
      });
    }

    // ===== FILTER YEAR/MONTH =====
    function updateFilterYearOptions(){
      const sel = $("filterYear");
      if(!sel) return;
      const yearsSet = new Set();
      state.matches.forEach(m=>{
        if(m.date) yearsSet.add(m.date.slice(0,4));
      });
      const current = sel.value || "all";
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value="all"; optAll.textContent="ูู ุงูุณููุงุช";
      sel.appendChild(optAll);
      Array.from(yearsSet).sort().forEach(y=>{
        const o=document.createElement("option");
        o.value=y; o.textContent=y;
        sel.appendChild(o);
      });
      if(current && (current==="all" || yearsSet.has(current))) sel.value=current;
      else sel.value="all";
    }

    function getFilterLabel(yearVal, monthVal){
      const monthNames = ["ููุงูุฑ","ูุจุฑุงูุฑ","ูุงุฑุณ","ุฃุจุฑูู","ูุงูู","ููููู","ููููู","ุฃุบุณุทุณ","ุณุจุชูุจุฑ","ุฃูุชูุจุฑ","ููููุจุฑ","ุฏูุณูุจุฑ"];
      if(yearVal !== "all" && monthVal !== "all"){
        return "ุงููุชุฑุฉ: " + monthNames[Number(monthVal)-1] + " " + yearVal;
      } else if(yearVal !== "all"){
        return "ุงููุชุฑุฉ: ุณูุฉ " + yearVal;
      } else if(monthVal !== "all"){
        return "ุงููุชุฑุฉ: ุดูุฑ " + monthNames[Number(monthVal)-1] + " ูู ูู ุงูุณููุงุช.";
      }
      return "ุงููุชุฑุฉ: ูู ุงูููุช.";
    }

    function getFilteredMatches(){
      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      let filtered = state.matches;

      if(yearVal !== "all"){
        const y = Number(yearVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(0,4)) === y);
        if(monthVal !== "all"){
          const mo = Number(monthVal);
          filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
        }
      } else if(monthVal !== "all"){
        const mo = Number(monthVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
      }
      return filtered;
    }

    function createCell(text){
      const td=document.createElement("td");
      td.textContent=text;
      return td;
    }

    function createPlayerCellTd(playerId){
      const td=document.createElement("td");
      const p=getPlayerById(playerId);
      if(!p){ td.textContent="ุบูุฑ ูุนุฑูู"; return td; }
      const wrapper=document.createElement("div");
      wrapper.className="player-cell";
      if(p.avatar){
        const img=document.createElement("img");
        img.src=p.avatar;
        img.className="player-avatar";
        wrapper.appendChild(img);
      }
      const span=document.createElement("span");
      span.textContent=p.name;
      wrapper.appendChild(span);
      td.appendChild(wrapper);
      return td;
    }

    function createPlayersListCell(ids){
      const td=document.createElement("td");
      ids.forEach((id,idx)=>{
        if(idx>0) td.appendChild(document.createTextNode(" + "));
        const p=getPlayerById(id);
        const wrapper=document.createElement("span");
        wrapper.className="player-cell";
        if(p && p.avatar){
          const img=document.createElement("img");
          img.src=p.avatar;
          img.className="player-avatar";
          wrapper.appendChild(img);
        }
        const span=document.createElement("span");
        span.textContent=p ? p.name : ("ID "+id);
        wrapper.appendChild(span);
        td.appendChild(wrapper);
      });
      return td;
    }

    // ===== LEADERBOARD =====
    function updateLeaderboard(){
      const matches = getFilteredMatches();
      const yearVal  = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      $("currentFilterLabel").textContent = getFilterLabel(yearVal, monthVal);

      const rows = [];

      // ูุณุชุฎุฏู ููุณ ููุทู ุชุญููู ุงููุงุนุจ ุงููุงุญุฏ ููู ูุงุนุจ
      state.players.forEach(p => {
        // โ ุฅุฎูุงุก ุงููุงุนุจ ูู ุงูุฅุญุตุงุฆูุงุช ูู ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉ ุชูุน ุฏุงุฎู ูุชุฑุฉ ุงูุญุธุฑ
        if(!shouldShowPlayerForSelectedRange(p, getSelectedRangeEndDate())) return;

        const s = computePlayerFullStats(p.id, matches);

        // ูู ุงููุงุนุจ ูุง ูุนุจุด ููุง ูุงุชุด ูู ุงููุชุฑุฉ ุฏูุ ุจูุฎูููู ูู ุงูุฌุฏูู
        if(s.totalMatches === 0) return;

        rows.push({
          id:       p.id,
          name:     p.name,
          wins:     s.wins,
          losses:   s.losses,
          matches:  s.totalMatches,
          basePoints: (s.wins - s.losses),
          finalPoints: (s.wins - s.losses) + (s.bonusNet || 0),
          points:   (s.wins - s.losses) + (s.bonusNet || 0),
          bonusPlus: s.bonusPlus || 0,
          bonusMinus: s.bonusMinus || 0,
          bonusNet: s.bonusNet || 0,
          rate:     s.winRate,
          // ุงูุฃูุงู ุงููู ูููุง 2 / 3 / 4+ ููุฒ
          w2:       s.daysWin2,
          w3:       s.daysWin3,
          w4:       s.daysWin4plus,
          // ุงูุฃูุงู ุงููู ูููุง 2 / 3 / 4+ ุฎุณุงุฑุฉ
          l2:       s.daysLose2,
          l3:       s.daysLose3,
          l4:       s.daysLose4plus
        });
      });

      const cols = getLeaderboardColumns();

      // ูุทุจูู ุฅุนุฏุงุฏุงุช ุงููุฑุฒ ุงูุญุงููุฉ
      applyLeaderboardSort(rows);

      // ุฑุฃุณ ุงูุฌุฏูู
      const thead = $("leaderboardHead");
      thead.innerHTML = "";
      const headerTr = document.createElement("tr");

      cols.forEach(col => {
        const th = document.createElement("th");
        th.textContent = col.label;
        th.classList.add("sortable");
        th.dataset.col = col.key;

        const arrow = document.createElement("span");
        arrow.className = "sort-arrow";
        if (leaderboardSort.column === col.key) {
          arrow.textContent = leaderboardSort.direction === "asc" ? "โฒ" : "โผ";
        } else {
          arrow.textContent = "โ";
        }

        th.appendChild(document.createTextNode(" "));
        th.appendChild(arrow);

        th.addEventListener("click", () => {
          if (leaderboardSort.column === col.key) {
            leaderboardSort.direction =
              leaderboardSort.direction === "asc" ? "desc" : "asc";
          } else {
            leaderboardSort.column   = col.key;
            leaderboardSort.direction = (col.key === "name") ? "asc" : "desc";
          }
          updateLeaderboard();
        });

        headerTr.appendChild(th);
      });

      thead.appendChild(headerTr);

      // ุฌุณู ุงูุฌุฏูู
      const tbody = $("leaderboardBody");
      tbody.innerHTML = "";

      if (rows.length === 0) {
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = cols.length;
        td.textContent = "ูุง ุชูุฌุฏ ูุชุงุฆุฌ ุจุนุฏ ูู ูุฐู ุงููุชุฑุฉ.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx) => {
        const tr = document.createElement("tr");
        r.rank = idx + 1; // ุชุฑุชูุจ ุงููุงุนุจ ุจุนุฏ ุงููุฑุฒ

        cols.forEach(col => {
          if (col.key === "name") {
            // ุฎููุฉ ุงููุงุนุจ (ุตูุฑุฉ + ุงุณู)
            tr.appendChild(createPlayerCellTd(r.id));
          } else {
            let value;
            if (col.key === "rate") {
              value = r.rate.toFixed(1) + " ูช";
            } else if (col.key === "rank") {
              value = r.rank;
            } else {
              value = r[col.key] ?? 0;
            }
            tr.appendChild(createCell(value));
          }
        });

        tbody.appendChild(tr);
      });
    }

    // ===== PLAYER ANALYSIS (ุจูุชุฑุฉ ุงูููุชุฑ) =====
    
    function computePlayerFullStats(playerId, matches){
      let wins = 0, losses = 0;
      let bonusPlus = 0, bonusMinus = 0;

      const dayMap = new Map();
      const teammateWin  = new Map(), teammateLose  = new Map();
      const opponentWin  = new Map(), opponentLose  = new Map();

      matches.forEach(m=>{
        const d = m.date || "ุจุฏูู ุชุงุฑูุฎ";
        if(!dayMap.has(d)) dayMap.set(d,{w:0,l:0});
        const ds = dayMap.get(d);

        const isW = (m.winners || []).includes(playerId);
        const isL = (m.losers  || []).includes(playerId);

        if(isW){
          wins++; ds.w++;
          if(m.bonusApplied){ bonusPlus += Number(m.bonusValue||0); }

          // ุฒููุงุก ุงูููุฒ
          (m.winners || []).forEach(pid=>{
            if(pid!==playerId)
              teammateWin.set(pid,(teammateWin.get(pid)||0)+1);
          });

          // ุงูุฎุตูู ุงููู ุฎุณุฑูุง ููู
          (m.losers || []).forEach(pid=>{
            opponentWin.set(pid,(opponentWin.get(pid)||0)+1);
          });
        }

        if(isL){
          losses++; ds.l++;
          if(m.bonusApplied){ bonusMinus += Number(m.bonusValue||0); }

          // ุฒููุงุก ุงูุฎุณุงุฑุฉ
          (m.losers || []).forEach(pid=>{
            if(pid!==playerId)
              teammateLose.set(pid,(teammateLose.get(pid)||0)+1);
          });

          // ุงูุฎุตูู ุงููู ูุณุจูุง ุนููู
          (m.winners || []).forEach(pid=>{
            opponentLose.set(pid,(opponentLose.get(pid)||0)+1);
          });
        }
      });

      const total=wins+losses;
      const rate=total>0?(wins/total)*100:0;

      let dW2=0,dW3=0,dW4=0,dL2=0,dL3=0,dL4=0;
      dayMap.forEach(ds=>{
        if(ds.w===2)dW2++; else if(ds.w===3)dW3++; else if(ds.w>=4)dW4++;
        if(ds.l===2)dL2++; else if(ds.l===3)dL3++; else if(ds.l>=4)dL4++;
      });

      function best(map){
        let bestCount = 0;
        map.forEach((c)=>{ if(c > bestCount) bestCount = c; });
        if(bestCount === 0) return [];
        const result = [];
        map.forEach((c,id)=>{
          if(c === bestCount){
            const p = getPlayerById(id);
            result.push({
              id,
              name: p ? p.name : ("ID " + id),
              count: c
            });
          }
        });
        return result;
      }

      return {
        wins,
        losses,
        totalMatches: total,
        winRate: rate,
        bonusPlus,
        bonusMinus,
        bonusNet: bonusPlus - bonusMinus,

        daysWin2: dW2,
        daysWin3: dW3,
        daysWin4plus: dW4,
        daysLose2: dL2,
        daysLose3: dL3,
        daysLose4plus: dL4,

        bestTeammateWin:  best(teammateWin),
        bestTeammateLose: best(teammateLose),
        bestOpponentWin:  best(opponentWin),
        bestOpponentLose: best(opponentLose)
      };
    }

    function updatePlayerDetailsUI(){
      const sel=$("playerDetailsSelect");
      const summary=$("playerDetailsSummary");
      const box=$("playerDetailsStats");
      if(!sel || !sel.value){
        summary.textContent="ุงุฎุชุฑ ูุงุนุจ ูู ุงููุงุฆูุฉ ูุนุฑุถ ุชุญูููู.";
        box.style.display="none"; return;
      }
      const id=sel.value;
      const player=getPlayerById(id);
      if(!player){summary.textContent="ูุง ููุฌุฏ ูุงุนุจ ุจูุฐุง ุงููุนุฑู.";box.style.display="none";return;}

      // โ ูู ุงููุงุนุจ ูุญุธูุฑ ุญุณุจ ููุงูุฉ ุงููุชุฑุฉ ุงููุฎุชุงุฑุฉุ ูุฎูู ุงูุชุญููู
      if(!shouldShowPlayerForSelectedRange(player, getSelectedRangeEndDate())){
        summary.textContent = `ุงููุงุนุจ "${player.name}" ูุญุธูุฑ ูู ูุฐู ุงููุชุฑุฉ ุญุณุจ ููุงูุฉ ุงูููุชุฑ.`;
        box.style.display = "none";
        return;
      }

      const matches = getFilteredMatches();
      const s=computePlayerFullStats(id, matches);

      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label = getFilterLabel(yearVal, monthVal);

      summary.innerHTML=`ุชุญููู ุงููุงุนุจ <strong>${player.name}</strong> (${label})`;

      $("pTotalWins").textContent=s.wins;
      $("pTotalLosses").textContent=s.losses;
      $("pTotalMatches").textContent=s.totalMatches;
      $("pWinRate").textContent=s.winRate.toFixed(1)+"ูช";
      $("pBonusPlus").textContent = s.bonusPlus || 0;
      $("pBonusMinus").textContent = s.bonusMinus || 0;
      $("pBonusNet").textContent = s.bonusNet || 0;

      $("pDaysWin2").textContent=s.daysWin2;
      $("pDaysWin3").textContent=s.daysWin3;
      $("pDaysWin4plus").textContent=s.daysWin4plus;
      $("pDaysLose2").textContent=s.daysLose2;
      $("pDaysLose3").textContent=s.daysLose3;
      $("pDaysLose4plus").textContent=s.daysLose4plus;

      // ุงูุดุฑูู ุงูููุถู (ูููู ูููู ุฃูุซุฑ ูู ูุงุญุฏ)
      if(s.bestTeammateWin && s.bestTeammateWin.length > 0){
        $("pBestMateWinName").textContent =
          s.bestTeammateWin.map(x => x.name).join(" ุ ");
        $("pBestMateWinCount").textContent = s.bestTeammateWin[0].count;
      } else {
        $("pBestMateWinName").textContent = "-";
        $("pBestMateWinCount").textContent = "0";
      }

      if(s.bestTeammateLose && s.bestTeammateLose.length > 0){
        $("pBestMateLoseName").textContent =
          s.bestTeammateLose.map(x => x.name).join(" ุ ");
        $("pBestMateLoseCount").textContent = s.bestTeammateLose[0].count;
      } else {
        $("pBestMateLoseName").textContent = "-";
        $("pBestMateLoseCount").textContent = "0";
      }

      // ุงูุฎุตู ุงูููุถู (ุฃูุชุฑ ูุงุญุฏ ูุณุจุช ุถุฏู / ุฎุณุฑุช ุถุฏู)
      if(s.bestOpponentWin && s.bestOpponentWin.length > 0){
        $("pBestOppWinName").textContent =
          s.bestOpponentWin.map(x => x.name).join(" ุ ");
        $("pBestOppWinCount").textContent = s.bestOpponentWin[0].count;
      } else {
        $("pBestOppWinName").textContent = "-";
        $("pBestOppWinCount").textContent = "0";
      }

      if(s.bestOpponentLose && s.bestOpponentLose.length > 0){
        $("pBestOppLoseName").textContent =
          s.bestOpponentLose.map(x => x.name).join(" ุ ");
        $("pBestOppLoseCount").textContent = s.bestOpponentLose[0].count;
      } else {
        $("pBestOppLoseName").textContent = "-";
        $("pBestOppLoseCount").textContent = "0";
      }

      box.style.display="block";
    }

    // ===== H2H (ุจูุชุฑุฉ ุงูููุชุฑ) =====
    function updateHeadToHeadUI(reset=true){
      if(reset) $("h2hSummary").textContent='ุงุฎุชุฑ ูุงุนุจูู ุซู ุงุถุบุท "ุชุญููู ุงูููุงุฌูุฉ".';
    }


function analyzeHeadToHead(){
  const p1Str = $("h2hP1").value;
  const p2Str = $("h2hP2").value;
  const out   = $("h2hSummary");

  if(!p1Str || !p2Str){
    out.textContent = "ุงุฎุชุฑ ูุงุนุจูู ุฃููุงู.";
    return;
  }

  const p1 = p1Str, p2 = p2Str;
  if(p1 === p2){
    out.textContent = "ูุง ูููู ุงุฎุชูุงุฑ ููุณ ุงููุงุนุจ ูุฑุชูู.";
    return;
  }

  const pl1 = getPlayerById(p1),
        pl2 = getPlayerById(p2);
  if(!pl1 || !pl2){
    out.textContent = "ูู ูุชู ุงูุนุซูุฑ ุนูู ุฃุญุฏ ุงููุงุนุจูู.";
    return;
  }

  const matches = getFilteredMatches();

  // vs: ุถุฏ ุจุนุถ โ p1W / p2W
  // team: ูุน ุจุนุถ โ teamWins / teamLosses
  let vs = 0, p1W = 0, p2W = 0;
  let team = 0, teamWins = 0, teamLosses = 0;

  // ๐ transfers
  let baseNet = 0;   // + ูุนูู ุงููุงุนุจ 1 ุญุตู ุนูู ููุงุท ูู ุงููุงุนุจ 2
  let bonusNet = 0;  // + ูุนูู ุงููุงุนุจ 1 ุญุตู ุนูู ุจููุต ูู ุงููุงุนุจ 2

  matches.forEach(m=>{
    const w = m.winners || [];
    const l = m.losers  || [];

    const p1Win  = w.includes(p1);
    const p1Lose = l.includes(p1);
    const p2Win  = w.includes(p2);
    const p2Lose = l.includes(p2);

    // ูุน ุจุนุถ ูู ููุณ ุงููุฑูู
    if( (p1Win && p2Win) || (p1Lose && p2Lose) ){
      team++;
      if(p1Win && p2Win)  teamWins++;
      if(p1Lose && p2Lose) teamLosses++;
      return;
    }

    // ุถุฏ ุจุนุถ
    if( (p1Win && p2Lose) || (p2Win && p1Lose) ){
      vs++;
      const b = (m.bonusApplied ? Number(m.bonusValue||0) : 0);

      if(p1Win && p2Lose){
        p1W++;
        baseNet += 1;
        bonusNet += b;
      }
      if(p2Win && p1Lose){
        p2W++;
        baseNet -= 1;
        bonusNet -= b;
      }
    }
  });

  const yearVal  = $("filterYear").value;
  const monthVal = $("filterMonth").value;
  const label    = getFilterLabel(yearVal, monthVal);

  let html = `ุชุญููู ุงูููุงุฌูุงุช ุจูู <strong>${pl1.name}</strong> ู <strong>${pl2.name}</strong> (${label}):<br/><br/>`;
  html += `โข ูุนุจูุง ุถุฏ ุจุนุถ ูู <strong>${vs}</strong> ูุงุชุด(ุงุช) ุนุดุฑุฉ.<br/>`;
  html += `โข ูุฑุงุช ูุงุฒ ูููุง <strong>${pl1.name}</strong> ุนูู ${pl2.name}: <strong>${p1W}</strong> ูุฑุฉ.<br/>`;
  html += `โข ูุฑุงุช ูุงุฒ ูููุง <strong>${pl2.name}</strong> ุนูู ${pl1.name}: <strong>${p2W}</strong> ูุฑุฉ.<br/>`;
  html += `โข ูุนุจูุง ูุนูุง ูู ููุณ ุงููุฑูู ูู <strong>${team}</strong> ูุงุชุด(ุงุช) ุนุดุฑุฉ.<br/>`;

  if(vs > 0){
    const r1 = (p1W / vs) * 100;
    const r2 = (p2W / vs) * 100;
    html += `<br/>ูุณุจุฉ ุงูููุฒ ุนูุฏูุง ูุชูุงุจูุงู ุถุฏ ุจุนุถ ูู ูุฐู ุงููุชุฑุฉ:<br/>`;
    html += `โข ${pl1.name}: <strong>${r1.toFixed(1)}ูช</strong><br/>`;
    html += `โข ${pl2.name}: <strong>${r2.toFixed(1)}ูช</strong><br/>`;
  }

  // ๐ ูุณุจุฉ ุงููุชุงุฆุฌ ููู ูู ููุณ ุงููุฑูู
  if(team > 0){
    const teamWinRate  = (teamWins   / team) * 100;
    const teamLoseRate = (teamLosses / team) * 100;
    html += `<br/>ูุณุจุฉ ุงููุชุงุฆุฌ ุนูุฏูุง ููุนุจุงู ูุนูุง ูู ููุณ ุงููุฑูู ูู ูุฐู ุงููุชุฑุฉ:<br/>`;
    html += `โข ููุฒ ูุนูุง: <strong>${teamWinRate.toFixed(1)}ูช</strong> (${teamWins} ูู ${team} ูุงุชุดุงุช)<br/>`;
    html += `โข ุฎุณุงุฑุฉ ูุนูุง: <strong>${teamLoseRate.toFixed(1)}ูช</strong> (${teamLosses} ูู ${team} ูุงุชุดุงุช)<br/>`;
  }

  // ๐ ุชูุณูุน ุงูููุงุฌูุงุช ุงููุจุงุดุฑุฉ (ุจููุต + ููุงุท ุฃุณุงุณูุฉ)
  html += `<br/><b>๐ ุงูุจููุต (ูุญุณูุจ ูููุตู)</b><br/>`;
  html += `โข ุญุตู ุงููุงุนุจ 1 ูู ุงููุงุนุจ 2 ุนูู ุจููุต: <strong>${bonusNet}</strong><br/>`;
  html += `โข ุญุตู ุงููุงุนุจ 2 ูู ุงููุงุนุจ 1 ุนูู ุจููุต: <strong>${-bonusNet}</strong><br/>`;

  html += `<br/><b>๐ฏ ุงูููุงุท ุงูุฃุณุงุณูุฉ (ุจุฏูู ุจููุต)</b><br/>`;
  html += `โข ุญุตู ุงููุงุนุจ 1 ูู ุงููุงุนุจ 2 ุนูู ููุงุท: <strong>${baseNet}</strong><br/>`;
  html += `โข ุญุตู ุงููุงุนุจ 2 ูู ุงููุงุนุจ 1 ุนูู ููุงุท: <strong>${-baseNet}</strong><br/>`;

  out.innerHTML = html;
}


    // ===== TEAMS H2H (2 ุถุฏ 2) =====
    function normalizeTeamId(p1, p2){
      if(!p1 || !p2) return null;
      // ูุฎูู ุงูู ID ุซุงุจุช ูููุง ูุงู ุชุฑุชูุจ ุงููุงุนุจูู
      return (p1 < p2) ? (p1 + "|" + p2) : (p2 + "|" + p1);
    }

    function resetTeamsH2HSummary(){
      const el = $("h2hTeamsSummary");
      if(el){
        el.textContent = 'ุงุฎุชุฑ ูุงุนุจู ุงููุฑูููู ุซู ุงุถุบุท "ุชุญููู ุงูููุงุฌูุฉ".';
      }
    }

    function analyzeTeamsHeadToHead(){
      const t1p1 = $("h2hT1P1").value;
      const t1p2 = $("h2hT1P2").value;
      const t2p1 = $("h2hT2P1").value;
      const t2p2 = $("h2hT2P2").value;
      const out  = $("h2hTeamsSummary");

      if(!out) return;

      // ุชุญูู ูู ุงูุงุฎุชูุงุฑ
      if(!t1p1 || !t1p2 || !t2p1 || !t2p2){
        out.textContent = "ุงุฎุชุฑ ูุงุนุจูู ููู ูุฑูู ุฃูููุง.";
        return;
      }

      // ููููุน ููุณ ุงููุงุนุจ ูุชูุฑุฑ ูู ููุณ ุงููุฑูู
      if(t1p1 === t1p2 || t2p1 === t2p2){
        out.textContent = "ูุงุนุจ ูุงุญุฏ ูุง ูููู ุฃู ูููู ููุงู ูุงุนุจ 1 ู 2 ูู ููุณ ุงููุฑูู.";
        return;
      }

      // ูู ุญุงุจุจ ุชููุน ุชูุฑุงุฑ ูุงุนุจ ุจูู ุงููุฑูููู:
      const all = [t1p1,t1p2,t2p1,t2p2];
      if(new Set(all).size < 4){
        out.textContent = "ูุงุนุจ ูุงุญุฏ ูุง ูููู ุฃู ููุนุจ ูู ุงููุฑูููู ูู ููุณ ุงูููุงุฌูุฉ.";
        return;
      }

      const team1Id = normalizeTeamId(t1p1, t1p2);
      const team2Id = normalizeTeamId(t2p1, t2p2);

      if(team1Id === team2Id){
        out.textContent = "ูุง ูููู ููุงุฑูุฉ ููุณ ุงููุฑูู ุจููุณู.";
        return;
      }

      const t1Name =
        getPlayerNameById(t1p1) + " + " + getPlayerNameById(t1p2);
      const t2Name =
        getPlayerNameById(t2p1) + " + " + getPlayerNameById(t2p2);

      const matches = getFilteredMatches();

      let vs = 0;
      let t1Wins = 0;
      let t2Wins = 0;

      matches.forEach(m=>{
        if(!m.winners || !m.losers) return;
        if(m.winners.length !== 2 || m.losers.length !== 2) return;

        const wTeamId = normalizeTeamId(m.winners[0], m.winners[1]);
        const lTeamId = normalizeTeamId(m.losers[0], m.losers[1]);

        if(!wTeamId || !lTeamId) return;

        // ููุณ ุงููุฑูููู ุจุงูุธุจุทุ
        if(
          (wTeamId === team1Id && lTeamId === team2Id) ||
          (wTeamId === team2Id && lTeamId === team1Id)
        ){
          vs++;
          if(wTeamId === team1Id) t1Wins++;
          if(wTeamId === team2Id) t2Wins++;
        }
      });

      const yearVal  = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label    = getFilterLabel(yearVal, monthVal);

      if(vs === 0){
        out.innerHTML =
          `ูุง ุชูุฌุฏ ุฃู ููุงุฌูุงุช ูุจุงุดุฑุฉ ุจูู <strong>${t1Name}</strong> ู <strong>${t2Name}</strong> ูู ูุฐู ุงููุชุฑุฉ (${label}).`;
        return;
      }

      const t1Rate = (t1Wins / vs) * 100;
      const t2Rate = (t2Wins / vs) * 100;

      let html = `ุชุญููู ุงูููุงุฌูุงุช ุจูู ุงููุฑูู <strong>${t1Name}</strong> ูุงููุฑูู <strong>${t2Name}</strong> (${label}):<br/><br/>`;
      html += `โข ูุนุจูุง ุถุฏ ุจุนุถ ูู <strong>${vs}</strong> ูุงุชุด(ุงุช) ุนุดุฑุฉ.<br/>`;
      html += `โข ูุฑุงุช ูุงุฒ ูููุง <strong>${t1Name}</strong>: <strong>${t1Wins}</strong> ูุฑุฉ.<br/>`;
      html += `โข ูุฑุงุช ูุงุฒ ูููุง <strong>${t2Name}</strong>: <strong>${t2Wins}</strong> ูุฑุฉ.<br/>`;
      html += `<br/>ูุณุจุฉ ุงูููุฒ ุนูุฏูุง ูุชูุงุจูุงู ูู ูุฐู ุงููุชุฑุฉ:<br/>`;
      html += `โข ${t1Name}: <strong>${t1Rate.toFixed(1)}ูช</strong><br/>`;
      html += `โข ${t2Name}: <strong>${t2Rate.toFixed(1)}ูช</strong><br/>`;

      out.innerHTML = html;
    }

    // ===== INIT =====
    function init(){
      initFirebase();
      updateAdminUI();
      updateBonusEligibility();
      ["winnerP1","winnerP2","loserP1","loserP2"].forEach(id=>{
        const el=$(id);
        if(el) el.addEventListener("change", updateBonusEligibility);
      });


      // โ ุถุจุท ุงูููุชุฑ ุงูุงูุชุฑุงุถู ุนูู "ุงูุดูุฑ ุงูุญุงูู"
      const now = new Date();
      const currentYear  = String(now.getFullYear());
      const currentMonth = String(now.getMonth() + 1); // ูู 1 ุฅูู 12

      const fy = $("filterYear");
      const fm = $("filterMonth");

      // ูุถูู ุฅู ุณูุฉ ุงูุญุงููุฉ ููุฌูุฏุฉ ูู ุงููุงุฆูุฉุ ููู ูุด ููุฌูุฏุฉ ูุถูููุง
      if(fy){
        let yearOpt = Array.from(fy.options).find(o => o.value === currentYear);
        if(!yearOpt){
          yearOpt = document.createElement("option");
          yearOpt.value = currentYear;
          yearOpt.textContent = currentYear;
          fy.appendChild(yearOpt);
        }
        fy.value = currentYear;
      }

      if(fm){
        fm.value = currentMonth; // ูุฃู ุงูุดููุฑ 1..12 ููุฌูุฏุฉ ุจุงููุนู ูู ุงูู HTML
      }

      // ูุญุฏูุซ ุงูุชุฑุชูุจ ูุงูุณุฌู ุจูุงุกู ุนูู ุงููุชุฑุฉ ุงูุงูุชุฑุงุถูุฉ      updateLeaderboard();
      updateMatchesLog();
      updateHeadToHeadUI(true);
      if($("playerDetailsSelect")) updatePlayerDetailsUI();

      // ุจุงูู ุงููุณุชููุฑุฒ ุฒู ูุง ูู
      $("addPlayerBtn").addEventListener("click",addPlayer);
      $("addMatchBtn").addEventListener("click",addMatch);
      $("bonusBtn").addEventListener("click",toggleBonus);
      $("resetAllBtn").addEventListener("click",resetAll);
      $("playerDetailsSelect").addEventListener("change",updatePlayerDetailsUI);
      $("h2hAnalyzeBtn").addEventListener("click",analyzeHeadToHead);
      $("enableAdminBtn").addEventListener("click",enableAdminMode);
      $("disableAdminBtn").addEventListener("click",disableAdminMode);

      // โญ ุฒุฑุงุฑ ุชุญููู ููุงุฌูุฉ ุงููุฑู 2 ุถุฏ 2
      const h2hTeamsBtn = $("h2hTeamsAnalyzeBtn");
      if (h2hTeamsBtn){
        h2hTeamsBtn.addEventListener("click", analyzeTeamsHeadToHead);
      }

      $("filterYear").addEventListener("change",()=>{
        updatePlayersUI();
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
        else updateHeadToHeadUI(true);

        updateMatchesLog();
        updateChampionsLog();
        updateChampionsLog();
        // โญ ุฑุฌูุน ูุต ููุฎุต ููุงุฌูุงุช ุงููุฑู ูููุถุน ุงูุงูุชุฑุงุถู
        resetTeamsH2HSummary();
      });

      $("filterMonth").addEventListener("change",()=>{
        updatePlayersUI();
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
        else updateHeadToHeadUI(true);

        updateMatchesLog();
        // โญ ุจุฑุถู ูุฑุฌูุน ููุฎุต ุงููุฑู
        resetTeamsH2HSummary();
      });

      const toggleViewBtn = $("leaderboardToggleViewBtn");
      if(toggleViewBtn){
        toggleViewBtn.addEventListener("click", ()=>{
          leaderboardViewMode = (leaderboardViewMode === "compact") ? "detailed" : "compact";
          toggleViewBtn.textContent = (leaderboardViewMode === "compact")
            ? "๐ ุนุฑุถ ุชูุตููู"
            : "๐ ุนุฑุถ ูุฎุชุตุฑ";
          updateLeaderboard();
          if($("playerDetailsSelect").value) updatePlayerDetailsUI();
          if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); 
          else updateHeadToHeadUI(true);

          // ูุด ูุงุฒู ููุง ูุญูู ุงููุฑู ุชุงููุ ุจุณ ูู ุญุงุจุจ:
          // resetTeamsH2HSummary();
        });
      }

      $("togglePlayersListBtn").addEventListener("click", togglePlayersList);
      $("toggleMatchesLogBtn").addEventListener("click", toggleMatchesLog);
    }

    document.addEventListener("DOMContentLoaded",init);
  </script>
</body>
</html>

