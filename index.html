<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <title>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ - Ø§Ù„Ø¹Ø´Ø±Ø© (151)</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 0;
      background: #f5f5f5;
      direction: rtl;
    }

    th.sortable {
      cursor: pointer;
      white-space: nowrap;
    }

    .sort-arrow {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-right: 4px;
    }

    header {
      background: #222;
      color: #fff;
      padding: 16px 24px;
      text-align: center;
    }

    header h1 {
      margin: 0;
      font-size: 1.4rem;
    }

    main {
      max-width: 980px;
      margin: 16px auto 32px;
      padding: 0 12px;
    }

    .card {
      background: #fff;
      border-radius: 10px;
      padding: 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.08);
    }

    .card h2 {
      margin-top: 0;
      font-size: 1.1rem;
      margin-bottom: 10px;
    }

    .row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 10px;
    }

    .field {
      flex: 1 1 160px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    label {
      font-size: 0.9rem;
      font-weight: 600;
    }

    input[type="text"],
    input[type="date"],
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    input[type="file"] {
      font-size: 0.8rem;
    }

    button {
      border: none;
      border-radius: 6px;
      padding: 8px 14px;
      font-size: 0.9rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.1s;
    }

    button.primary {
      background: #2563eb;
      color: #fff;
    }

    button.primary:hover {
      background: #1d4ed8;
    }

    button.danger {
      background: #b91c1c;
      color: #fff;
    }

    button.danger:hover {
      background: #991b1b;
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    button:active:not(:disabled) {
      transform: scale(0.97);
    }

    .small-text {
      font-size: 0.8rem;
      color: #555;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.9rem;
      margin-top: 10px;
    }

    th, td {
      padding: 8px 6px;
      text-align: center;
      border-bottom: 1px solid #eee;
    }

    th {
      background: #f1f5f9;
      font-weight: 700;
    }

    tr:nth-child(even) td {
      background: #f9fafb;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
      gap: 8px;
      margin-top: 8px;
    }

    .stat-box {
      border-radius: 8px;
      background: #f9fafb;
      padding: 8px;
      font-size: 0.8rem;
      text-align: center;
    }

    .stat-box strong {
      display: block;
      font-size: 1rem;
      margin-bottom: 4px;
    }

    .btn-small {
      padding: 4px 8px;
      font-size: 0.75rem;
      border-radius: 4px;
    }

    .admin-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 8px;
    }

    .admin-bar-text {
      font-size: 0.8rem;
    }

    .player-cell {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      justify-content: center;
    }

    .player-avatar {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      object-fit: cover;
      border: 1px solid #ddd;
    }

    @media (max-width: 600px) {
      th, td {
        font-size: 0.8rem;
        padding: 6px 4px;
      }
    }
  </style>

  <!-- Firebase (CDN compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
</head>
<body>
  <header>
    <h1>Ø¨Ø±Ù†Ø§Ù…Ø¬ ØªØ±ØªÙŠØ¨ Ø§Ù„Ø¯ÙˆÙ…ÙŠÙ†Ùˆ Ø§Ù„Ø²ÙˆØ¬ÙŠ - Ø§Ù„Ø¹Ø´Ø±Ø© (151)</h1>
    <div class="small-text">
      ÙƒÙ„ Ù…Ø§ØªØ´ (Ø¹Ø´Ø±Ø©) = Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† +1 Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨ / Ø§Ù„Ø®Ø³Ø±Ø§Ù† -1 Ù„ÙƒÙ„ Ù„Ø§Ø¹Ø¨
    </div>
  </header>

  <main>
    <!-- Ø´Ø±ÙŠØ· ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± -->
    <section class="card">
      <h2>ğŸ” ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± (Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª)</h2>
      <div class="admin-bar">
        <button class="primary" id="enableAdminBtn">ğŸ”‘ ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <button class="danger" id="disableAdminBtn" style="display:none;">ğŸšª Ù‚ÙÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±</button>
        <div id="adminStatusText" class="admin-bar-text">
          ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.
        </div>
      </div>
    </section>

    <!-- Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† -->
    <section class="card">
      <h2>ğŸ‘¤ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
      <div class="row">
        <div class="field">
          <label for="playerName">Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯</label>
          <input type="text" id="playerName" placeholder="Ù…Ø«Ø§Ù„: Ø£Ø­Ù…Ø¯ØŒ Ø¹Ù„ÙŠØŒ Ø­Ø³Ø§Ù…..." />
        </div>
        <div class="field">
          <label for="playerAvatarFile">ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input type="file" id="playerAvatarFile" accept="image/*" />
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addPlayerBtn">â• Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨</button>
        </div>
      </div>

      <div class="small-text" id="playersListInfo"></div>

      <!-- Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ù„Ù„ØªØ¹Ø¯ÙŠÙ„ -->
      <table style="margin-top:8px;">
        <thead>
          <tr>
            <th>#</th>
            <th>Ø§Ù„Ù„Ø§Ø¹Ø¨</th>
            <th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
          </tr>
        </thead>
        <tbody id="playersTableBody"></tbody>
      </table>
      <div class="small-text">
        ØªÙ‚Ø¯Ø± ØªØ¹Ø¯Ù‘Ù„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£Ùˆ ØªØ¶ÙŠÙ/ØªØºÙŠÙ‘Ø± ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù…ØªØ§Ø­ Ù„Ù„Ù…Ø¯ÙŠØ± ÙÙ‚Ø·).
      </div>
    </section>

    <!-- ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø§ØªØ´ -->
    <section class="card">
      <h2>ğŸ§® ØªØ³Ø¬ÙŠÙ„ Ù†ØªÙŠØ¬Ø© Ù…Ø§ØªØ´ (Ø¹Ø´Ø±Ø© ÙƒØ§Ù…Ù„Ø©)</h2>
      <div class="row">
        <div class="field">
          <label for="matchDate">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø§ØªØ´</label>
          <input type="date" id="matchDate" />
          <span class="small-text">Ù„Ùˆ ØªØ±ÙƒØªÙ‡ ÙØ§Ø¶ÙŠØŒ Ù‡ÙŠØªØ³Ø¬Ù„ Ø¨ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…</span>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="winnerP1"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù† - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="winnerP2"></select>
        </div>
      </div>

      <div class="row">
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù† - Ù„Ø§Ø¹Ø¨ 1</label>
          <select id="loserP1"></select>
        </div>
        <div class="field">
          <label>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù† - Ù„Ø§Ø¹Ø¨ 2</label>
          <select id="loserP2"></select>
        </div>
      </div>

      <div class="row" style="margin-top:8px;">
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="addMatchBtn">âœ… Ø­ÙØ¸ Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù…Ø§ØªØ´</button>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="danger" id="undoLastMatchBtn">âª ØªØ±Ø§Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ù…Ø§ØªØ´</button>
        </div>
      </div>
      <div class="small-text">
        Ù…Ù„Ø§Ø­Ø¸Ø©: Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø§ ÙŠÙ†ÙØ¹Ø´ ÙŠÙƒÙˆÙ† ÙÙŠ Ø§Ù„ÙØ±ÙŠÙ‚ÙŠÙ† ÙÙŠ Ù†ÙØ³ Ø§Ù„Ù…Ø§ØªØ´.
      </div>
    </section>

    <!-- Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø© -->
    <section class="card">
      <h2>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø¹Ø§Ù…Ø©</h2>
      <div class="row">
        <div class="field">
          <label for="filterYear">Ø§Ù„Ø³Ù†Ø©</label>
          <select id="filterYear">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª</option>
          </select>
        </div>
        <div class="field">
          <label for="filterMonth">Ø§Ù„Ø´Ù‡Ø±</label>
          <select id="filterMonth">
            <option value="all">ÙƒÙ„ Ø§Ù„Ø´Ù‡ÙˆØ±</option>
            <option value="1">ÙŠÙ†Ø§ÙŠØ±</option>
            <option value="2">ÙØ¨Ø±Ø§ÙŠØ±</option>
            <option value="3">Ù…Ø§Ø±Ø³</option>
            <option value="4">Ø£Ø¨Ø±ÙŠÙ„</option>
            <option value="5">Ù…Ø§ÙŠÙˆ</option>
            <option value="6">ÙŠÙˆÙ†ÙŠÙˆ</option>
            <option value="7">ÙŠÙˆÙ„ÙŠÙˆ</option>
            <option value="8">Ø£ØºØ³Ø·Ø³</option>
            <option value="9">Ø³Ø¨ØªÙ…Ø¨Ø±</option>
            <option value="10">Ø£ÙƒØªÙˆØ¨Ø±</option>
            <option value="11">Ù†ÙˆÙÙ…Ø¨Ø±</option>
            <option value="12">Ø¯ÙŠØ³Ù…Ø¨Ø±</option>
          </select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="danger" id="resetAllBtn">ğŸ§¨ Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button id="leaderboardToggleViewBtn">ğŸ“Š Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ</button>
        </div>
      </div>

      <div class="small-text" id="currentFilterLabel"></div>

      <table id="leaderboardTable">
        <thead id="leaderboardHead"></thead>
        <tbody id="leaderboardBody"></tbody>
      </table>
    </section>

    <!-- Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª -->
    <section class="card">
      <h2>ğŸ“œ Ø³Ø¬Ù„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª (ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª)</h2>

      <div class="row" style="margin-bottom:4px;">
        <div class="field" style="flex:0 0 auto;">
          <button class="primary" id="toggleMatchesLogBtn">ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„</button>
        </div>
      </div>

      <div id="matchesLogWrapper">
        <div class="small-text">
          Ø£Ø­Ø¯Ø« Ù…Ø§ØªØ´ ÙÙŠ Ø§Ù„Ø£Ø¹Ù„Ù‰. ÙŠÙ…ÙƒÙ†Ùƒ Ø­Ø°Ù Ø£ÙŠ Ù…Ø§ØªØ´ ØºÙ„Ø· Ø¨Ø¯ÙˆÙ† Ø§Ù„ØªØ£Ø«ÙŠØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù‚ÙŠ.
        </div>
        <table>
          <thead>
            <tr>
              <th>#</th>
              <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
              <th>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„ÙƒØ³Ø¨Ø§Ù†</th>
              <th>Ø§Ù„ÙØ±ÙŠÙ‚ Ø§Ù„Ø®Ø³Ø±Ø§Ù†</th>
              <th>Ø­Ø°Ù</th>
            </tr>
          </thead>
          <tbody id="matchesLogBody"></tbody>
        </table>
      </div>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø¹Ø¨ ÙˆØ§Ø­Ø¯ -->
    <section class="card">
      <h2>ğŸ“Š ØªØ­Ù„ÙŠÙ„ Ù„Ø§Ø¹Ø¨ Ù…Ù†ÙØ±Ø¯</h2>
      <div class="row">
        <div class="field">
          <label for="playerDetailsSelect">Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨</label>
          <select id="playerDetailsSelect"></select>
        </div>
      </div>
      <div id="playerDetailsSummary" class="small-text">
        Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„Ù‡.
      </div>

      <div id="playerDetailsStats" style="margin-top:10px; display:none;">
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pTotalWins">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pTotalLosses">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù…Ø±Ø§Øª Ø§Ù„Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pTotalMatches">0</strong>
            Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
          <div class="stat-box">
            <strong id="pWinRate">0%</strong>
            Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">ğŸ“† ØªØ­Ù„ÙŠÙ„ Ø£ÙŠØ§Ù… Ø§Ù„ÙÙˆØ² ÙˆØ§Ù„Ø®Ø³Ø§Ø±Ø© ÙÙŠ Ø§Ù„ÙØªØ±Ø© Ø§Ù„Ù…Ø®ØªØ§Ø±Ø©</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pDaysWin2">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ Ù…Ø±ØªÙŠÙ†
          </div>
          <div class="stat-box">
            <strong id="pDaysWin3">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ 3 Ù…Ø±Ø§Øª
          </div>
          <div class="stat-box">
            <strong id="pDaysWin4plus">0</strong>
            Ø£ÙŠØ§Ù… ÙƒØ³Ø¨ ÙÙŠÙ‡Ø§ 4 Ù…Ø±Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±
          </div>
          <div class="stat-box">
            <strong id="pDaysLose2">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ Ù…Ø±ØªÙŠÙ†
          </div>
          <div class="stat-box">
            <strong id="pDaysLose3">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ 3 Ù…Ø±Ø§Øª
          </div>
          <div class="stat-box">
            <strong id="pDaysLose4plus">0</strong>
            Ø£ÙŠØ§Ù… Ø®Ø³Ø± ÙÙŠÙ‡Ø§ 4 Ù…Ø±Ø§Øª Ø£Ùˆ Ø£ÙƒØ«Ø±
          </div>
        </div>

        <h3 style="font-size:0.95rem; margin-top:14px;">ğŸ¤ Ø§Ù„Ø´Ø±ÙŠÙƒ Ø§Ù„Ù…ÙØ¶Ù„ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØªØ±Ø©</h3>
        <div class="stats-grid">
          <div class="stat-box">
            <strong id="pBestMateWinName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ ÙƒØ³Ø¨Øª Ù…Ø¹Ø§Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestMateWinCount">0</span>
            </div>
          </div>
          <div class="stat-box">
            <strong id="pBestMateLoseName">-</strong>
            Ø£ÙƒØªØ± ÙˆØ§Ø­Ø¯ Ø®Ø³Ø±Ù‘Øª Ù…Ø¹Ø§Ù‡
            <div class="small-text">
              Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø±Ø§Øª: <span id="pBestMateLoseCount">0</span>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© -->
    <section class="card">
      <h2>âš”ï¸ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨ÙŠÙ† Ù„Ø§Ø¹Ø¨ÙŠÙ†</h2>
      <div class="row">
        <div class="field">
          <label for="h2hP1">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø£ÙˆÙ„</label>
          <select id="h2hP1"></select>
        </div>
        <div class="field">
          <label for="h2hP2">Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø§Ù„Ø«Ø§Ù†ÙŠ</label>
          <select id="h2hP2"></select>
        </div>
        <div class="field" style="align-self:flex-end;">
          <button class="primary" id="h2hAnalyzeBtn">ğŸ” ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©</button>
        </div>
      </div>
      <div id="h2hSummary" class="small-text">
        Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".
      </div>
    </section>

    <section class="card">
      <h2>â„¹ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù…</h2>
      <ul class="small-text">
        <li>Ù…Ù† ØºÙŠØ± ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±ØŒ Ø§Ù„Ø¨Ø±Ù†Ø§Ù…Ø¬ ÙÙŠ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·.</li>
        <li>ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙŠ Firebase FirestoreØŒ ØªÙ‚Ø¯Ø± ØªÙØªØ­ Ù…Ù† Ø£ÙŠ Ø¬Ù‡Ø§Ø².</li>
        <li>Ø§Ø³ØªØ®Ø¯Ù… ÙÙ„ØªØ± Ø§Ù„Ø³Ù†Ø© ÙˆØ§Ù„Ø´Ù‡Ø± Ù„Ù„ØªØ­ÙƒÙ… ÙÙŠ ÙØªØ±Ø© Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„ØªÙ€Ø±ØªÙŠØ¨ ÙˆØ§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª.</li>
      </ul>
    </section>
  </main>

  <script>
    const ADMIN_PIN = "1510"; // ØºÙŠØ±Ù‡ Ù„Ùˆ Ø­Ø§Ø¨Ø¨

    let isAdmin = false;
    let matchesLogVisible = true;
    let db = null;

    let state = {
      players: [], // {id, name, avatar}
      matches: []  // {id, date, winners, losers, createdAt}
    };

    function getLeaderboardColumns(){
      if(leaderboardViewMode === "compact"){
        return [
          {key:"rank",   label:"Ø§Ù„ØªØ±ØªÙŠØ¨"},
          {key:"name",   label:"Ø§Ù„Ù„Ø§Ø¹Ø¨"},
          {key:"points", label:"Ø§Ù„Ù†Ù‚Ø§Ø·"},
          {key:"wins",   label:"ÙÙˆØ²"},
          {key:"losses", label:"Ø®Ø³Ø§Ø±Ø©"},
          {key:"matches",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª"},
          {key:"rate",   label:"% Ø§Ù„ÙÙˆØ²"}
        ];
      } else {
        return [
          {key:"rank",   label:"Ø§Ù„ØªØ±ØªÙŠØ¨"},
          {key:"name",   label:"Ø§Ù„Ù„Ø§Ø¹Ø¨"},
          {key:"points", label:"Ø§Ù„Ù†Ù‚Ø§Ø·"},
          {key:"wins",   label:"ÙÙˆØ²"},
          {key:"losses", label:"Ø®Ø³Ø§Ø±Ø©"},
          {key:"matches",label:"Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª"},
          {key:"rate",   label:"% Ø§Ù„ÙÙˆØ²"},
          {key:"w2",     label:"Ø«Ù†Ø§Ø¦ÙŠØ§Øª ÙÙˆØ²"},
          {key:"w3",     label:"Ø«Ù„Ø§Ø«ÙŠØ§Øª ÙÙˆØ²"},
          {key:"w4",     label:"Ø±Ø¨Ø§Ø¹ÙŠØ§Øª ÙÙˆØ²"},
          {key:"l2",     label:"Ø«Ù†Ø§Ø¦ÙŠØ§Øª Ø®Ø³Ø§Ø±Ø©"},
          {key:"l3",     label:"Ø«Ù„Ø§Ø«ÙŠØ§Øª Ø®Ø³Ø§Ø±Ø©"},
          {key:"l4",     label:"Ø±Ø¨Ø§Ø¹ÙŠØ§Øª Ø®Ø³Ø§Ø±Ø©"}
        ];
      }
    }

    function applyLeaderboardSort(rows){
      const col = leaderboardSort.column;
      const dir = leaderboardSort.direction === "asc" ? 1 : -1;
      const key = (col === "rank") ? "points" : col; // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„Ù†Ù‚Ø§Ø· Ù„Ùˆ Ø§Ø®ØªØ±Ù†Ø§ "Ø§Ù„ØªØ±ØªÙŠØ¨"

      rows.sort((a,b)=>{
        if(key === "name"){
          return dir * a.name.localeCompare(b.name,"ar");
        } else {
          const av = a[key] ?? 0;
          const bv = b[key] ?? 0;
          if(av < bv) return -1 * dir;
          if(av > bv) return  1 * dir;
          return a.name.localeCompare(b.name,"ar");
        }
      });
    }

    function $(id){return document.getElementById(id);}

    // ===== Firebase init =====
    function initFirebase(){
      const firebaseConfig = {
        apiKey: "AIzaSyDmNo5FIHlW6fcZmCh0TVYzjc9NIia_iM8",
        authDomain: "domino-league-c2d94.firebaseapp.com",
        projectId: "domino-league-c2d94",
        storageBucket: "domino-league-c2d94.firebasestorage.app",
        messagingSenderId: "928957805726",
        appId: "1:928957805726:web:d6f7bc867cbfb6c824f78f",
        measurementId: "G-J2TJQD7QQ"
      };

      // ØªØ´ØºÙŠÙ„ Firebase Ø¨Ù†Ø³Ø®Ø© compat Ø§Ù„Ù„ÙŠ Ø­Ø§Ø·ÙŠÙ†Ù‡Ø§ ÙÙŠ <script> ÙÙˆÙ‚
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();

      // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
      db.collection("players").onSnapshot(snapshot => {
        const players = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          players.push({
            id: doc.id,
            name: data.name,
            avatar: data.avatar || null
          });
        });
        state.players = players;
        updatePlayersUI();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateMatchesLog();
      });

      // Ø§Ø³ØªÙ…Ø¹ Ù„Ø£ÙŠ ØªØºÙŠÙŠØ±Ø§Øª ÙÙŠ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      db.collection("matches").onSnapshot(snapshot => {
        const matches = [];
        snapshot.forEach(doc => {
          const data = doc.data();
          matches.push({
            id: doc.id,
            date: data.date || null,
            winners: data.winners || [],
            losers: data.losers || [],
            createdAt: data.createdAt || null
          });
        });
        state.matches = matches;
        updateFilterYearOptions();
        updateLeaderboard();
        updatePlayerDetailsUI();
        updateHeadToHeadUI(false);
        updateMatchesLog();
      });
    }

    // ===== ADMIN =====
    function updateAdminUI(){
      const ids = ["addPlayerBtn","addMatchBtn","undoLastMatchBtn","resetAllBtn"];
      ids.forEach(id=>{
        const el=$(id);
        if(el) el.disabled = !isAdmin;
      });
      ["playerName","playerAvatarFile","matchDate","winnerP1","winnerP2","loserP1","loserP2"]
        .forEach(id=>{
          const el=$(id);
          if(el) el.disabled = !isAdmin;
        });

      $("enableAdminBtn").style.display = isAdmin ? "none" : "inline-block";
      $("disableAdminBtn").style.display = isAdmin ? "inline-block" : "none";
      $("adminStatusText").textContent = isAdmin
        ? "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ± Ù…ÙÙØ¹Ù‘Ù„: Ù…Ø³Ù…ÙˆØ­ Ø¨Ø¥Ø¶Ø§ÙØ© Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØªØ³Ø¬ÙŠÙ„/Ø­Ø°Ù Ø§Ù„Ù…Ø§ØªØ´Ø§Øª ÙˆÙ…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª."
        : "ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø© ÙÙ‚Ø·: Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¨Ø¹Ø¯ Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±.";

      // Ø¹Ù„Ø´Ø§Ù† Ø£Ø²Ø±Ø§Ø± ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ØªØ¸Ù‡Ø±/ØªØ®ØªÙÙŠ Ø­Ø³Ø¨ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±
      updateMatchesLog();
      updatePlayersUI();
    }

    function enableAdminMode(){
      const pin = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ±:");
      if(pin === null) return;
      if(pin === ADMIN_PIN){
        isAdmin = true;
        alert("ØªÙ… ØªÙØ¹ÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø¯ÙŠØ±.");
      } else {
        alert("ÙƒÙˆØ¯ ØºÙŠØ± ØµØ­ÙŠØ­.");
      }
      updateAdminUI();
    }

    function disableAdminMode(){
      isAdmin = false;
      updateAdminUI();
    }

    // ===== TOGGLE MATCHES LOG =====
    function toggleMatchesLog(){
      const wrapper = $("matchesLogWrapper");
      const btn = $("toggleMatchesLogBtn");
      if(!wrapper || !btn) return;
      matchesLogVisible = !matchesLogVisible;
      wrapper.style.display = matchesLogVisible ? "" : "none";
      btn.textContent = matchesLogVisible ? "ğŸ‘ï¸ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø³Ø¬Ù„" : "ğŸ‘ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¬Ù„";
    }

    // ===== PLAYERS =====
    function getPlayerById(id){
      return state.players.find(p=>p.id===id) || null;
    }

    function getPlayerNameById(id){
      const p = getPlayerById(id);
      return p ? p.name : ("ID "+id);
    }

    function updatePlayersUI(){
      const players = state.players;
      const scoreSelectIds = ["winnerP1","winnerP2","loserP1","loserP2"];
      const singleSelectIds = ["playerDetailsSelect","h2hP1","h2hP2"];

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ select Ø¨ØªØ§Ø¹Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      scoreSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨...";
        sel.appendChild(opt);
        players.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });
      });

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù€ select Ø¨ØªØ§Ø¹Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„ ÙˆØ§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª
      singleSelectIds.forEach(id=>{
        const sel=$(id); if(!sel) return;
        sel.innerHTML="";
        const opt=document.createElement("option");
        opt.value=""; opt.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨...";
        sel.appendChild(opt);
        players.forEach(p=>{
          const o=document.createElement("option");
          o.value=p.id; o.textContent=p.name;
          sel.appendChild(o);
        });
      });

      // Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ù†ØµÙŠ ØªØ­Øª Ù‚Ø³Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†
      const info = $("playersListInfo");
      if(info){
        if(players.length===0){
          info.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†. Ø£Ø¶ÙÙ Ø¨Ø¹Ø¶ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.";
        } else {
          info.textContent="Ø§Ù„Ù„Ø§Ø¹Ø¨ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù‘Ù„ÙˆÙ†: " + players.map(p=>p.name).join("ØŒ ");
        }
      }

      // Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† (Ø¹Ø±Ø¶ + ØªØ¹Ø¯ÙŠÙ„)
      const tbody = $("playersTableBody");
      if(!tbody) return;
      tbody.innerHTML = "";

      if(players.length===0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = 3;
        td.textContent = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø­ØªÙ‰ Ø§Ù„Ø¢Ù†.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      players.forEach((p, idx)=>{
        const tr = document.createElement("tr");

        // Ø±Ù‚Ù…
        const tdIndex = document.createElement("td");
        tdIndex.textContent = idx + 1;
        tr.appendChild(tdIndex);

        // Ø§Ù„Ù„Ø§Ø¹Ø¨ (ØµÙˆØ±Ø© + Ø§Ø³Ù…)
        const tdPlayer = document.createElement("td");
        const wrapper = document.createElement("div");
        wrapper.className = "player-cell";
        if(p.avatar){
          const img = document.createElement("img");
          img.src = p.avatar;
          img.className = "player-avatar";
          wrapper.appendChild(img);
        }
        const span = document.createElement("span");
        span.textContent = p.name;
        wrapper.appendChild(span);
        tdPlayer.appendChild(wrapper);
        tr.appendChild(tdPlayer);

        // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª
        const tdActions = document.createElement("td");
        if(isAdmin){
          const editBtn = document.createElement("button");
          editBtn.textContent = "âœï¸ ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø§Ø³Ù…";
          editBtn.className = "btn-small";
          editBtn.addEventListener("click", ()=>editPlayerName(p.id, p.name));
          tdActions.appendChild(editBtn);

          const imgBtn = document.createElement("button");
          imgBtn.textContent = "ğŸ–¼ ØµÙˆØ±Ø©";
          imgBtn.className = "btn-small";
          imgBtn.style.marginRight = "4px";

          const fileInput = document.createElement("input");
          fileInput.type = "file";
          fileInput.accept = "image/*";
          fileInput.style.display = "none";
          fileInput.addEventListener("change", ()=>{
            const file = fileInput.files[0];
            if(file){
              changePlayerAvatar(p.id, file);
            }
            fileInput.value = "";
          });

          imgBtn.addEventListener("click", ()=>fileInput.click());

          tdActions.appendChild(imgBtn);
          tdActions.appendChild(fileInput);
        } else {
          tdActions.textContent = "-";
        }
        tr.appendChild(tdActions);

        tbody.appendChild(tr);
      });
    }

    function addPlayer(){
      if(!isAdmin || !db) return;
      const nameInput = $("playerName");
      const fileInput = $("playerAvatarFile");
      const name = nameInput.value.trim();
      if(!name){ alert("Ø§ÙƒØªØ¨ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨ Ø£ÙˆÙ„Ø§Ù‹."); return; }

      const finishAdd = (avatarData)=>{
        db.collection("players").add({
          name,
          avatar: avatarData || null
        }).then(()=>{
          nameInput.value="";
          fileInput.value="";
        }).catch(err=>{
          console.error(err);
          alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        });
      };

      const file = fileInput.files[0];
      if(file){
        const reader = new FileReader();
        reader.onload = e => finishAdd(e.target.result);
        reader.readAsDataURL(file);
      } else {
        finishAdd(null);
      }
    }

    function editPlayerName(playerId, currentName){
      if(!isAdmin || !db) return;
      const newName = prompt("Ø§ÙƒØªØ¨ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù„Ø§Ø¹Ø¨:", currentName || "");
      if(newName === null) return; // Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù„ØºÙ‰
      const trimmed = newName.trim();
      if(!trimmed){
        alert("Ø§Ù„Ø§Ø³Ù… Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙØ§Ø±Øº.");
        return;
      }
      db.collection("players").doc(playerId).update({ name: trimmed })
        .catch(err=>{
          console.error(err);
          alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ¹Ø¯ÙŠÙ„ Ø§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨.");
        });
    }

    function changePlayerAvatar(playerId, file){
      if(!isAdmin || !db || !file) return;
      const reader = new FileReader();
      reader.onload = e => {
        const avatarData = e.target.result;
        db.collection("players").doc(playerId).update({ avatar: avatarData })
          .catch(err=>{
            console.error(err);
            alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« ØµÙˆØ±Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨.");
          });
      };
      reader.readAsDataURL(file);
    }

    // ===== MATCHES =====
    function addMatch(){
      if(!isAdmin || !db) return;
      if(state.players.length<4){ alert("Ù„Ø§Ø²Ù… ÙŠÙƒÙˆÙ† ÙÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ 4 Ù„Ø§Ø¹Ø¨ÙŠÙ†."); return; }
      const w1=$("winnerP1").value;
      const w2=$("winnerP2").value;
      const l1=$("loserP1").value;
      const l2=$("loserP2").value;
      if(!w1||!w2||!l1||!l2){ alert("Ø§Ø®ØªØ± ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†."); return; }
      const chosen=[w1,w2,l1,l2];
      if(new Set(chosen).size<4){ alert("Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø£Ù† ÙŠÙƒÙˆÙ† ÙÙŠ Ø£ÙƒØ«Ø± Ù…Ù† Ù…ÙƒØ§Ù†."); return; }

      let dateStr=$("matchDate").value;
      if(!dateStr){
        const now=new Date();
        const y=now.getFullYear();
        const m=String(now.getMonth()+1).padStart(2,"0");
        const d=String(now.getDate()).padStart(2,"0");
        dateStr=`${y}-${m}-${d}`;
      }

      db.collection("matches").add({
        date: dateStr,
        winners:[w1,w2],
        losers:[l1,l2],
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      }).then(()=>{
        $("matchDate").value="";
        ["winnerP1","winnerP2","loserP1","loserP2"].forEach(id=>$(id).value="");
      }).catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…Ø§ØªØ´.");
      });
    }

    function undoLastMatch(){
      if(!isAdmin || !db) return;
      if(state.matches.length===0){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ØªØ´Ø§Øª."); return; }
      if(!confirm("Ù…ØªØ£ÙƒØ¯ ØªØ±Ø¬Ø¹ Ø¹Ù† Ø¢Ø®Ø± Ù…Ø§ØªØ´ØŸ")) return;

      // Ù†Ø­Ø¯Ù‘Ø¯ Ø¢Ø®Ø± Ù…Ø§ØªØ´ Ø¨Ø§Ù„Ù€ createdAt Ø£Ùˆ Ø¨Ø§Ù„Ù€ date
      const sorted = [...state.matches].sort((a,b)=>{
        const ta = a.createdAt && a.createdAt.seconds ? a.createdAt.seconds : 0;
        const tb = b.createdAt && b.createdAt.seconds ? b.createdAt.seconds : 0;
        if(tb!==ta) return tb-ta;
        return (b.date||"").localeCompare(a.date||"");
      });
      const last = sorted[0];
      if(!last){ alert("Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø§ØªØ´ Ù…Ù†Ø§Ø³Ø¨."); return; }

      db.collection("matches").doc(last.id).delete().catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø¢Ø®Ø± Ù…Ø§ØªØ´.");
      });
    }

    function resetAll(){
      if(!isAdmin || !db) return;
      if(!confirm("Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ù†ØªØ§Ø¦Ø¬ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ù…ØªØ£ÙƒØ¯ØŸ")) return;

      // Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      db.collection("matches").get().then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).then(()=>{
        return db.collection("players").get();
      }).then(snap=>{
        const batch = db.batch();
        snap.forEach(doc=>batch.delete(doc.ref));
        return batch.commit();
      }).catch(err=>{
        console.error(err);
        alert("Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ù…Ø³Ø­ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.");
      });
    }

    // ===== FILTER YEAR/MONTH =====
    function updateFilterYearOptions(){
      const sel = $("filterYear");
      if(!sel) return;
      const yearsSet = new Set();
      state.matches.forEach(m=>{
        if(m.date) yearsSet.add(m.date.slice(0,4));
      });
      const current = sel.value || "all";
      sel.innerHTML = "";
      const optAll = document.createElement("option");
      optAll.value="all"; optAll.textContent="ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª";
      sel.appendChild(optAll);
      Array.from(yearsSet).sort().forEach(y=>{
        const o=document.createElement("option");
        o.value=y; o.textContent=y;
        sel.appendChild(o);
      });
      if(current && (current==="all" || yearsSet.has(current))) sel.value=current;
      else sel.value="all";
    }

    function getFilterLabel(yearVal, monthVal){
      const monthNames = ["ÙŠÙ†Ø§ÙŠØ±","ÙØ¨Ø±Ø§ÙŠØ±","Ù…Ø§Ø±Ø³","Ø£Ø¨Ø±ÙŠÙ„","Ù…Ø§ÙŠÙˆ","ÙŠÙˆÙ†ÙŠÙˆ","ÙŠÙˆÙ„ÙŠÙˆ","Ø£ØºØ³Ø·Ø³","Ø³Ø¨ØªÙ…Ø¨Ø±","Ø£ÙƒØªÙˆØ¨Ø±","Ù†ÙˆÙÙ…Ø¨Ø±","Ø¯ÙŠØ³Ù…Ø¨Ø±"];
      if(yearVal !== "all" && monthVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: " + monthNames[Number(monthVal)-1] + " " + yearVal;
      } else if(yearVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: Ø³Ù†Ø© " + yearVal;
      } else if(monthVal !== "all"){
        return "Ø§Ù„ÙØªØ±Ø©: Ø´Ù‡Ø± " + monthNames[Number(monthVal)-1] + " ÙÙŠ ÙƒÙ„ Ø§Ù„Ø³Ù†ÙˆØ§Øª.";
      }
      return "Ø§Ù„ÙØªØ±Ø©: ÙƒÙ„ Ø§Ù„ÙˆÙ‚Øª.";
    }

    function getFilteredMatches(){
      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      let filtered = state.matches;

      if(yearVal !== "all"){
        const y = Number(yearVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(0,4)) === y);
        if(monthVal !== "all"){
          const mo = Number(monthVal);
          filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
        }
      } else if(monthVal !== "all"){
        const mo = Number(monthVal);
        filtered = filtered.filter(m => m.date && Number(m.date.slice(5,7)) === mo);
      }
      return filtered;
    }

    function createCell(text){
      const td=document.createElement("td");
      td.textContent=text;
      return td;
    }

    function createPlayerCellTd(playerId){
      const td=document.createElement("td");
      const p=getPlayerById(playerId);
      if(!p){ td.textContent="ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ"; return td; }
      const wrapper=document.createElement("div");
      wrapper.className="player-cell";
      if(p.avatar){
        const img=document.createElement("img");
        img.src=p.avatar;
        img.className="player-avatar";
        wrapper.appendChild(img);
      }
      const span=document.createElement("span");
      span.textContent=p.name;
      wrapper.appendChild(span);
      td.appendChild(wrapper);
      return td;
    }

    function createPlayersListCell(ids){
      const td=document.createElement("td");
      ids.forEach((id,idx)=>{
        if(idx>0) td.appendChild(document.createTextNode(" + "));
        const p=getPlayerById(id);
        const wrapper=document.createElement("span");
        wrapper.className="player-cell";
        if(p && p.avatar){
          const img=document.createElement("img");
          img.src=p.avatar;
          img.className="player-avatar";
          wrapper.appendChild(img);
        }
        const span=document.createElement("span");
        span.textContent=p ? p.name : ("ID "+id);
        wrapper.appendChild(span);
        td.appendChild(wrapper);
      });
      return td;
    }

    // ===== LEADERBOARD =====
    function updateLeaderboard(){
      const matches = getFilteredMatches();
      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      $("currentFilterLabel").textContent = getFilterLabel(yearVal, monthVal);

      const statsMap = new Map();

      function init(p){
        if(!statsMap.has(p)){
          statsMap.set(p,{
            id: p,
            wins: 0,
            losses: 0,
            w2: 0, w3: 0, w4: 0,
            l2: 0, l3: 0, l4: 0
          });
        }
      }

      // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù…Ù† ÙƒÙ„ Ø§Ù„Ù…Ø§ØªØ´Ø§Øª
      matches.forEach(m=>{
        const wCount = (m.winners || []).length;
        const lCount = (m.losers || []).length;

        (m.winners || []).forEach(pid=>{
          init(pid);
          const s = statsMap.get(pid);
          s.wins++;
          if(wCount === 2) s.w2++;
          else if(wCount === 3) s.w3++;
          else if(wCount === 4) s.w4++;
        });

        (m.losers || []).forEach(pid=>{
          init(pid);
          const s = statsMap.get(pid);
          s.losses++;
          if(lCount === 2) s.l2++;
          else if(lCount === 3) s.l3++;
          else if(lCount === 4) s.l4++;
        });
      });

      const rows = [];
      statsMap.forEach(s=>{
        const player = getPlayerById(s.id);
        const name = player ? player.name : ("ID " + s.id);
        const total = s.wins + s.losses;
        const points = s.wins - s.losses;
        const rate = total > 0 ? (s.wins / total) * 100 : 0;
        rows.push({
          id: s.id,
          name,
          wins: s.wins,
          losses: s.losses,
          matches: total,
          points,
          rate,
          w2: s.w2, w3: s.w3, w4: s.w4,
          l2: s.l2, l3: s.l3, l4: s.l4
        });
      });

      const cols = getLeaderboardColumns();

      // ØªØ±ØªÙŠØ¨ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
      applyLeaderboardSort(rows);

      // Ø±Ø£Ø³ Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const thead = $("leaderboardHead");
      thead.innerHTML = "";
      const headerTr = document.createElement("tr");
      cols.forEach(col=>{
        const th = document.createElement("th");
        th.textContent = col.label;
        th.classList.add("sortable");
        th.dataset.col = col.key;

        const arrow = document.createElement("span");
        arrow.className = "sort-arrow";
        if(leaderboardSort.column === col.key){
          arrow.textContent = leaderboardSort.direction === "asc" ? "â–²" : "â–¼";
        } else {
          arrow.textContent = "â†•";
        }

        th.appendChild(document.createTextNode(" "));
        th.appendChild(arrow);

        th.addEventListener("click", ()=>{
          if(leaderboardSort.column === col.key){
            leaderboardSort.direction = leaderboardSort.direction === "asc" ? "desc" : "asc";
          } else {
            leaderboardSort.column = col.key;
            leaderboardSort.direction = (col.key === "name") ? "asc" : "desc";
          }
          updateLeaderboard();
        });

        headerTr.appendChild(th);
      });
      thead.appendChild(headerTr);

      // Ø¬Ø³Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„
      const tbody = $("leaderboardBody");
      tbody.innerHTML = "";

      if(rows.length === 0){
        const tr = document.createElement("tr");
        const td = document.createElement("td");
        td.colSpan = cols.length;
        td.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØªØ§Ø¦Ø¬ Ø¨Ø¹Ø¯ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©.";
        tr.appendChild(td);
        tbody.appendChild(tr);
        return;
      }

      rows.forEach((r, idx)=>{
        const tr = document.createElement("tr");
        r.rank = idx + 1; // Ø±Ù‚Ù… Ø§Ù„ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ

        cols.forEach(col=>{
          if(col.key === "name"){
            // Ù†Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø§Ù„Ø®Ù„ÙŠØ© Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø§Ø³Ù…
            tr.appendChild(createPlayerCellTd(r.id));
          } else {
            let value;
            if(col.key === "rate"){
              value = r.rate.toFixed(1) + " Ùª";
            } else if(col.key === "rank"){
              value = r.rank;
            } else {
              value = r[col.key] ?? 0;
            }
            tr.appendChild(createCell(value));
          }
        });

        tbody.appendChild(tr);
      });
    }

    // ===== PLAYER ANALYSIS (Ø¨ÙØªØ±Ø© Ø§Ù„ÙÙ„ØªØ±) =====
    function computePlayerFullStats(playerId, matches){
      let wins=0,losses=0;
      const dayMap=new Map();
      const teammateWin=new Map(), teammateLose=new Map();

      matches.forEach(m=>{
        const d=m.date||"Ø¨Ø¯ÙˆÙ† ØªØ§Ø±ÙŠØ®";
        if(!dayMap.has(d)) dayMap.set(d,{w:0,l:0});
        const ds=dayMap.get(d);
        const isW=m.winners.includes(playerId);
        const isL=m.losers.includes(playerId);
        if(isW){
          wins++; ds.w++;
          m.winners.forEach(pid=>{
            if(pid!==playerId)
              teammateWin.set(pid,(teammateWin.get(pid)||0)+1);
          });
        }
        if(isL){
          losses++; ds.l++;
          m.losers.forEach(pid=>{
            if(pid!==playerId)
              teammateLose.set(pid,(teammateLose.get(pid)||0)+1);
          });
        }
      });

      const total=wins+losses;
      const rate=total>0?(wins/total)*100:0;
      let dW2=0,dW3=0,dW4=0,dL2=0,dL3=0,dL4=0;
      dayMap.forEach(ds=>{
        if(ds.w===2)dW2++; else if(ds.w===3)dW3++; else if(ds.w>=4)dW4++;
        if(ds.l===2)dL2++; else if(ds.l===3)dL3++; else if(ds.l>=4)dL4++;
      });

      function best(map){
        let bestId=null,bestCount=0;
        map.forEach((c,id)=>{if(c>bestCount){bestCount=c;bestId=id;}});
        if(!bestId) return null;
        const p=getPlayerById(bestId);
        return {id:bestId,name:p?p.name:"ID "+bestId,count:bestCount};
      }

      return {
        wins,losses,totalMatches:total,winRate:rate,
        daysWin2:dW2,daysWin3:dW3,daysWin4plus:dW4,
        daysLose2:dL2,daysLose3:dL3,daysLose4plus:dL4,
        bestTeammateWin:best(teammateWin),
        bestTeammateLose:best(teammateLose)
      };
    }

    function updatePlayerDetailsUI(){
      const sel=$("playerDetailsSelect");
      const summary=$("playerDetailsSummary");
      const box=$("playerDetailsStats");
      if(!sel || !sel.value){
        summary.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù„Ø¹Ø±Ø¶ ØªØ­Ù„ÙŠÙ„Ù‡.";
        box.style.display="none"; return;
      }
      const id=sel.value;
      const player=getPlayerById(id);
      if(!player){summary.textContent="Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø§Ø¹Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ù…Ø¹Ø±Ù.";box.style.display="none";return;}

      const matches = getFilteredMatches();
      const s=computePlayerFullStats(id, matches);

      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label = getFilterLabel(yearVal, monthVal);

      summary.innerHTML=`ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù„Ø§Ø¹Ø¨ <strong>${player.name}</strong> (${label})`;

      $("pTotalWins").textContent=s.wins;
      $("pTotalLosses").textContent=s.losses;
      $("pTotalMatches").textContent=s.totalMatches;
      $("pWinRate").textContent=s.winRate.toFixed(1)+"Ùª";

      $("pDaysWin2").textContent=s.daysWin2;
      $("pDaysWin3").textContent=s.daysWin3;
      $("pDaysWin4plus").textContent=s.daysWin4plus;
      $("pDaysLose2").textContent=s.daysLose2;
      $("pDaysLose3").textContent=s.daysLose3;
      $("pDaysLose4plus").textContent=s.daysLose4plus;

      if(s.bestTeammateWin){
        $("pBestMateWinName").textContent=s.bestTeammateWin.name;
        $("pBestMateWinCount").textContent=s.bestTeammateWin.count;
      }else{
        $("pBestMateWinName").textContent="-";
        $("pBestMateWinCount").textContent="0";
      }
      if(s.bestTeammateLose){
        $("pBestMateLoseName").textContent=s.bestTeammateLose.name;
        $("pBestMateLoseCount").textContent=s.bestTeammateLose.count;
      }else{
        $("pBestMateLoseName").textContent="-";
        $("pBestMateLoseCount").textContent="0";
      }

      box.style.display="block";
    }

    // ===== H2H (Ø¨ÙØªØ±Ø© Ø§Ù„ÙÙ„ØªØ±) =====
    function updateHeadToHeadUI(reset=true){
      if(reset) $("h2hSummary").textContent='Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø«Ù… Ø§Ø¶ØºØ· "ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø©".';
    }

    function analyzeHeadToHead(){
      const p1Str=$("h2hP1").value;
      const p2Str=$("h2hP2").value;
      const out=$("h2hSummary");
      if(!p1Str||!p2Str){out.textContent="Ø§Ø®ØªØ± Ù„Ø§Ø¹Ø¨ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹.";return;}
      const p1=p1Str,p2=p2Str;
      if(p1===p2){out.textContent="Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ù†ÙØ³ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø±ØªÙŠÙ†.";return;}
      const pl1=getPlayerById(p1),pl2=getPlayerById(p2);
      if(!pl1||!pl2){out.textContent="Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø£Ø­Ø¯ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†.";return;}

      const matches = getFilteredMatches();
      let vs=0,p1W=0,p2W=0,team=0;
      matches.forEach(m=>{
        const w=m.winners,l=m.losers;
        const p1Win=w.includes(p1),p1Lose=l.includes(p1);
        const p2Win=w.includes(p2),p2Lose=l.includes(p2);
        if((p1Win && p2Win)||(p1Lose && p2Lose)){team++;return;}
        if((p1Win&&p2Lose)||(p2Win&&p1Lose)){
          vs++;
          if(p1Win&&p2Lose)p1W++;
          if(p2Win&&p1Lose)p2W++;
        }
      });

      const yearVal = $("filterYear").value;
      const monthVal = $("filterMonth").value;
      const label = getFilterLabel(yearVal, monthVal);

      let html=`ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù…ÙˆØ§Ø¬Ù‡Ø§Øª Ø¨ÙŠÙ† <strong>${pl1.name}</strong> Ùˆ <strong>${pl2.name}</strong> (${label}):<br/><br/>`;
      html+=`â€¢ Ù„Ø¹Ø¨ÙˆØ§ Ø¶Ø¯ Ø¨Ø¹Ø¶ ÙÙŠ <strong>${vs}</strong> Ù…Ø§ØªØ´(Ø§Øª) Ø¹Ø´Ø±Ø©.<br/>`;
      html+=`â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${pl1.name}</strong> Ø¹Ù„Ù‰ ${pl2.name}: <strong>${p1W}</strong> Ù…Ø±Ø©.<br/>`;
      html+=`â€¢ Ù…Ø±Ø§Øª ÙØ§Ø² ÙÙŠÙ‡Ø§ <strong>${pl2.name}</strong> Ø¹Ù„Ù‰ ${pl1.name}: <strong>${p2W}</strong> Ù…Ø±Ø©.<br/>`;
      html+=`â€¢ Ù„Ø¹Ø¨ÙˆØ§ Ù…Ø¹Ù‹Ø§ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙØ±ÙŠÙ‚ ÙÙŠ <strong>${team}</strong> Ù…Ø§ØªØ´(Ø§Øª) Ø¹Ø´Ø±Ø©.<br/>`;
      if(vs>0){
        const r1=(p1W/vs)*100,r2=(p2W/vs)*100;
        html+=`<br/>Ù†Ø³Ø¨Ø© Ø§Ù„ÙÙˆØ² Ø¹Ù†Ø¯Ù…Ø§ ÙŠØªÙ‚Ø§Ø¨Ù„Ø§Ù† ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ÙØªØ±Ø©:<br/>`;
        html+=`â€¢ ${pl1.name}: <strong>${r1.toFixed(1)}Ùª</strong><br/>`;
        html+=`â€¢ ${pl2.name}: <strong>${r2.toFixed(1)}Ùª</strong><br/>`;
      }
      out.innerHTML=html;
    }

    // ===== INIT =====
    function init(){
      initFirebase();
      updateAdminUI();

      $("addPlayerBtn").addEventListener("click",addPlayer);
      $("addMatchBtn").addEventListener("click",addMatch);
      $("undoLastMatchBtn").addEventListener("click",undoLastMatch);
      $("resetAllBtn").addEventListener("click",resetAll);
      $("playerDetailsSelect").addEventListener("change",updatePlayerDetailsUI);
      $("h2hAnalyzeBtn").addEventListener("click",analyzeHeadToHead);
      $("enableAdminBtn").addEventListener("click",enableAdminMode);
      $("disableAdminBtn").addEventListener("click",disableAdminMode);
      $("filterYear").addEventListener("change",()=>{
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); else updateHeadToHeadUI(true);
      });
      $("filterMonth").addEventListener("change",()=>{
        updateLeaderboard();
        if($("playerDetailsSelect").value) updatePlayerDetailsUI();
        if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); else updateHeadToHeadUI(true);
      });
      const toggleViewBtn = $("leaderboardToggleViewBtn");
      if(toggleViewBtn){
        toggleViewBtn.addEventListener("click", ()=>{
          leaderboardViewMode = (leaderboardViewMode === "compact") ? "detailed" : "compact";
          toggleViewBtn.textContent = (leaderboardViewMode === "compact")
            ? "ğŸ“Š Ø¹Ø±Ø¶ ØªÙØµÙŠÙ„ÙŠ"
            : "ğŸ“‹ Ø¹Ø±Ø¶ Ù…Ø®ØªØµØ±";
          updateLeaderboard();
          if($("playerDetailsSelect").value) updatePlayerDetailsUI();
          if($("h2hP1").value && $("h2hP2").value) analyzeHeadToHead(); else updateHeadToHeadUI(true);
        });
      }

      $("toggleMatchesLogBtn").addEventListener("click", toggleMatchesLog);
    }

    document.addEventListener("DOMContentLoaded",init);
  </script>
</body>
</html>

